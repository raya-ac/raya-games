<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Royale - Enhanced with Epic Audio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(90deg, #0d1b2a 0%, #1b263b 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #415a77;
            box-shadow: 0 2px 20px rgba(65, 90, 119, 0.3);
        }
        
        .header h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3));
            animation: titlePulse 2s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3)); }
            50% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.6)); }
        }
        
        .back-btn {
            background: linear-gradient(135deg, #415a77, #778da9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(65, 90, 119, 0.3);
        }
        
        .back-btn:hover {
            background: linear-gradient(135deg, #778da9, #415a77);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(65, 90, 119, 0.5);
        }
        
        /* Main Game Area */
        .game-container {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        /* Canvas Container */
        .canvas-wrapper {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #0d1b2a 100%);
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Minimap */
        .minimap-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            background: rgba(13, 27, 42, 0.95);
            border: 2px solid #415a77;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(65, 90, 119, 0.2);
            transition: all 0.3s;
        }
        
        .minimap-container:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 212, 255, 0.3);
        }
        
        #minimap {
            width: 100%;
            height: 100%;
        }
        
        /* UI Overlay */
        .ui-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 320px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            pointer-events: none;
        }
        
        .ui-overlay > * {
            pointer-events: auto;
        }
        
        .panel {
            background: rgba(13, 27, 42, 0.95);
            border: 1px solid #415a77;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(65, 90, 119, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .panel:hover {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 30px rgba(0, 212, 255, 0.2);
        }
        
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel-title {
            font-size: 12px;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            background: linear-gradient(135deg, #1b263b, #415a77);
            color: #fff;
            border: 1px solid #778da9;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            background: linear-gradient(135deg, #415a77, #778da9);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(65, 90, 119, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.active {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Stats Panel */
        .stats-panel {
            min-width: 150px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }
        
        .stat-value {
            color: #00d4ff;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        /* Spectator Panel */
        .spectator-panel {
            min-width: 200px;
        }
        
        select {
            background: linear-gradient(135deg, #1b263b, #415a77);
            color: #fff;
            border: 1px solid #778da9;
            padding: 8px;
            border-radius: 8px;
            width: 100%;
            font-size: 13px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Kill Feed */
        .kill-feed {
            position: absolute;
            top: 20px;
            left: 20px;
            max-width: 320px;
            max-height: 200px;
            overflow: hidden;
        }
        
        .kill-entry {
            background: linear-gradient(135deg, rgba(13, 27, 42, 0.95), rgba(27, 38, 59, 0.9));
            border-left: 3px solid #00d4ff;
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 0 12px 12px 0;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .killer { color: #00d4ff; font-weight: bold; text-shadow: 0 0 8px rgba(0, 212, 255, 0.4); }
        .victim { color: #a0aec0; }
        .weapon { color: #fbbf24; font-weight: 600; }
        
        /* Kill Streak Announcement */
        .streak-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 20px currentColor;
            animation: streakPulse 1s ease-out;
            pointer-events: none;
            z-index: 100;
        }
        
        @keyframes streakPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        .streak-2 { color: #fbbf24; }
        .streak-3 { color: #f59e0b; }
        .streak-4 { color: #ec4899; }
        .streak-5 { color: #8b5cf6; }
        .streak-rampage { color: #00d4ff; }
        
        /* Winner Announcement */
        .winner-announce {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
            animation: winnerZoom 2s ease-out;
        }
        
        @keyframes winnerZoom {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .winner-text {
            font-size: 72px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px #ffd700, 0 0 60px #ff6b6b;
            text-transform: uppercase;
            letter-spacing: 8px;
            animation: winnerGlow 1.5s ease-in-out infinite;
        }
        
        @keyframes winnerGlow {
            0%, 100% { text-shadow: 0 0 30px #ffd700, 0 0 60px #ff6b6b; }
            50% { text-shadow: 0 0 50px #ffd700, 0 0 100px #ff6b6b, 0 0 150px #ffd700; }
        }
        
        .winner-subtext {
            font-size: 24px;
            color: #fff;
            margin-top: 10px;
        }
        
        /* Storm Warning */
        .storm-warning {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(123, 44, 191, 0.9), rgba(0, 212, 255, 0.8));
            color: #fff;
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            animation: stormPulse 1.5s infinite;
            display: none;
            box-shadow: 0 0 30px rgba(123, 44, 191, 0.5);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes stormPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(123, 44, 191, 0.5); transform: translateX(-50%) scale(1); }
            50% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.6), 0 0 60px rgba(123, 44, 191, 0.4); transform: translateX(-50%) scale(1.02); }
        }
        
        /* Volume Control */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            width: 100px;
            accent-color: #00d4ff;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(65, 90, 119, 0.5);
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        /* Replay Panel */
        .replay-panel {
            display: flex;
            gap: 10px;
        }
        
        /* Speed Lines Canvas (overlay) */
        #speedLinesCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Music toggle button */
        .music-btn {
            background: linear-gradient(135deg, #7b2cbf, #00d4ff);
            border-color: #00d4ff;
        }
        
        .music-btn:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        /* Keyboard hint */
        .keyboard-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(13, 27, 42, 0.9);
            border: 1px solid #415a77;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            color: #888;
            z-index: 100;
        }
        
        .keyboard-hint kbd {
            background: #1b263b;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #415a77;
            color: #00d4ff;
        }
        
        /* Muzzle flash effect */
        .muzzle-flash {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #ffaa00 0%, #ff0000 50%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: flashFade 0.1s ease-out;
        }
        
        @keyframes flashFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        
        /* Damage number popup */
        .damage-number {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: #ff4444;
            pointer-events: none;
            animation: damageFloat 0.8s ease-out;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
        }
        
        @keyframes damageFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öîÔ∏è Battle Royale</h1>
        <a href="/games" class="back-btn">üéÆ Games</a>
    </div>
    
    <div class="game-container">
        <div class="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            <canvas id="speedLinesCanvas"></canvas>
            
            <!-- Storm Warning -->
            <div class="storm-warning" id="stormWarning">‚ö†Ô∏è STORM CLOSING IN! ‚ö†Ô∏è</div>
            
            <!-- Kill Feed -->
            <div class="kill-feed" id="killFeed"></div>
            
            <!-- Streak Announcement Container -->
            <div id="streakContainer"></div>
            
            <!-- Winner Container -->
            <div id="winnerContainer"></div>
            
            <!-- Minimap -->
            <div class="minimap-container">
                <canvas id="minimap"></canvas>
            </div>
            
            <!-- UI Overlay -->
            <div class="ui-overlay">
                <div class="panel stats-panel">
                    <div class="panel-title">üìä Match Stats</div>
                    <div class="stat">
                        <span>Alive:</span>
                        <span class="stat-value" id="aliveCount">100</span>
                    </div>
                    <div class="stat">
                        <span>Eliminated:</span>
                        <span class="stat-value" id="eliminatedCount">0</span>
                    </div>
                    <div class="stat">
                        <span>Storm:</span>
                        <span class="stat-value" id="stormSize">100%</span>
                    </div>
                    <div class="stat">
                        <span>Time:</span>
                        <span class="stat-value" id="gameTime">0:00</span>
                    </div>
                </div>
                
                <div class="panel controls-panel">
                    <div class="panel-title">üéÆ Game Controls</div>
                    <div class="control-row">
                        <button id="btnStart" onclick="game.start()" title="Start (Space)">‚ñ∂Ô∏è Start</button>
                        <button id="btnPause" onclick="game.pause()" disabled title="Pause (P)">‚è∏Ô∏è Pause</button>
                        <button id="btnReset" onclick="game.reset()" title="Reset (R)">üîÑ Reset</button>
                    </div>
                    <div class="control-row">
                        <span>Speed:</span>
                        <button id="speed1x" class="active" onclick="game.setSpeed(1)">1x</button>
                        <button id="speed2x" onclick="game.setSpeed(2)">2x</button>
                        <button id="speed4x" onclick="game.setSpeed(4)">4x</button>
                    </div>
                    <div class="control-row volume-control">
                        <span>üéµ Music:</span>
                        <button id="btnMusic" class="music-btn" onclick="game.toggleMusic()" title="Toggle Music (M)">üîá Off</button>
                        <input type="range" id="volumeSlider" min="0" max="100" value="20" onchange="game.setVolume(this.value)">
                    </div>
                </div>
                
                <div class="panel spectator-panel">
                    <div class="panel-title">üëÅÔ∏è Spectator Mode</div>
                    <div class="control-row">
                        <select id="spectatorSelect" onchange="game.setSpectatorTarget(this.value)">
                            <option value="auto">üé≤ Auto (Random)</option>
                            <option value="leader">üèÜ Leader</option>
                            <option value="action">‚öîÔ∏è Most Action</option>
                        </select>
                    </div>
                    <div class="control-row" style="margin-top:10px;">
                        <span>Following: <span id="spectatingName" class="stat-value">Auto</span></span>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-title">üíæ Replay</div>
                    <div class="control-row replay-panel">
                        <button onclick="game.saveReplay()">üíæ Save</button>
                        <button onclick="document.getElementById('replayInput').click()">üìÇ Load</button>
                        <input type="file" id="replayInput" style="display:none" accept=".json" onchange="game.loadReplay(this)">
                    </div>
                </div>
            </div>
            
            <!-- Keyboard hint -->
            <div class="keyboard-hint">
                <strong>‚å®Ô∏è Shortcuts:</strong><br>
                <kbd>Space</kbd> Start/Pause<br>
                <kbd>M</kbd> Toggle Music<br>
                <kbd>1-4</kbd> Speed<br>
                <kbd>R</kbd> Reset
            </div>
        </div>
    </div>

    <script>
        // ==================== INTENSE BATTLE ROYALE AUDIO SYSTEM ====================
        class BattleAudio {
            constructor() {
                this.ctx = null;
                this.master = null;
                this.isPlaying = false;
                this.beatCount = 0;
                this.nextBeat = 0;
                this.bpm = 140; // Fast, intense tempo
                this.rafId = null;
                this.volume = 0.2;
                this.loopPhase = 0;
            }
            
            init() {
                if (this.ctx) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.master = this.ctx.createGain();
                const comp = this.ctx.createDynamicsCompressor();
                comp.threshold.value = -18; comp.ratio.value = 6;
                this.master.connect(comp);
                comp.connect(this.ctx.destination);
                this.master.gain.value = this.volume;
            }
            
            note(freq, dur, type='sawtooth', vol=0.3, t=0) {
                const now = this.ctx.currentTime + t;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                const f = this.ctx.createBiquadFilter();
                o.type = type; o.frequency.value = freq;
                f.type = 'lowpass'; f.frequency.value = 800; f.Q.value = 2;
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(vol, now + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, now + dur);
                o.connect(f); f.connect(g); g.connect(this.master);
                o.start(now); o.stop(now + dur);
            }
            
            kick(t=0) {
                const now = this.ctx.currentTime + t;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.frequency.setValueAtTime(200, now);
                o.frequency.exponentialRampToValueAtTime(40, now + 0.15);
                g.gain.setValueAtTime(0.9, now);
                g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                o.connect(g); g.connect(this.master);
                o.start(now); o.stop(now + 0.3);
            }
            
            snare(t=0) {
                const now = this.ctx.currentTime + t;
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate*0.2, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i=0; i<d.length; i++) d[i] = (Math.random()*2-1)*Math.pow(1-i/d.length, 2);
                const src = this.ctx.createBufferSource();
                src.buffer = buf;
                const g = this.ctx.createGain();
                const f = this.ctx.createBiquadFilter();
                f.type='bandpass'; f.frequency.value=1500; f.Q.value=0.5;
                g.gain.setValueAtTime(0.5, now);
                g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
                src.connect(f); f.connect(g); g.connect(this.master);
                src.start(now);
                // Tone body
                const o = this.ctx.createOscillator(); o.frequency.value=180;
                const g2 = this.ctx.createGain();
                g2.gain.setValueAtTime(0.3, now);
                g2.gain.exponentialRampToValueAtTime(0.001, now+0.1);
                o.connect(g2); g2.connect(this.master); o.start(now); o.stop(now+0.1);
            }
            
            hihat(t=0, closed=true) {
                const now = this.ctx.currentTime + t;
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate*0.05, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=8000;
                const g = this.ctx.createGain();
                g.gain.setValueAtTime(closed?0.2:0.4, now);
                g.gain.exponentialRampToValueAtTime(0.001, now+(closed?0.05:0.15));
                src.connect(f); f.connect(g); g.connect(this.master); src.start(now);
            }
            
            bass(freq, dur, t=0) {
                const now = this.ctx.currentTime + t;
                const o = this.ctx.createOscillator(); o.type='square'; o.frequency.value=freq;
                const f = this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=200; f.Q.value=4;
                const g = this.ctx.createGain();
                g.gain.setValueAtTime(0.5, now);
                g.gain.exponentialRampToValueAtTime(0.001, now+dur);
                o.connect(f); f.connect(g); g.connect(this.master);
                o.start(now); o.stop(now+dur);
            }
            
            playBeat(beat) {
                const b = beat % 16;
                const Q = 60 / this.bpm / 4; // 16th note duration
                
                // Kick on 0, 4, 8, 12 (quarter notes)
                if (b%4===0) this.kick();
                // Extra kick for drive
                if (b===10 || b===14) this.kick();
                // Snare on 4 and 12 (beats 2 & 4)
                if (b===4 || b===12) this.snare();
                // Hihats every 16th, open on offbeats
                this.hihat(0, b%4!==2);
                
                // Bass line (minor pentatonic riff - intense)
                const bassNotes = [55,55,82.41,55,73.42,55,87.31,65.41,55,55,73.42,55,82.41,55,55,73.42];
                this.bass(bassNotes[b], Q*1.8);
                
                // Synth stab melody every 8 beats
                const stabFreqs = [220,261.63,329.63,261.63,220,196,246.94,220];
                if (b%2===0 && beat>16) {
                    const phase = (Math.floor(beat/2)) % stabFreqs.length;
                    this.note(stabFreqs[phase], Q*3.5, 'sawtooth', 0.15);
                }
                
                // Tension chord every 4 bars
                if (beat % 64 === 0 && beat > 0) {
                    [110, 138.59, 164.81, 220].forEach((f,i) => {
                        this.note(f, 2, 'triangle', 0.08, i*0.05);
                    });
                }
            }
            
            scheduler() {
                if (!this.isPlaying) return;
                const lookAhead = 0.1;
                while (this.nextBeat < this.ctx.currentTime + lookAhead) {
                    this.playBeat(this.beatCount);
                    this.nextBeat += 60 / this.bpm / 4;
                    this.beatCount++;
                }
                this.rafId = requestAnimationFrame(() => this.scheduler());
            }
            
            // Sound effects
            gunshot(weapon='pistol') {
                if (!this.ctx || !this.isPlaying) return;
                const now = this.ctx.currentTime;
                const configs = {
                    pistol: {freq:1200, dur:0.15, vol:0.35},
                    smg:    {freq:1800, dur:0.08, vol:0.25},
                    rifle:  {freq:900, dur:0.25, vol:0.4},
                    shotgun:{freq:800, dur:0.35, vol:0.6},
                    sniper: {freq:700, dur:0.4, vol:0.5}
                };
                const c = configs[weapon] || configs.pistol;
                // Noise burst
                const bufSize = this.ctx.sampleRate * c.dur;
                const buf = this.ctx.createBuffer(1, bufSize, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i=0; i<bufSize; i++) d[i] = (Math.random()*2-1)*Math.pow(1-i/bufSize,0.5);
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=c.freq; f.Q.value=0.5;
                const g = this.ctx.createGain(); g.gain.value = c.vol;
                src.connect(f); f.connect(g); g.connect(this.master); src.start(now);
            }
            
            explosion(vol=0.8) {
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                const dur = 0.8;
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate*dur, this.ctx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i=0; i<d.length; i++) d[i] = (Math.random()*2-1)*Math.pow(1-i/d.length, 0.3);
                const src = this.ctx.createBufferSource(); src.buffer = buf;
                const f = this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=400;
                const g = this.ctx.createGain(); g.gain.setValueAtTime(vol, now); g.gain.exponentialRampToValueAtTime(0.001, now+dur);
                src.connect(f); f.connect(g); g.connect(this.master); src.start(now);
                // Low boom
                const o = this.ctx.createOscillator(); o.frequency.setValueAtTime(80, now); o.frequency.exponentialRampToValueAtTime(20, now+0.5);
                const g2 = this.ctx.createGain(); g2.gain.setValueAtTime(0.7, now); g2.gain.exponentialRampToValueAtTime(0.001, now+0.5);
                o.connect(g2); g2.connect(this.master); o.start(now); o.stop(now+0.5);
            }
            
            victoryJingle() {
                if (!this.ctx) return;
                [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50].forEach((f,i) => {
                    this.note(f, 0.4, 'triangle', 0.4, i*0.25);
                });
            }
            
            start() {
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.isPlaying = true;
                this.nextBeat = this.ctx.currentTime;
                this.beatCount = 0;
                this.scheduler();
            }
            
            stop() {
                this.isPlaying = false;
                if (this.rafId) cancelAnimationFrame(this.rafId);
            }
            
            setVolume(v) {
                this.volume = v/100;
                if (this.master) this.master.gain.value = this.volume;
            }
        }
        
        // ==================== GAME CLASSES ====================
        class Vector {
            constructor(x,y){this.x=x;this.y=y;}
            add(v){return new Vector(this.x+v.x,this.y+v.y);}
            sub(v){return new Vector(this.x-v.x,this.y-v.y);}
            mult(n){return new Vector(this.x*n,this.y*n);}
            mag(){return Math.sqrt(this.x*this.x+this.y*this.y);}
            normalize(){const m=this.mag();return m>0?new Vector(this.x/m,this.y/m):new Vector(0,0);}
            dist(v){return Math.sqrt((this.x-v.x)**2+(this.y-v.y)**2);}
            clone(){return new Vector(this.x,this.y);}
        }
        
        class Particle {
            constructor(x,y,color,speed,life){
                this.pos=new Vector(x,y);
                const angle=Math.random()*Math.PI*2;
                this.vel=new Vector(Math.cos(angle)*speed,Math.sin(angle)*speed);
                this.color=color; this.life=life; this.maxLife=life;
                this.size=Math.random()*4+2;
            }
            update(){this.pos=this.pos.add(this.vel);this.vel=this.vel.mult(0.96);this.life--;this.size*=0.97;}
            draw(ctx){
                const a=this.life/this.maxLife;
                ctx.globalAlpha=a;
                ctx.shadowColor=this.color; ctx.shadowBlur=8*a;
                ctx.fillStyle=this.color;
                ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.size,0,Math.PI*2);ctx.fill();
                ctx.shadowBlur=0; ctx.globalAlpha=1;
            }
        }
        
        class Weapon {
            constructor(type){
                this.type=type; this.cooldown=0;
                const W={pistol:{cd:20,dmg:15,range:150,color:'#94a3b8',glow:'#cbd5e1'},
                         smg:{cd:5,dmg:8,range:200,color:'#22d3ee',glow:'#67e8f9'},
                         rifle:{cd:10,dmg:25,range:350,color:'#a855f7',glow:'#c084fc'},
                         shotgun:{cd:40,dmg:50,range:100,color:'#fbbf24',glow:'#fcd34d'},
                         sniper:{cd:60,dmg:100,range:500,color:'#f472b6',glow:'#f9a8d4'}};
                const w=W[type]||W.pistol;
                this.maxCooldown=w.cd; this.damage=w.dmg; this.range=w.range;
                this.color=w.color; this.glowColor=w.glow;
            }
            canFire(){return this.cooldown<=0;}
            fire(){this.cooldown=this.maxCooldown;}
            update(){if(this.cooldown>0)this.cooldown--;}
        }
        
        class Player {
            constructor(id,x,y,name){
                this.id=id; this.pos=new Vector(x,y); this.vel=new Vector(0,0);
                this.name=name; this.hp=100; this.maxHp=100; this.speed=2.5; this.radius=8;
                this.weapon=new Weapon('pistol'); this.kills=0; this.streak=0; this.alive=true;
                const h=[180,190,200,220,240,260,280,300,320,340][id%10];
                this.color=`hsl(${h},75%,55%)`; this.gradientStart=`hsl(${h},85%,65%)`;
                this.gradientEnd=`hsl(${h},65%,40%)`;
                this.target=null; this.moveTarget=null; this.changeDirTimer=0;
                this.lastAttacker=null; this.speedLineTimer=0;
            }
            update(game){
                if(!this.alive)return;
                this.weapon.update();
                this.ai(game);
                if(this.vel.mag()>0){this.pos=this.pos.add(this.vel); this.speedLineTimer=5;}
                this.pos.x=Math.max(this.radius,Math.min(game.mapSize-this.radius,this.pos.x));
                this.pos.y=Math.max(this.radius,Math.min(game.mapSize-this.radius,this.pos.y));
                const d=this.pos.dist(game.stormCenter);
                if(d>game.stormRadius){this.hp-=0.08;} // Storm damage per frame
                if(this.hp<=0) this.die(game);
                if(this.speedLineTimer>0)this.speedLineTimer--;
            }
            ai(game){
                let nearest=null, nearestD=Infinity, nearestLoot=null;
                for(const p of game.players){
                    if(p!==this&&p.alive){const d=this.pos.dist(p.pos);if(d<nearestD){nearestD=d;nearest=p;}}
                }
                for(const l of game.loot){
                    if(this.pos.dist(l.pos)<100&&this.weapon.type==='pistol') nearestLoot=l;
                }
                if(nearestLoot&&this.weapon.type==='pistol'){
                    this.vel=nearestLoot.pos.sub(this.pos).normalize().mult(this.speed);
                } else if(nearest&&nearestD<this.weapon.range){
                    if(this.weapon.canFire()) this.fireAt(nearest,game);
                    if(nearestD<50) this.vel=this.pos.sub(nearest.pos).normalize().mult(this.speed*0.8);
                    else this.vel=new Vector(0,0);
                } else {
                    this.changeDirTimer--;
                    if(this.changeDirTimer<=0||!this.moveTarget){
                        this.changeDirTimer=Math.random()*60+30;
                        const cd=game.stormCenter.sub(this.pos).normalize();
                        const rd=new Vector(Math.random()-0.5,Math.random()-0.5).normalize();
                        this.moveTarget=this.pos.add(cd.mult(0.7).add(rd.mult(0.3)).normalize().mult(100));
                    }
                    this.vel=this.moveTarget.sub(this.pos).normalize().mult(this.speed);
                }
                const d=this.pos.dist(game.stormCenter);
                if(d>game.stormRadius*0.85) this.vel=game.stormCenter.sub(this.pos).normalize().mult(this.speed*1.8);
            }
            fireAt(target,game){
                if(!this.weapon.canFire())return;
                this.weapon.fire();
                const dist=this.pos.dist(target.pos);
                const acc=Math.max(0.3,1-dist/this.weapon.range);
                if(Math.random()<acc){
                    target.hp-=this.weapon.damage;
                    target.lastAttacker=this;
                    game.addHitEffect(target.pos.x,target.pos.y);
                    // Play gunshot effect
                    if(game.audio.isPlaying) game.audio.gunshot(this.weapon.type);
                    if(target.hp<=0&&target.alive){
                        this.streak++; this.kills++;
                        game.recordKill(this,target,this.weapon.type);
                        game.checkStreak(this);
                    }
                }
            }
            die(game){
                if(!this.alive)return;
                this.alive=false;
                game.addDeathParticles(this.pos.x,this.pos.y,this.color);
                game.screenShake=12;
                if(game.audio.isPlaying) game.audio.explosion(0.5);
                if(this.weapon.type!=='pistol'&&Math.random()<0.5)
                    game.loot.push({pos:this.pos.clone(),type:this.weapon.type});
            }
            draw(ctx){
                if(!this.alive)return;
                if(this.speedLineTimer>0){
                    ctx.strokeStyle='rgba(0,212,255,0.25)'; ctx.lineWidth=1.5;
                    const td=this.vel.normalize().mult(-1);
                    for(let i=1;i<=3;i++){
                        ctx.beginPath(); ctx.moveTo(this.pos.x,this.pos.y);
                        ctx.lineTo(this.pos.x+td.x*i*8,this.pos.y+td.y*i*8); ctx.stroke();
                    }
                }
                ctx.shadowColor=this.weapon.glowColor; ctx.shadowBlur=18;
                const grad=ctx.createRadialGradient(this.pos.x-3,this.pos.y-3,0,this.pos.x,this.pos.y,this.radius);
                grad.addColorStop(0,this.gradientStart); grad.addColorStop(1,this.gradientEnd);
                ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(this.pos.x,this.pos.y,this.radius,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0;
                ctx.fillStyle='rgba(255,255,255,0.2)'; ctx.beginPath();
                ctx.arc(this.pos.x-2,this.pos.y-2,this.radius*0.4,0,Math.PI*2); ctx.fill();
                ctx.shadowColor=this.weapon.glowColor; ctx.shadowBlur=10;
                ctx.fillStyle=this.weapon.color; ctx.beginPath();
                ctx.arc(this.pos.x,this.pos.y,this.radius*0.5,0,Math.PI*2); ctx.fill();
                ctx.shadowBlur=0;
                const hp=this.hp/this.maxHp;
                ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(this.pos.x-16,this.pos.y-22,32,5);
                const hg=ctx.createLinearGradient(this.pos.x-16,0,this.pos.x+16,0);
                if(hp>0.5){hg.addColorStop(0,'#00d4ff');hg.addColorStop(1,'#7b2cbf');}
                else if(hp>0.25){hg.addColorStop(0,'#fbbf24');hg.addColorStop(1,'#f59e0b');}
                else{hg.addColorStop(0,'#ef4444');hg.addColorStop(1,'#dc2626');}
                ctx.fillStyle=hg; ctx.fillRect(this.pos.x-15,this.pos.y-21,30*hp,3);
                ctx.shadowColor='rgba(0,0,0,0.8)'; ctx.shadowBlur=4;
                ctx.fillStyle='#e2e8f0'; ctx.font='bold 10px Segoe UI'; ctx.textAlign='center';
                ctx.fillText(this.name,this.pos.x,this.pos.y+26); ctx.shadowBlur=0;
            }
        }
        
        // ==================== MAIN GAME CLASS ====================
        class BattleRoyale {
            constructor(){
                this.canvas=document.getElementById('gameCanvas');
                this.ctx=this.canvas.getContext('2d');
                this.speedCanvas=document.getElementById('speedLinesCanvas');
                this.speedCtx=this.speedCanvas.getContext('2d');
                this.minimap=document.getElementById('minimap');
                this.minimapCtx=this.minimap.getContext('2d');
                this.audio=new BattleAudio();
                this.resize();
                window.addEventListener('resize',()=>this.resize());
                this.mapSize=2000;
                this.players=[]; this.particles=[]; this.loot=[]; this.killFeed=[];
                this.replayData=[];
                this.stormCenter=new Vector(this.mapSize/2,this.mapSize/2);
                this.stormRadius=900; this.stormShrinkRate=0.06; this.minStormRadius=50;
                this.camera={x:0,y:0}; this.screenShake=0; this.gameSpeed=1;
                this.running=false; this.gameTime=0; this.winner=null; this.gameEnded=false;
                this.spectatorMode='auto'; this.spectatorTarget=null;
                this.winnerSlowMo=false; this.slowMoTimer=0;
                this.generateLoot();
                this.setupKeyboard();
            }
            resize(){
                const p=this.canvas.parentElement;
                this.canvas.width=p.clientWidth; this.canvas.height=p.clientHeight;
                this.speedCanvas.width=p.clientWidth; this.speedCanvas.height=p.clientHeight;
                this.minimap.width=200; this.minimap.height=200;
            }
            setupKeyboard(){
                document.addEventListener('keydown',(e)=>{
                    switch(e.code){
                        case 'Space': e.preventDefault();
                            if(!this.running&&!this.gameEnded) this.start();
                            else this.pause(); break;
                        case 'KeyM': e.preventDefault(); this.toggleMusic(); break;
                        case 'KeyR': e.preventDefault(); this.reset(); break;
                        case 'Digit1': this.setSpeed(1); break;
                        case 'Digit2': this.setSpeed(2); break;
                        case 'Digit3': this.setSpeed(4); break;
                    }
                });
            }
            generateLoot(){
                const types=['smg','smg','rifle','rifle','shotgun','shotgun','sniper'];
                for(let i=0;i<30;i++) this.loot.push({pos:new Vector(Math.random()*this.mapSize,Math.random()*this.mapSize),type:types[Math.floor(Math.random()*types.length)]});
            }
            reset(){
                this.running=false; this.gameEnded=false; this.winner=null;
                this.gameTime=0; this.players=[]; this.particles=[]; this.loot=[];
                this.killFeed=[]; this.replayData=[];
                this.stormCenter=new Vector(this.mapSize/2,this.mapSize/2);
                this.stormRadius=900; this.winnerSlowMo=false; this.slowMoTimer=0;
                const names=this.generateNames();
                for(let i=0;i<100;i++){
                    const a=Math.random()*Math.PI*2, d=Math.random()*(this.stormRadius*0.8);
                    this.players.push(new Player(i,this.stormCenter.x+Math.cos(a)*d,this.stormCenter.y+Math.sin(a)*d,names[i]));
                }
                this.generateLoot(); this.updateUI(); this.draw();
                document.getElementById('btnStart').disabled=false;
                document.getElementById('btnPause').disabled=true;
                document.getElementById('winnerContainer').innerHTML='';
            }
            generateNames(){
                const A=['Swift','Deadly','Silent','Fierce','Shadow','Phantom','Rogue','Viper','Storm','Blaze'];
                const N=['Ninja','Hunter','Wolf','Eagle','Tiger','Dragon','Snake','Ghost','Reaper','Striker'];
                const names=[];
                for(let i=0;i<100;i++) names.push(`${A[i%10]}${N[Math.floor(i/10)]}${i>9?i:''}`);
                return names;
            }
            start(){
                if(this.players.length===0) this.reset();
                this.running=true;
                document.getElementById('btnStart').disabled=true;
                document.getElementById('btnPause').disabled=false;
                this.loop();
            }
            pause(){
                this.running=!this.running;
                document.getElementById('btnPause').textContent=this.running?'‚è∏Ô∏è Pause':'‚ñ∂Ô∏è Resume';
                if(this.running) this.loop();
            }
            setSpeed(s){
                this.gameSpeed=s;
                document.querySelectorAll('[id^="speed"]').forEach(b=>b.classList.remove('active'));
                document.getElementById(`speed${s}x`).classList.add('active');
            }
            toggleMusic(){
                const btn=document.getElementById('btnMusic');
                if(this.audio.isPlaying){
                    this.audio.stop(); btn.textContent='üîá Off'; btn.classList.remove('active');
                } else {
                    this.audio.start(); btn.textContent='üîä On'; btn.classList.add('active');
                }
            }
            setVolume(v){this.audio.setVolume(v);}
            setSpectatorTarget(t){
                this.spectatorMode=t;
                if(t==='auto'){this.spectatorTarget=null;document.getElementById('spectatingName').textContent='Auto';}
            }
            updateSpectator(){
                const alive=this.players.filter(p=>p.alive);
                if(alive.length===0)return;
                if(this.spectatorMode==='auto'){
                    if(!this.spectatorTarget||!this.spectatorTarget.alive||Math.random()<0.015)
                        this.spectatorTarget=alive[Math.floor(Math.random()*alive.length)];
                } else if(this.spectatorMode==='leader'){
                    this.spectatorTarget=alive.reduce((a,b)=>a.kills>b.kills?a:b);
                } else {
                    const fighting=alive.filter(p=>p.weapon.cooldown>p.weapon.maxCooldown*0.5);
                    this.spectatorTarget=fighting.length>0?fighting[Math.floor(Math.random()*fighting.length)]:alive[Math.floor(Math.random()*alive.length)];
                }
                if(this.spectatorTarget) document.getElementById('spectatingName').textContent=this.spectatorTarget.name;
            }
            updateCamera(){
                this.updateSpectator();
                let tx,ty;
                if(this.spectatorTarget&&this.spectatorTarget.alive){
                    tx=this.spectatorTarget.pos.x-this.canvas.width/2;
                    ty=this.spectatorTarget.pos.y-this.canvas.height/2;
                } else {
                    tx=this.stormCenter.x-this.canvas.width/2;
                    ty=this.stormCenter.y-this.canvas.height/2;
                }
                this.camera.x+=(tx-this.camera.x)*0.1;
                this.camera.y+=(ty-this.camera.y)*0.1;
                if(this.screenShake>0){
                    this.camera.x+=(Math.random()-0.5)*this.screenShake;
                    this.camera.y+=(Math.random()-0.5)*this.screenShake;
                    this.screenShake*=0.85; if(this.screenShake<0.5)this.screenShake=0;
                }
            }
            update(){
                if(this.gameEnded)return;
                let dt=this.gameSpeed;
                if(this.winnerSlowMo)dt*=0.2;
                this.gameTime+=dt/60;
                if(this.stormRadius>this.minStormRadius){
                    this.stormRadius-=this.stormShrinkRate*dt;
                    this.stormCenter.x+=(Math.random()-0.5)*1.5*dt;
                    this.stormCenter.y+=(Math.random()-0.5)*1.5*dt;
                    this.stormCenter.x=Math.max(200,Math.min(this.mapSize-200,this.stormCenter.x));
                    this.stormCenter.y=Math.max(200,Math.min(this.mapSize-200,this.stormCenter.y));
                }
                for(const p of this.players) p.update(this);
                for(let i=this.particles.length-1;i>=0;i--){
                    this.particles[i].update();
                    if(this.particles[i].life<=0) this.particles.splice(i,1);
                }
                for(const p of this.players){
                    if(!p.alive)continue;
                    for(let i=this.loot.length-1;i>=0;i--){
                        if(p.pos.dist(this.loot[i].pos)<20){
                            p.weapon=new Weapon(this.loot[i].type); this.loot.splice(i,1);
                        }
                    }
                }
                const alive=this.players.filter(p=>p.alive);
                if(alive.length===1&&!this.winner){this.winner=alive[0];this.triggerWin();}
                if(this.winnerSlowMo){this.slowMoTimer-=dt;if(this.slowMoTimer<=0){this.winnerSlowMo=false;this.gameEnded=true;this.running=false;this.showWinner();}}
                this.updateCamera(); this.updateUI();
                document.getElementById('stormWarning').style.display=this.stormRadius<300?'block':'none';
            }
            triggerWin(){
                this.winnerSlowMo=true; this.slowMoTimer=80; this.screenShake=25;
                for(let i=0;i<60;i++) this.addDeathParticles(this.winner.pos.x,this.winner.pos.y,'#ffd700',10);
                if(this.audio.isPlaying) this.audio.victoryJingle();
            }
            showWinner(){
                document.getElementById('winnerContainer').innerHTML=`
                    <div class="winner-announce">
                        <div class="winner-text">üèÜ ${this.winner.name} WINS! üèÜ</div>
                        <div class="winner-subtext">${this.winner.kills} Kills ‚Ä¢ Victory Royale!</div>
                    </div>`;
                document.getElementById('btnStart').disabled=false;
                document.getElementById('btnPause').disabled=true;
            }
            checkStreak(k){
                const streaks=[{c:2,t:'DOUBLE KILL!',s:'streak-2'},{c:3,t:'TRIPLE KILL!',s:'streak-3'},{c:4,t:'QUADRA KILL!',s:'streak-4'},{c:5,t:'PENTAKILL!',s:'streak-5'}];
                for(const s of streaks) if(k.streak===s.c){this.showStreak(s.t,s.s);return;}
                if(k.streak>=6) this.showStreak('üî• RAMPAGE! üî•','streak-rampage');
            }
            showStreak(text,cls){
                const c=document.getElementById('streakContainer');
                const el=document.createElement('div');
                el.className=`streak-announce ${cls}`; el.textContent=text;
                c.appendChild(el); setTimeout(()=>el.remove(),1000);
            }
            recordKill(killer,victim,weapon){
                this.killFeed.unshift({killer:killer.name,victim:victim.name,weapon});
                if(this.killFeed.length>5)this.killFeed.pop();
                this.updateKillFeed();
            }
            updateKillFeed(){
                const c=document.getElementById('killFeed');
                c.innerHTML=this.killFeed.map(k=>`<div class="kill-entry"><span class="killer">${k.killer}</span> <span class="weapon">[${k.weapon.toUpperCase()}]</span> <span class="victim">${k.victim}</span></div>`).join('');
            }
            addDeathParticles(x,y,color,speed=5){for(let i=0;i<20;i++)this.particles.push(new Particle(x,y,color,speed,50));}
            addHitEffect(x,y){for(let i=0;i<6;i++)this.particles.push(new Particle(x,y,'#00d4ff',4,20));}
            saveReplay(){
                const blob=new Blob([JSON.stringify({v:1,frames:this.replayData})],{type:'application/json'});
                const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`replay_${Date.now()}.json`;a.click();
            }
            loadReplay(inp){alert('Replay viewer coming soon!');inp.value='';}
            updateUI(){
                const alive=this.players.filter(p=>p.alive).length;
                document.getElementById('aliveCount').textContent=alive;
                document.getElementById('eliminatedCount').textContent=this.players.length-alive;
                document.getElementById('stormSize').textContent=Math.round(this.stormRadius/9)+'%';
                const m=Math.floor(this.gameTime/60),s=Math.floor(this.gameTime%60);
                document.getElementById('gameTime').textContent=`${m}:${s.toString().padStart(2,'0')}`;
            }
            draw(){
                this.ctx.fillStyle='#0d1b2a';
                this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
                this.speedCtx.clearRect(0,0,this.speedCanvas.width,this.speedCanvas.height);
                this.ctx.save();
                this.ctx.translate(-this.camera.x,-this.camera.y);
                this.drawGrid();
                this.drawStorm();
                this.drawLoot();
                for(const p of this.particles) p.draw(this.ctx);
                for(const p of this.players) p.draw(this.ctx);
                this.ctx.restore();
                this.drawSpeedLines();
                this.drawMinimap();
            }
            drawGrid(){
                const bg=this.ctx.createRadialGradient(this.mapSize/2,this.mapSize/2,0,this.mapSize/2,this.mapSize/2,this.mapSize);
                bg.addColorStop(0,'#1b263b'); bg.addColorStop(1,'#0d1b2a');
                this.ctx.fillStyle=bg; this.ctx.fillRect(0,0,this.mapSize,this.mapSize);
                this.ctx.strokeStyle='rgba(65,90,119,0.12)'; this.ctx.lineWidth=1;
                for(let x=0;x<=this.mapSize;x+=200){this.ctx.beginPath();this.ctx.moveTo(x,0);this.ctx.lineTo(x,this.mapSize);this.ctx.stroke();}
                for(let y=0;y<=this.mapSize;y+=200){this.ctx.beginPath();this.ctx.moveTo(0,y);this.ctx.lineTo(this.mapSize,y);this.ctx.stroke();}
            }
            drawStorm(){
                // Full map danger overlay
                this.ctx.fillStyle='rgba(123,44,191,0.12)';
                this.ctx.fillRect(0,0,this.mapSize,this.mapSize);
                // Safe zone (clear)
                this.ctx.save();
                this.ctx.globalCompositeOperation='destination-out';
                this.ctx.beginPath();
                this.ctx.arc(this.stormCenter.x,this.stormCenter.y,this.stormRadius,0,Math.PI*2);
                this.ctx.fill();
                this.ctx.restore();
                // Edge glow
                this.ctx.shadowColor='#00d4ff'; this.ctx.shadowBlur=20;
                this.ctx.strokeStyle='#00d4ff'; this.ctx.lineWidth=3;
                this.ctx.beginPath();
                this.ctx.arc(this.stormCenter.x,this.stormCenter.y,this.stormRadius,0,Math.PI*2);
                this.ctx.stroke(); this.ctx.shadowBlur=0;
            }
            drawLoot(){
                const t=Date.now()/1000;
                for(const l of this.loot){
                    const w=new Weapon(l.type);
                    const pulse=0.7+0.3*Math.sin(t*3+l.pos.x*0.01);
                    this.ctx.shadowColor=w.glowColor; this.ctx.shadowBlur=15*pulse;
                    const s=8;
                    this.ctx.fillStyle=w.color;
                    this.ctx.fillRect(l.pos.x-s/2,l.pos.y-s/2,s,s);
                    this.ctx.shadowBlur=0;
                }
            }
            drawSpeedLines(){
                if(!this.spectatorTarget||this.spectatorTarget.speedLineTimer<=0)return;
                const sx=this.spectatorTarget.pos.x-this.camera.x;
                const sy=this.spectatorTarget.pos.y-this.camera.y;
                const t=Date.now()/200;
                this.speedCtx.strokeStyle='rgba(0,212,255,0.2)'; this.speedCtx.lineWidth=2;
                for(let i=0;i<8;i++){
                    const a=t+i*Math.PI/4;
                    const len=30+Math.sin(t*2+i)*15;
                    this.speedCtx.beginPath();
                    this.speedCtx.moveTo(sx,sy);
                    this.speedCtx.lineTo(sx+Math.cos(a)*len,sy+Math.sin(a)*len);
                    this.speedCtx.stroke();
                }
            }
            drawMinimap(){
                const ctx=this.minimapCtx;
                const sc=this.minimap.width/this.mapSize;
                ctx.fillStyle='#0d1b2a'; ctx.fillRect(0,0,200,200);
                // Storm
                ctx.fillStyle='rgba(123,44,191,0.3)';
                ctx.fillRect(0,0,200,200);
                ctx.save();
                ctx.globalCompositeOperation='destination-out';
                ctx.beginPath();
                ctx.arc(this.stormCenter.x*sc,this.stormCenter.y*sc,this.stormRadius*sc,0,Math.PI*2);
                ctx.fill(); ctx.restore();
                ctx.strokeStyle='#00d4ff'; ctx.lineWidth=1.5;
                ctx.beginPath();
                ctx.arc(this.stormCenter.x*sc,this.stormCenter.y*sc,this.stormRadius*sc,0,Math.PI*2);
                ctx.stroke();
                for(const p of this.players){
                    if(!p.alive)continue;
                    const isTgt=p===this.spectatorTarget;
                    if(isTgt){ctx.shadowColor='#00d4ff'; ctx.shadowBlur=6;}
                    ctx.fillStyle=isTgt?'#00d4ff':p.color;
                    ctx.beginPath();
                    ctx.arc(p.pos.x*sc,p.pos.y*sc,isTgt?4:2,0,Math.PI*2); ctx.fill();
                    ctx.shadowBlur=0;
                }
                ctx.strokeStyle='rgba(255,255,255,0.4)'; ctx.lineWidth=1; ctx.setLineDash([3,2]);
                ctx.strokeRect(this.camera.x*sc,this.camera.y*sc,this.canvas.width*sc,this.canvas.height*sc);
                ctx.setLineDash([]);
            }
            loop(){
                if(!this.running)return;
                this.update(); this.draw();
                requestAnimationFrame(()=>this.loop());
            }
        }
        
        const game=new BattleRoyale();
        game.reset();
        game.draw();
    </script>
</body>
</html>
