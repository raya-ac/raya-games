<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prison Empire Tycoon - Enhanced Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(90deg, #0f0f1a 0%, #1a1a2e 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e94560;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(90deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(233, 69, 96, 0.5);
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .save-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .load-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .load-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4);
        }

        .newgame-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .newgame-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Enhanced Music Controls */
        .music-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(233, 69, 96, 0.15);
            border: 1px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .music-controls:hover {
            background: rgba(233, 69, 96, 0.25);
            border-color: rgba(233, 69, 96, 0.5);
        }

        .music-toggle {
            background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 15px rgba(233, 69, 96, 0.5);
            position: relative;
            overflow: hidden;
        }

        .music-toggle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .music-toggle:hover::before {
            width: 100%;
            height: 100%;
        }

        .music-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.6);
        }

        .music-toggle.muted {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .music-toggle.muted:hover {
            box-shadow: 0 4px 15px rgba(75, 85, 99, 0.5);
        }

        .music-toggle.playing {
            animation: musicPulse 2s ease-in-out infinite;
        }

        @keyframes musicPulse {
            0%, 100% { box-shadow: 0 2px 15px rgba(233, 69, 96, 0.5); }
            50% { box-shadow: 0 4px 25px rgba(233, 69, 96, 0.8), 0 0 40px rgba(233, 69, 96, 0.3); }
        }

        .volume-slider {
            width: 90px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            box-shadow: 0 0 12px rgba(233, 69, 96, 0.6);
            transition: transform 0.2s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .music-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .sound-indicator {
            display: flex;
            gap: 3px;
            align-items: flex-end;
            height: 16px;
        }

        .sound-bar {
            width: 3px;
            background: #e94560;
            border-radius: 2px;
            transition: height 0.1s;
        }

        .sound-bar:nth-child(1) { height: 30%; }
        .sound-bar:nth-child(2) { height: 60%; }
        .sound-bar:nth-child(3) { height: 100%; }

        .music-toggle.muted .sound-bar {
            background: #666;
            height: 20% !important;
        }

        /* Alert Banner for Riots */
        .alert-banner {
            display: none;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            padding: 12px 30px;
            text-align: center;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .alert-banner.active {
            display: block;
        }

        /* Stats Bar */
        .stats-bar {
            background: rgba(15, 15, 26, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 1px solid rgba(233, 69, 96, 0.3);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .stat-icon { font-size: 24px; }
        .stat-value { font-size: 20px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; }

        .stat-item.money { border-left: 3px solid #4ade80; }
        .stat-item.inmates { border-left: 3px solid #f472b6; }
        .stat-item.staff { border-left: 3px solid #60a5fa; }
        .stat-item.security { border-left: 3px solid #fbbf24; }
        .stat-item.reputation { border-left: 3px solid #a78bfa; }
        .stat-item.day { border-left: 3px solid #34d399; }
        .stat-item.unrest { border-left: 3px solid #ef4444; }

        /* Main Container */
        .container {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 20px;
            padding: 20px;
            max-width: 1700px;
            margin: 0 auto;
        }

        .left-panel, .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 0;
        }

        /* Panels */
        .panel {
            background: rgba(15, 15, 26, 0.8);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .panel:hover {
            border-color: rgba(233, 69, 96, 0.2);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e94560;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-tab {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #e0e0e0;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(233, 69, 96, 0.3), transparent);
            transition: width 0.3s ease;
        }

        .nav-tab:hover::before {
            width: 100%;
        }

        .nav-tab:hover {
            background: rgba(233, 69, 96, 0.2);
            border-color: #e94560;
            transform: translateX(5px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
            border-color: #e94560;
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .nav-tab.active::before {
            display: none;
        }

        .nav-tab .shortcut {
            margin-left: auto;
            font-size: 10px;
            opacity: 0.6;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Content Area */
        .content-area { min-height: 600px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake { animation: shake 0.5s ease; }

        /* Building Grid */
        .building-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .building-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .building-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .building-card:hover::after {
            left: 100%;
        }

        .building-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: #e94560;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.2);
        }

        .building-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .building-card.locked:hover {
            transform: none;
            border-color: rgba(255,255,255,0.1);
            box-shadow: none;
        }

        .building-icon { font-size: 36px; margin-bottom: 8px; transition: transform 0.3s; }
        .building-card:hover .building-icon { transform: scale(1.1); }
        .building-name { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .building-count { color: #e94560; font-size: 13px; }
        .building-cost { font-size: 12px; color: #4ade80; margin-top: 5px; }
        .building-unlock { font-size: 11px; color: #fbbf24; margin-top: 5px; }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #e94560 0%, #c73e54 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 3px;
            font-size: 13px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn.success { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }
        .btn.danger { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
        .btn.warning { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn.small { padding: 6px 12px; font-size: 12px; }

        /* Staff Cards */
        .staff-list { display: grid; gap: 10px; }
        .staff-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .staff-card:hover {
            border-color: rgba(233, 69, 96, 0.3);
            transform: translateX(5px);
        }

        .staff-info { display: flex; align-items: center; gap: 15px; }
        .staff-icon { font-size: 30px; }
        .staff-details h4 { margin-bottom: 5px; }
        .staff-details p { font-size: 12px; color: #888; }
        .staff-salary { color: #4ade80; font-weight: bold; margin-right: 10px; }
        .staff-controls { display: flex; gap: 5px; align-items: center; }

        /* Skill Stars */
        .skill-stars { color: #fbbf24; font-size: 12px; margin-top: 3px; }

        /* Inmate List */
        .inmate-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .inmate-item:hover { border-color: rgba(233, 69, 96, 0.3); }

        .inmate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .inmate-name { font-weight: bold; font-size: 16px; }
        .inmate-traits { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }

        .trait-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .trait-badge:hover { transform: scale(1.1); }

        .trait-violent { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        .trait-smart { background: rgba(59, 130, 246, 0.3); color: #93c5fd; }
        .trait-addict { background: rgba(168, 85, 247, 0.3); color: #d8b4fe; }
        .trait-gang { background: rgba(245, 158, 11, 0.3); color: #fcd34d; }
        .trait-snitch { background: rgba(34, 197, 94, 0.3); color: #86efac; }
        .trait-loyal { background: rgba(14, 165, 233, 0.3); color: #7dd3fc; }
        .trait-psychopath { background: rgba(220, 38, 38, 0.3); color: #fecaca; }
        .trait-innocent { background: rgba(250, 204, 21, 0.3); color: #fef08a; }

        .inmate-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 12px;
            margin-top: 10px;
        }

        .inmate-stat {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.2s;
        }

        .inmate-stat:hover {
            background: rgba(0,0,0,0.3);
            transform: scale(1.05);
        }

        .inmate-stat-label { color: #888; font-size: 10px; }
        .inmate-stat-value { font-weight: bold; margin-top: 3px; }

        .inmate-risk {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }

        .risk-low { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .risk-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .risk-high { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        .risk-death { background: rgba(220, 38, 38, 0.3); color: #fecaca; }

        .inmate-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-fill.health { background: linear-gradient(90deg, #f87171, #ef4444); }
        .progress-fill.happiness { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .progress-fill.rehab { background: linear-gradient(90deg, #4ade80, #22c55e); }
        .progress-fill.unrest { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .progress-fill.education { background: linear-gradient(90deg, #3b82f6, #2563eb); }

        /* Policy Sliders */
        .policy-item {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .policy-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .policy-label { font-weight: bold; }
        .policy-value { color: #e94560; }

        .policy-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .policy-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }

        .policy-description {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* Event Log */
        .event-log {
            max-height: 350px;
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid;
            background: rgba(255,255,255,0.05);
            font-size: 13px;
            transition: all 0.3s ease;
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .event-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateX(5px);
        }

        .event-item.info { border-left-color: #60a5fa; }
        .event-item.warning { border-left-color: #fbbf24; }
        .event-item.danger { border-left-color: #f87171; }
        .event-item.success { border-left-color: #4ade80; }
        .event-time { font-size: 11px; color: #666; margin-bottom: 5px; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            border: 2px solid #e94560;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
            animation: modalPop 0.3s ease;
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-title { font-size: 24px; margin-bottom: 20px; color: #e94560; }
        .modal-content { margin-bottom: 20px; line-height: 1.6; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .notification.show { transform: translateX(0); animation: notificationPulse 0.5s ease; }

        @keyframes notificationPulse {
            0% { transform: translateX(400px) scale(0.8); }
            50% { transform: translateX(0) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }

        .notification.success { background: linear-gradient(135deg, #4ade80, #22c55e); }
        .notification.error { background: linear-gradient(135deg, #f87171, #ef4444); }
        .notification.warning { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .notification.riot { background: linear-gradient(135deg, #dc2626, #991b1b); animation: pulse 0.5s infinite; }

        /* Prison Map */
        .prison-map {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .map-cell {
            aspect-ratio: 1;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .map-cell.cell { background: rgba(233, 69, 96, 0.3); border-color: #e94560; }
        .map-cell.min-cell { background: rgba(74, 222, 128, 0.3); border-color: #4ade80; }
        .map-cell.death { background: rgba(220, 38, 38, 0.4); border-color: #dc2626; }
        .map-cell.women { background: rgba(236, 72, 153, 0.3); border-color: #ec4899; }

        /* Unrest Meter */
        .unrest-meter {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .unrest-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .unrest-label { font-weight: bold; }
        .unrest-value { font-weight: bold; }

        .unrest-level-calm { color: #4ade80; }
        .unrest-level-uneasy { color: #fbbf24; }
        .unrest-level-tense { color: #f97316; }
        .unrest-level-dangerous { color: #ef4444; }
        .unrest-level-riot { color: #dc2626; animation: pulse 1s infinite; }

        /* Riot Panel */
        .riot-panel {
            display: none;
            background: linear-gradient(135deg, rgba(220,38,38,0.3), rgba(153,27,27,0.3));
            border: 2px solid #dc2626;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            animation: riotPulse 1s infinite;
        }

        @keyframes riotPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(220, 38, 38, 0.3); }
            50% { box-shadow: 0 0 40px rgba(220, 38, 38, 0.6); }
        }

        .riot-panel.active { display: block; }

        /* Program Cards */
        .program-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .program-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .program-card:hover {
            border-color: #4ade80;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 222, 128, 0.2);
        }

        .program-card.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }

        .program-icon { font-size: 32px; margin-bottom: 10px; transition: transform 0.3s; }
        .program-card:hover .program-icon { transform: scale(1.2); }
        .program-name { font-weight: bold; margin-bottom: 5px; }
        .program-desc { font-size: 12px; color: #888; margin-bottom: 10px; }
        .program-cost { color: #4ade80; font-size: 13px; }

        /* Contraband Panel */
        .contraband-panel {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .contraband-types {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .contraband-item {
            background: rgba(0,0,0,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .contraband-item:hover {
            transform: scale(1.05);
            background: rgba(0,0,0,0.3);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #e94560; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #c73e54; }

        /* Responsive */
        @media (max-width: 1400px) {
            .container { grid-template-columns: 220px 1fr; }
            .right-panel { display: none; }
        }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .left-panel { display: none; }
        }

        /* Two column layout helpers */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section-box {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .section-box:hover {
            background: rgba(255,255,255,0.06);
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #e94560;
        }

        /* Keyboard shortcuts hint */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 12px;
            color: #888;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 250px;
        }

        .keyboard-hint kbd {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .keyboard-hint h4 {
            color: #e94560;
            margin-bottom: 8px;
        }

        /* Visualizer bars for music */
        .visualizer {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 20px;
            margin-left: 8px;
        }

        .visualizer-bar {
            width: 3px;
            background: #e94560;
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .music-toggle:not(.muted) ~ .visualizer .visualizer-bar {
            animation: visualizer 0.5s ease-in-out infinite alternate;
        }

        @keyframes visualizer {
            0% { height: 20%; }
            100% { height: 100%; }
        }

        .visualizer-bar:nth-child(1) { animation-delay: 0s; }
        .visualizer-bar:nth-child(2) { animation-delay: 0.1s; }
        .visualizer-bar:nth-child(3) { animation-delay: 0.2s; }
        .visualizer-bar:nth-child(4) { animation-delay: 0.3s; }
        .visualizer-bar:nth-child(5) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">üèõÔ∏è Prison Empire Tycoon</div>
        <div class="header-actions">
            <div class="music-controls" id="music-controls">
                <button class="music-toggle muted" id="music-toggle" onclick="audioSystem.toggle()" title="Click to start music (M)">
                    üîá
                </button>
                <div class="visualizer" id="visualizer">
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                    <div class="visualizer-bar"></div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <span class="music-label">Ambience</span>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="20" oninput="audioSystem.setVolume(this.value)">
                </div>
            </div>
            <button class="save-btn" onclick="game.saveGame()">üíæ Save</button>
            <button class="load-btn" onclick="game.loadGame()">üìÇ Load</button>
            <button class="newgame-btn" onclick="game.newGame()">üîÑ New</button>
            <a href="/games" class="back-btn">üéÆ Games</a>
        </div>
    </header>

    <!-- Alert Banner for Riots -->
    <div class="alert-banner" id="riot-alert">
        üö® RIOT IN PROGRESS! PRISONERS ARE REBELLING! üö®
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item money">
            <span class="stat-icon">üí∞</span>
            <div>
                <div class="stat-value" id="money">$50,000</div>
                <div class="stat-label">Funds</div>
            </div>
        </div>
        <div class="stat-item inmates">
            <span class="stat-icon">üë•</span>
            <div>
                <div class="stat-value"><span id="inmate-count">0</span> / <span id="capacity">20</span></div>
                <div class="stat-label">Inmates</div>
            </div>
        </div>
        <div class="stat-item staff">
            <span class="stat-icon">üëÆ</span>
            <div>
                <div class="stat-value" id="staff-count">0</div>
                <div class="stat-label">Staff</div>
            </div>
        </div>
        <div class="stat-item security">
            <span class="stat-icon">üõ°Ô∏è</span>
            <div>
                <div class="stat-value" id="security-level">Low</div>
                <div class="stat-label">Security</div>
            </div>
        </div>
        <div class="stat-item reputation">
            <span class="stat-icon">‚≠ê</span>
            <div>
                <div class="stat-value" id="reputation">50%</div>
                <div class="stat-label">Reputation</div>
            </div>
        </div>
        <div class="stat-item unrest">
            <span class="stat-icon">üî•</span>
            <div>
                <div class="stat-value" id="unrest-level">Calm</div>
                <div class="stat-label">Unrest</div>
            </div>
        </div>
        <div class="stat-item day">
            <span class="stat-icon">üìÖ</span>
            <div>
                <div class="stat-value" id="day">1</div>
                <div class="stat-label">Day</div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel - Navigation -->
        <div class="left-panel">
            <div class="panel">
                <div class="panel-title">üìã Menu</div>
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="overview" onclick="game.switchTab('overview')">
                        <span>üèõÔ∏è</span> Overview <span class="shortcut">1</span>
                    </div>
                    <div class="nav-tab" data-tab="buildings" onclick="game.switchTab('buildings')">
                        <span>üèóÔ∏è</span> Buildings <span class="shortcut">2</span>
                    </div>
                    <div class="nav-tab" data-tab="staff" onclick="game.switchTab('staff')">
                        <span>üëÆ</span> Staff <span class="shortcut">3</span>
                    </div>
                    <div class="nav-tab" data-tab="inmates" onclick="game.switchTab('inmates')">
                        <span>üë•</span> Inmates <span class="shortcut">4</span>
                    </div>
                    <div class="nav-tab" data-tab="programs" onclick="game.switchTab('programs')">
                        <span>üìö</span> Rehabilitation <span class="shortcut">5</span>
                    </div>
                    <div class="nav-tab" data-tab="parole" onclick="game.switchTab('parole')">
                        <span>üìù</span> Parole & Appeals <span class="shortcut">6</span>
                    </div>
                    <div class="nav-tab" data-tab="security" onclick="game.switchTab('security')">
                        <span>üîí</span> Security <span class="shortcut">7</span>
                    </div>
                    <div class="nav-tab" data-tab="policies" onclick="game.switchTab('policies')">
                        <span>üìú</span> Policies <span class="shortcut">8</span>
                    </div>
                    <div class="nav-tab" data-tab="finance" onclick="game.switchTab('finance')">
                        <span>üíµ</span> Finance <span class="shortcut">9</span>
                    </div>
                    <div class="nav-tab" data-tab="settings" onclick="game.switchTab('settings')">
                        <span>‚öôÔ∏è</span> Settings <span class="shortcut">0</span>
                    </div>
                </div>
            </div>
            <div class="panel" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                <div class="panel-title">üì∞ Event Log</div>
                <div class="event-log" id="event-log" style="flex: 1;">
                    <div class="event-item info">
                        <div class="event-time">Day 1 - Morning</div>
                        <div>Prison facility established. Welcome, Warden!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - Content -->
        <div class="panel content-area">
            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <div class="panel-title">üèõÔ∏è Prison Overview</div>
                
                <!-- Unrest Meter -->
                <div class="unrest-meter">
                    <div class="unrest-header">
                        <span class="unrest-label">üî• Prisoner Unrest Level</span>
                        <span class="unrest-value" id="unrest-text">Calm</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill unrest" id="unrest-bar" style="width: 0%"></div>
                    </div>
                    <p style="font-size: 12px; color: #888; margin-top: 8px;">
                        High unrest leads to riots, violence, and escapes. Keep prisoners happy with good conditions and programs.
                    </p>
                </div>

                <!-- Riot Panel -->
                <div class="riot-panel" id="riot-panel">
                    <h3 style="color: #dc2626; margin-bottom: 15px;">üö® RIOT IN PROGRESS!</h3>
                    <p>Prisoners are rioting! Take immediate action to suppress the riot.</p>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn danger" onclick="game.suppressRiot('guards')" id="btn-riot-guards">
                            üëÆ Deploy Riot Guards (-$5,000)
                        </button>
                        <button class="btn warning" onclick="game.suppressRiot('negotiate')" id="btn-riot-negotiate">
                            üó£Ô∏è Negotiate (Risky)
                        </button>
                        <button class="btn" onclick="game.suppressRiot('lockdown')" id="btn-riot-lockdown">
                            üîí Lockdown All Wings
                        </button>
                    </div>
                    <div id="riot-status" style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <strong>Riot Duration:</strong> <span id="riot-duration">0</span> hours<br>
                        <strong>Damage So Far:</strong> $<span id="riot-damage">0</span>
                    </div>
                </div>

                <div class="prison-map" id="prison-map"></div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                        <h4 style="color: #e94560; margin-bottom: 15px;">üèóÔ∏è Buildings</h4>
                        <div id="overview-buildings" style="display: grid; gap: 8px;"></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                        <h4 style="color: #e94560; margin-bottom: 15px;">üëÆ Staff Overview</h4>
                        <div id="overview-staff" style="display: grid; gap: 8px;"></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                        <h4 style="color: #e94560; margin-bottom: 15px;">üìä Status Summary</h4>
                        <div style="display: grid; gap: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Security Level:</span>
                                <span id="overview-security">Medium</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Food Quality:</span>
                                <span id="overview-food">Standard</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Cell Quality:</span>
                                <span id="overview-cell-quality">Basic</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Active Programs:</span>
                                <span id="overview-programs">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buildings Tab -->
            <div class="tab-content" id="buildings">
                <div class="panel-title">üèóÔ∏è Build Facilities</div>
                <div class="building-grid" id="building-grid"></div>
                
                <div style="margin-top: 30px;">
                    <div class="panel-title">üîì Expansion Areas</div>
                    <div class="building-grid" id="expansion-grid"></div>
                </div>
            </div>

            <!-- Staff Tab -->
            <div class="tab-content" id="staff">
                <div class="panel-title">üëÆ Staff Management</div>
                <p style="color: #888; margin-bottom: 15px; font-size: 13px;">
                    Hire staff with different skill levels. Higher skilled staff are more effective but cost more.
                </p>
                <div class="staff-list" id="staff-list"></div>
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Current Staff</h4>
                    <div id="current-staff">
                        <p style="color: #888;">No staff hired yet.</p>
                    </div>
                </div>
            </div>

            <!-- Inmates Tab -->
            <div class="tab-content" id="inmates">
                <div class="panel-title">üë• Inmate Management</div>
                
                <div class="contraband-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <strong>üïµÔ∏è Contraband Situation</strong>
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">
                                Conduct searches to find contraband. Punish offenders to maintain order.
                            </p>
                        </div>
                        <button class="btn warning" onclick="game.conductSearch()">
                            üîç Conduct Search (-$500)
                        </button>
                    </div>
                    <div class="contraband-types">
                        <div class="contraband-item">
                            <span>üî™</span> <span id="contraband-weapons">0</span> Weapons
                        </div>
                        <div class="contraband-item">
                            <span>üíä</span> <span id="contraband-drugs">0</span> Drugs
                        </div>
                        <div class="contraband-item">
                            <span>üì±</span> <span id="contraband-phones">0</span> Phones
                        </div>
                        <div class="contraband-item">
                            <span>üçæ</span> <span id="contraband-alcohol">0</span> Alcohol
                        </div>
                    </div>
                </div>
                
                <div id="inmate-list">
                    <p style="color: #888; text-align: center; padding: 40px;">No inmates yet. Accept intake from the Overview tab.</p>
                </div>
            </div>

            <!-- Programs Tab -->
            <div class="tab-content" id="programs">
                <div class="panel-title">üìö Rehabilitation Programs</div>
                <p style="color: #888; margin-bottom: 15px; font-size: 13px;">
                    Enroll inmates in programs to reduce recidivism and improve parole outcomes. Each program costs money to run daily.
                </p>
                <div class="program-grid" id="program-grid"></div>
                
                <div style="margin-top: 30px;">
                    <div class="panel-title">üìä Program Statistics</div>
                    <div class="two-col">
                        <div class="section-box">
                            <div class="section-title">Active Enrollments</div>
                            <div id="program-enrollments">
                                <p style="color: #888; font-size: 13px;">No active enrollments</p>
                            </div>
                        </div>
                        <div class="section-box">
                            <div class="section-title">Graduates This Year</div>
                            <div id="program-graduates">
                                <p style="color: #888; font-size: 13px;">No graduates yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parole & Appeals Tab -->
            <div class="tab-content" id="parole">
                <div class="panel-title">üìù Parole & Appeals System</div>
                
                <div class="two-col">
                    <div class="section-box">
                        <div class="section-title">üìã Parole Board</div>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">
                            Review inmates for early release based on behavior and rehabilitation progress.
                        </p>
                        <div id="parole-queue">
                            <p style="color: #888;">No parole applications pending</p>
                        </div>
                    </div>
                    
                    <div class="section-box">
                        <div class="section-title">‚öñÔ∏è Appeals Board</div>
                        <p style="font-size: 12px; color: #888; margin-bottom: 15px;">
                            Review appeals from inmates claiming wrongful conviction. Some may be innocent!
                        </p>
                        <div id="appeals-queue">
                            <p style="color: #888;">No appeals pending</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;" class="section-box">
                    <div class="section-title">üìà Parole Statistics</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #4ade80;" id="parole-approved">0</div>
                            <div style="font-size: 12px; color: #888;">Paroles Granted</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;" id="parole-denied">0</div>
                            <div style="font-size: 12px; color: #888;">Paroles Denied</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #4ade80;" id="appeals-upheld">0</div>
                            <div style="font-size: 12px; color: #888;">Appeals Upheld</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #a78bfa;" id="wrongful-released">0</div>
                            <div style="font-size: 12px; color: #888;">Wrongful Convictions</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="tab-content" id="security">
                <div class="panel-title">üîí Security Operations</div>
                
                <div class="section-box" style="margin-bottom: 20px;">
                    <div class="section-title">üïµÔ∏è Contraband Control</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button class="btn" onclick="game.conductSearch('random')">
                            üîç Random Cell Search (-$500)
                        </button>
                        <button class="btn secondary" onclick="game.conductSearch('full')">
                            üîí Full Lockdown Search (-$2,000)
                        </button>
                        <button class="btn warning" onclick="game.installScanner()">
                            üì° Install Body Scanner (-$10,000)
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #888; margin-top: 10px;">
                        Searches find contraband but lower inmate happiness. Scanners reduce smuggling over time.
                    </p>
                </div>
                
                <div class="section-box" style="margin-bottom: 20px;">
                    <div class="section-title">üö® Riot Control</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button class="btn" onclick="game.deployRiotSquad()">
                            üëÆ Deploy Riot Squad (-$3,000)
                        </button>
                        <button class="btn secondary" onclick="game.increasePatrols()">
                            üö∂ Increase Patrols (-$500/day)
                        </button>
                    </div>
                    <div style="margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                        <strong>Riot Risk Factors:</strong>
                        <ul style="font-size: 12px; color: #888; margin-top: 8px; margin-left: 20px;">
                            <li>Overcrowding increases unrest rapidly</li>
                            <li>Low food quality causes dissatisfaction</li>
                            <li>Too many violent inmates without guards</li>
                            <li>Gang members increase tension</li>
                            <li>Addicts without access to programs</li>
                        </ul>
                    </div>
                </div>
                
                <div class="section-box">
                    <div class="section-title">üìä Security Overview</div>
                    <div id="security-overview" style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 5px; margin-bottom: 8px;">
                            <span>Guard to Inmate Ratio:</span>
                            <span id="guard-ratio">0:0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 5px; margin-bottom: 8px;">
                            <span>High Risk Inmates:</span>
                            <span id="high-risk-count">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 5px; margin-bottom: 8px;">
                            <span>Known Gang Members:</span>
                            <span id="gang-count">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 5px;">
                            <span>Contraband Found Today:</span>
                            <span id="contraband-today">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Policies Tab -->
            <div class="tab-content" id="policies">
                <div class="panel-title">üìú Prison Policies</div>
                
                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üîí Security Level</span>
                        <span class="policy-value" id="security-value">Medium</span>
                    </div>
                    <input type="range" class="policy-slider" id="security-slider" min="1" max="5" value="3" onchange="game.updatePolicy('security', this.value)">
                    <p class="policy-description">Higher security reduces escapes but increases inmate tension.</p>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üìö Rehabilitation Focus</span>
                        <span class="policy-value" id="rehab-value">Balanced</span>
                    </div>
                    <input type="range" class="policy-slider" id="rehab-slider" min="0" max="100" value="50" onchange="game.updatePolicy('rehabilitation', this.value)">
                    <p class="policy-description">Balance between punishment and rehabilitation.</p>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üçΩÔ∏è Food Quality</span>
                        <span class="policy-value" id="food-value">Standard</span>
                    </div>
                    <input type="range" class="policy-slider" id="food-slider" min="1" max="5" value="3" onchange="game.updatePolicy('food', this.value)">
                    <p class="policy-description">Better food improves morale but costs more per day per inmate.</p>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">‚è∞ Work Programs</span>
                        <span class="policy-value" id="work-value">Moderate</span>
                    </div>
                    <input type="range" class="policy-slider" id="work-slider" min="0" max="100" value="50" onchange="game.updatePolicy('work', this.value)">
                    <p class="policy-description">Inmate work programs generate income but require supervision.</p>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üõå Cell Quality</span>
                        <span class="policy-value" id="cell-quality-value">Basic</span>
                    </div>
                    <input type="range" class="policy-slider" id="cell-quality-slider" min="1" max="5" value="2" onchange="game.updatePolicy('cellQuality', this.value)">
                    <p class="policy-description">Better cells improve happiness but cost more in maintenance.</p>
                </div>
            </div>

            <!-- Finance Tab -->
            <div class="tab-content" id="finance">
                <div class="panel-title">üíµ Financial Overview</div>
                <div style="display: grid; gap: 15px;">
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Daily Government Grant</span>
                        <span style="color: #4ade80; font-weight: bold;" id="daily-grant">+$2,000</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Inmate Work Income</span>
                        <span style="color: #4ade80; font-weight: bold;" id="work-income">$0</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Staff Salaries</span>
                        <span style="color: #f87171; font-weight: bold;" id="staff-cost">-$0</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Food Costs</span>
                        <span style="color: #f87171; font-weight: bold;" id="food-cost">-$0</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Program Costs</span>
                        <span style="color: #f87171; font-weight: bold;" id="program-cost">-$0</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between;">
                        <span>Maintenance</span>
                        <span style="color: #f87171; font-weight: bold;" id="maintenance-cost">-$0</span>
                    </div>
                    <div class="stat-item" style="justify-content: space-between; border-top: 2px solid #e94560; margin-top: 10px; padding-top: 15px;">
                        <span style="font-weight: bold;">Net Daily Income</span>
                        <span style="font-weight: bold;" id="net-income">+$2,000</span>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px; color: #e94560;">Transaction History</h4>
                    <div id="transaction-history" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #888; font-size: 12px;">Day 1: Initial funding received (+$50,000)</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="panel-title">‚öôÔ∏è Game Settings</div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üíæ Auto-Save</span>
                        <span class="policy-value" id="autosave-value">ON</span>
                    </div>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px;">
                        <input type="checkbox" id="autosave-toggle" checked onchange="game.toggleAutosave(this.checked)">
                        <span>Automatically save game every 30 seconds</span>
                    </label>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üéÆ Save Management</span>
                    </div>
                    <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn" onclick="game.saveGame()">üíæ Save Game Now</button>
                        <button class="btn secondary" onclick="game.loadGame()">üìÇ Load Saved Game</button>
                        <button class="btn danger" onclick="game.newGame()">üîÑ Start New Game</button>
                    </div>
                </div>

                <div class="policy-item">
                    <div class="policy-header">
                        <span class="policy-label">üíæ Save Status</span>
                    </div>
                    <div id="save-status" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 14px;">
                        <span style="color: #888;">No save data found</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Quick Stats & Actions -->
        <div class="right-panel">
            <div class="panel">
                <div class="panel-title">üìä Daily Report</div>
                <div id="sidebar-daily-report" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; font-size: 14px;">
                    <p>Welcome to your new prison facility!</p>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-title">üìà Quick Stats</div>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span>üí∞ Balance</span>
                        <span id="sidebar-money" style="color: #4ade80; font-weight: bold;">$50,000</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span>üë• Inmates</span>
                        <span id="sidebar-inmates"><span id="sidebar-inmate-count">0</span> / <span id="sidebar-capacity">20</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span>üëÆ Staff</span>
                        <span id="sidebar-staff-count">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span>‚≠ê Reputation</span>
                        <span id="sidebar-reputation" style="color: #a78bfa; font-weight: bold;">50%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span>üî• Unrest</span>
                        <span id="sidebar-unrest" style="color: #4ade80; font-weight: bold;">Calm</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid #e94560;">
                        <span>üìÖ Day</span>
                        <span id="sidebar-day" style="color: #e94560; font-weight: bold;">1</span>
                    </div>
                </div>
            </div>
            
            <div class="panel" style="flex: 1;">
                <div class="panel-title">üíµ Daily Finances</div>
                <div style="display: grid; gap: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888;">Revenue:</span>
                        <span id="sidebar-revenue" style="color: #4ade80;">+$2,000</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #888;">Expenses:</span>
                        <span id="sidebar-expenses" style="color: #f87171;">-$0</span>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px; padding-top: 8px; display: flex; justify-content: space-between; font-weight: bold;">
                        <span>Net:</span>
                        <span id="sidebar-net">+$2,000</span>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="panel-title" style="font-size: 14px; border: none; padding-bottom: 5px;">‚ö° Quick Actions</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn" style="padding: 10px; font-size: 13px;" onclick="game.acceptIntake()">üì• Accept Intake</button>
                        <button class="btn secondary" style="padding: 10px; font-size: 13px;" onclick="game.nextDay()">‚è≠Ô∏è Next Day</button>
                        <button class="btn warning" style="padding: 10px; font-size: 13px;" onclick="game.conductSearch()">üîç Quick Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-title" id="modal-title">Title</div>
            <div class="modal-content" id="modal-content">Content</div>
            <div class="modal-actions" id="modal-actions">
                <button class="btn" onclick="game.closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="keyboard-hint" id="keyboard-hint">
        <h4>‚å®Ô∏è Keyboard Shortcuts</h4>
        <div><kbd>1-9</kbd> Switch tabs</div>
        <div><kbd>M</kbd> Toggle music</div>
        <div><kbd>S</kbd> Save game</div>
        <div><kbd>L</kbd> Load game</div>
        <div><kbd>N</kbd> Next day</div>
        <div><kbd>Space</kbd> Pause/Resume</div>
        <div><kbd>?</kbd> Toggle this help</div>
    </div>

    <script>

// ================================================
// PRISON AUDIO SYSTEM - Industrial Ambient
// ================================================
const audioSystem = (() => {
    let ctx = null, masterGain = null, compressor = null;
    let enabled = false, volume = 0.2;
    let ambientNodes = [], beatInterval = null, ambientInterval = null;
    let beepInterval = null;

    function init() {
        try {
            ctx = new (window.AudioContext || window.webkitAudioContext)();
            compressor = ctx.createDynamicsCompressor();
            compressor.threshold.value = -20; compressor.ratio.value = 4;
            masterGain = ctx.createGain();
            masterGain.gain.value = 0;
            masterGain.connect(compressor);
            compressor.connect(ctx.destination);
        } catch(e) { console.log('Audio not supported'); }
    }

    function playDrone(freq, gainVal, duration) {
        if (!ctx || !enabled) return null;
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        const filter = ctx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 400;
        osc.type = 'sawtooth'; osc.frequency.value = freq;
        g.gain.setValueAtTime(0, ctx.currentTime);
        g.gain.linearRampToValueAtTime(gainVal, ctx.currentTime + 2);
        osc.connect(filter); filter.connect(g); g.connect(masterGain);
        osc.start();
        if (duration) {
            g.gain.setValueAtTime(gainVal, ctx.currentTime + duration - 1);
            g.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
            osc.stop(ctx.currentTime + duration);
        }
        return { osc, gain: g };
    }

    function playMetalHit(time) {
        if (!ctx || !enabled) return;
        const buf = ctx.createBuffer(1, ctx.sampleRate * 0.3, ctx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = (Math.random()*2-1) * Math.exp(-i/(ctx.sampleRate*0.05));
        const src = ctx.createBufferSource(); src.buffer = buf;
        const filter = ctx.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 1200;
        const g = ctx.createGain(); g.gain.value = 0.04;
        src.connect(filter); filter.connect(g); g.connect(masterGain);
        src.start(time || ctx.currentTime);
    }

    function playIntercomBeep() {
        if (!ctx || !enabled) return;
        [880, 1100].forEach((f, i) => {
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.frequency.value = f; osc.type = 'sine';
            const t = ctx.currentTime + i * 0.15;
            g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.03, t+0.02);
            g.gain.setValueAtTime(0.03, t+0.08); g.gain.linearRampToValueAtTime(0, t+0.1);
            osc.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t+0.11);
        });
    }

    function startAmbient() {
        if (!ctx) return;
        // Low industrial drone
        ambientNodes.push(playDrone(55, 0.08));
        ambientNodes.push(playDrone(82, 0.05));
        ambientNodes.push(playDrone(110, 0.03));

        // Slow metallic beats (chains, doors)
        let beat = 0;
        beatInterval = setInterval(() => {
            if (!enabled) return;
            const pattern = [1,0,0,1, 0,1,0,0, 1,0,0,0, 0,1,0,1];
            if (pattern[beat % 16]) playMetalHit();
            beat++;
        }, 400);

        // Random intercom beeps
        beepInterval = setInterval(() => {
            if (enabled && Math.random() < 0.4) playIntercomBeep();
        }, 7000);
    }

    function stopAmbient() {
        ambientNodes.forEach(n => {
            if (n && n.osc) { try { n.osc.stop(); } catch(e){} }
        });
        ambientNodes = [];
        clearInterval(beatInterval); clearInterval(beepInterval);
    }

    function updateVisualizer() {
        const bars = document.querySelectorAll('.visualizer-bar');
        bars.forEach((b, i) => {
            const h = enabled ? (20 + Math.random() * 80) : 10;
            b.style.height = h + '%';
            b.style.animationDelay = (i * 0.1) + 's';
        });
    }

    return {
        toggle() {
            if (!ctx) init();
            if (ctx.state === 'suspended') ctx.resume();
            enabled = !enabled;
            const btn = document.getElementById('music-toggle');
            if (enabled) {
                masterGain.gain.setTargetAtTime(volume, ctx.currentTime, 0.3);
                startAmbient();
                btn.textContent = 'üîä'; btn.classList.remove('muted'); btn.classList.add('playing');
                const viz = document.getElementById('visualizer');
                if (viz) viz.style.opacity = '1';
            } else {
                masterGain.gain.setTargetAtTime(0, ctx.currentTime, 0.3);
                setTimeout(stopAmbient, 300);
                btn.textContent = 'üîá'; btn.classList.add('muted'); btn.classList.remove('playing');
            }
            // Animate visualizer
            if (enabled) setInterval(updateVisualizer, 150);
        },
        setVolume(v) {
            volume = v / 100;
            if (masterGain && enabled) masterGain.gain.setTargetAtTime(volume, ctx.currentTime, 0.1);
        },
        playClick() {
            if (!ctx || !enabled) return;
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.frequency.value = 600; osc.type = 'sine';
            g.gain.setValueAtTime(0.05, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
            osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.09);
        },
        playPurchase() {
            if (!ctx || !enabled) return;
            [523, 659, 784].forEach((f, i) => {
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.frequency.value = f; osc.type = 'sine';
                const t = ctx.currentTime + i*0.1;
                g.gain.setValueAtTime(0.06, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.15);
                osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t+0.16);
            });
        },
        playAlert() {
            if (!ctx || !enabled) return;
            [440, 550, 440, 550].forEach((f, i) => {
                const osc = ctx.createOscillator(); const g = ctx.createGain();
                osc.frequency.value = f; osc.type = 'square';
                const t = ctx.currentTime + i*0.15;
                g.gain.setValueAtTime(0.06, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.14);
                osc.connect(g); g.connect(ctx.destination); osc.start(t); osc.stop(t+0.15);
            });
        },
        playRiot() {
            if (!ctx || !enabled) return;
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const osc = ctx.createOscillator(); const g = ctx.createGain();
                    osc.frequency.value = 80 + Math.random()*200; osc.type = 'sawtooth';
                    g.gain.setValueAtTime(0.08, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.2);
                    osc.connect(g); g.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime+0.21);
                }, i*120);
            }
        }
    };
})();

// ================================================
// PRISON GAME ENGINE
// ================================================
const game = (() => {
    // --- STATE ---
    let state = {
        money: 50000, inmates: [], staff: {guards:0,counselors:0,medics:0,admins:0},
        buildings: {cells:1,cafeteria:0,gym:0,library:0,workshop:0,medical:0,chapel:0,solitary:0},
        expansions: {minSecurity:0,deathRow:0,womens:0},
        programs: {education:false,vocational:false,therapy:false,drugRehab:false,faithBased:false},
        activePrograms: new Set(),
        policies: {security:3, rehabilitation:50, food:3, work:50, cellQuality:2},
        unrest: 0, reputation: 50, day: 1,
        riotActive: false, riotDuration: 0, riotDamage: 0,
        contraband: {weapons:0,drugs:0,phones:0,alcohol:0},
        hasScanner: false, extraPatrols: false,
        paroleStats: {approved:0,denied:0,upheld:0,wrongful:0},
        paused: false, autosave: true,
        events: [{time:'Day 1 - Morning', text:'Prison facility established. Welcome, Warden!', type:'info'}],
        transactions: ['Day 1: Initial funding received (+$50,000)'],
        dayTimer: null
    };

    const NAMES = ['Marcus Johnson','Luis Torres','Derek White','Antoine Brown','James Miller',
        'Robert Davis','Michael Wilson','Carlos Garcia','Tyrone Jackson','Nathan Lee',
        'Brandon Smith','Deshawn Harris','Kevin Thompson','Andre Robinson','Jason Williams'];
    const TRAITS_POOL = ['violent','smart','addict','gang','snitch','loyal','psychopath','innocent'];
    const CRIMES = ['Armed Robbery','Drug Trafficking','Assault','Fraud','Murder','Burglary','Extortion'];

    function rand(min,max) { return Math.floor(Math.random()*(max-min+1))+min; }
    function choose(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    function getCapacity() {
        return 20 + state.buildings.cells*15 + state.expansions.minSecurity*25 +
               state.expansions.deathRow*10 + state.expansions.womens*30;
    }

    function getGuardCount() { return state.staff.guards; }
    function getSecurityLevel() {
        const g = getGuardCount(), p = state.policies.security;
        if (g >= 10 && p >= 4) return 'Maximum';
        if (g >= 6 && p >= 3) return 'High';
        if (g >= 3 && p >= 2) return 'Medium';
        return 'Low';
    }

    function getDailyCosts() {
        const staffCost = (state.staff.guards*800 + state.staff.counselors*600 +
                          state.staff.medics*700 + state.staff.admins*500);
        const foodCost = state.inmates.length * [5,8,12,18,25][state.policies.food-1];
        const programCost = [...state.activePrograms].length * 500;
        const maint = Object.values(state.buildings).reduce((a,v)=>a+v*100,0);
        return { staffCost, foodCost, programCost, maint };
    }

    function getDailyRevenue() {
        const base = 2000 + state.inmates.length * 80;
        const workIncome = state.policies.work * state.inmates.length * 0.3;
        return { base, workIncome };
    }

    function addEvent(text, type='info') {
        const times = ['Morning','Afternoon','Evening','Night'];
        state.events.unshift({time:`Day ${state.day} - ${choose(times)}`, text, type});
        if (state.events.length > 50) state.events.pop();
        renderEvents();
    }

    function addTransaction(text) {
        state.transactions.unshift(`Day ${state.day}: ${text}`);
        if (state.transactions.length > 30) state.transactions.pop();
    }

    function generateInmate() {
        const numTraits = rand(1,3);
        const traits = [];
        const pool = [...TRAITS_POOL];
        for (let i=0;i<numTraits;i++) {
            const idx = Math.floor(Math.random()*pool.length);
            traits.push(pool.splice(idx,1)[0]);
        }
        const sentence = rand(2,25);
        const violent = traits.includes('violent') || traits.includes('psychopath');
        const innocent = traits.includes('innocent');
        return {
            id: Date.now()+Math.random(), name: choose(NAMES)+' #'+rand(100,999),
            crime: choose(CRIMES), sentence, servedYears: 0,
            traits, age: rand(18,55),
            health: rand(60,100), happiness: rand(30,80), rehab: rand(0,40),
            risk: violent?'high':(traits.includes('gang')?'medium':'low'),
            innocent, inPrograms: [], anger: rand(0,40)
        };
    }

    // --- RENDER FUNCTIONS ---
    function renderUI() {
        const costs = getDailyCosts();
        const rev = getDailyRevenue();
        const netDaily = rev.base + rev.workIncome - costs.staffCost - costs.foodCost - costs.programCost - costs.maint;
        const cap = getCapacity();
        const inmateCount = state.inmates.length;
        const staffTotal = Object.values(state.staff).reduce((a,v)=>a+v,0);
        const sec = getSecurityLevel();

        // Header stats
        document.getElementById('money').textContent = '$'+state.money.toLocaleString();
        document.getElementById('inmate-count').textContent = inmateCount;
        document.getElementById('capacity').textContent = cap;
        document.getElementById('staff-count').textContent = staffTotal;
        document.getElementById('security-level').textContent = sec;
        document.getElementById('reputation').textContent = state.reputation+'%';
        document.getElementById('day').textContent = state.day;

        // Unrest
        const unrestPct = Math.min(100, state.unrest);
        document.getElementById('unrest-bar').style.width = unrestPct+'%';
        const unrestLabel = unrestPct<20?'Calm':unrestPct<40?'Uneasy':unrestPct<60?'Tense':unrestPct<80?'Dangerous':'RIOT RISK';
        const lvlClass = unrestPct<20?'calm':unrestPct<40?'uneasy':unrestPct<60?'tense':unrestPct<80?'dangerous':'riot';
        document.getElementById('unrest-text').textContent = unrestLabel;
        document.getElementById('unrest-text').className = 'unrest-value unrest-level-'+lvlClass;
        document.getElementById('unrest-level').textContent = unrestLabel;

        // Sidebar
        document.getElementById('sidebar-money').textContent = '$'+state.money.toLocaleString();
        document.getElementById('sidebar-inmate-count').textContent = inmateCount;
        document.getElementById('sidebar-capacity').textContent = cap;
        document.getElementById('sidebar-staff-count').textContent = staffTotal;
        document.getElementById('sidebar-reputation').textContent = state.reputation+'%';
        document.getElementById('sidebar-unrest').textContent = unrestLabel;
        document.getElementById('sidebar-day').textContent = state.day;
        document.getElementById('sidebar-revenue').textContent = '+$'+(rev.base+rev.workIncome).toLocaleString();
        document.getElementById('sidebar-expenses').textContent = '-$'+(costs.staffCost+costs.foodCost+costs.programCost+costs.maint).toLocaleString();
        document.getElementById('sidebar-net').textContent = (netDaily>=0?'+':'')+'$'+netDaily.toLocaleString();
        document.getElementById('sidebar-net').style.color = netDaily>=0?'#4ade80':'#f87171';

        // Finance tab
        document.getElementById('daily-grant').textContent = '+$'+rev.base.toLocaleString();
        document.getElementById('work-income').textContent = '+$'+Math.floor(rev.workIncome).toLocaleString();
        document.getElementById('staff-cost').textContent = '-$'+costs.staffCost.toLocaleString();
        document.getElementById('food-cost').textContent = '-$'+costs.foodCost.toLocaleString();
        document.getElementById('program-cost').textContent = '-$'+costs.programCost.toLocaleString();
        document.getElementById('maintenance-cost').textContent = '-$'+costs.maint.toLocaleString();
        document.getElementById('net-income').textContent = (netDaily>=0?'+':'')+'$'+netDaily.toLocaleString();
        document.getElementById('net-income').style.color = netDaily>=0?'#4ade80':'#f87171';

        // Security overview
        document.getElementById('guard-ratio').textContent = getGuardCount()+':'+inmateCount;
        document.getElementById('high-risk-count').textContent = state.inmates.filter(i=>i.risk==='high').length;
        document.getElementById('gang-count').textContent = state.inmates.filter(i=>i.traits.includes('gang')).length;
        document.getElementById('contraband-today').textContent = Object.values(state.contraband).reduce((a,v)=>a+v,0);
        document.getElementById('contraband-weapons').textContent = state.contraband.weapons;
        document.getElementById('contraband-drugs').textContent = state.contraband.drugs;
        document.getElementById('contraband-phones').textContent = state.contraband.phones;
        document.getElementById('contraband-alcohol').textContent = state.contraband.alcohol;

        // Overview summaries
        document.getElementById('overview-security').textContent = sec;
        document.getElementById('overview-food').textContent = ['Poor','Basic','Standard','Good','Excellent'][state.policies.food-1];
        document.getElementById('overview-cell-quality').textContent = ['Bare','Basic','Decent','Comfortable','Premium'][state.policies.cellQuality-1];
        document.getElementById('overview-programs').textContent = state.activePrograms.size;

        // Parole stats
        document.getElementById('parole-approved').textContent = state.paroleStats.approved;
        document.getElementById('parole-denied').textContent = state.paroleStats.denied;
        document.getElementById('appeals-upheld').textContent = state.paroleStats.upheld;
        document.getElementById('wrongful-released').textContent = state.paroleStats.wrongful;

        // Riot
        const riotPanel = document.getElementById('riot-panel');
        const riotAlert = document.getElementById('riot-alert');
        if (state.riotActive) {
            riotPanel.classList.add('active'); riotAlert.classList.add('active');
            document.getElementById('riot-duration').textContent = state.riotDuration;
            document.getElementById('riot-damage').textContent = state.riotDamage.toLocaleString();
        } else {
            riotPanel.classList.remove('active'); riotAlert.classList.remove('active');
        }

        renderPrisonMap(); renderOverviewBuildings(); renderOverviewStaff();
        renderBuildings(); renderStaff(); renderInmates(); renderPrograms();
        renderParole(); renderTransactions();
    }

    function renderEvents() {
        const log = document.getElementById('event-log');
        log.innerHTML = state.events.slice(0,15).map(e=>`
            <div class="event-item ${e.type}">
                <div class="event-time">${e.time}</div>
                <div>${e.text}</div>
            </div>`).join('');
    }

    function renderPrisonMap() {
        const map = document.getElementById('prison-map');
        const cells = [];
        for (let i=0;i<8;i++) {
            for (let j=0;j<8;j++) cells.push(`<div class="map-cell ${Math.random()<0.3?'cell':''}">
                ${Math.random()<0.1?'üë§':Math.random()<0.05?'üëÆ':''}
            </div>`);
        }
        map.innerHTML = cells.join('');
    }

    function renderOverviewBuildings() {
        const el = document.getElementById('overview-buildings');
        const bMap = {cells:['üè¢','Cell Blocks'],cafeteria:['üçΩÔ∏è','Cafeteria'],gym:['üí™','Gym'],
            library:['üìö','Library'],workshop:['üîß','Workshop'],medical:['üè•','Medical'],
            chapel:['‚õ™','Chapel'],solitary:['üîí','Solitary']};
        el.innerHTML = Object.entries(bMap).map(([k,[icon,name]])=>
            state.buildings[k]>0?`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
                <span>${icon} ${name}</span><span style="color:#e94560">${state.buildings[k]}</span>
            </div>`:''
        ).join('');
    }

    function renderOverviewStaff() {
        const el = document.getElementById('overview-staff');
        const sMap = {guards:['üëÆ','Guards'],counselors:['üß†','Counselors'],medics:['üè•','Medics'],admins:['üìã','Admins']};
        el.innerHTML = Object.entries(sMap).map(([k,[icon,name]])=>`
            <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
                <span>${icon} ${name}</span><span style="color:#60a5fa">${state.staff[k]}</span>
            </div>`).join('');
    }

    function renderBuildings() {
        const BUILDINGS = [
            {id:'cells',icon:'üè¢',name:'Cell Block',base:5000,per:15,desc:'Houses 15 more inmates',key:'buildings'},
            {id:'cafeteria',icon:'üçΩÔ∏è',name:'Cafeteria',base:8000,desc:'Reduces hunger unrest',key:'buildings'},
            {id:'gym',icon:'üí™',name:'Gymnasium',base:12000,desc:'Reduces inmate unrest',key:'buildings'},
            {id:'library',icon:'üìö',name:'Library',base:10000,desc:'Enables education programs',key:'buildings'},
            {id:'workshop',icon:'üîß',name:'Workshop',base:15000,desc:'Enables vocational training',key:'buildings'},
            {id:'medical',icon:'üè•',name:'Medical Wing',base:20000,desc:'Improves inmate health',key:'buildings'},
            {id:'chapel',icon:'‚õ™',name:'Chapel',base:8000,desc:'Improves morale',key:'buildings'},
            {id:'solitary',icon:'üîí',name:'Solitary Block',base:12000,desc:'Houses violent inmates',key:'buildings'},
        ];
        const grid = document.getElementById('building-grid');
        grid.innerHTML = BUILDINGS.map(b=>{
            const count = state.buildings[b.id]||0;
            const cost = b.base + count*(b.base*0.5);
            return `<div class="building-card" onclick="game.buyBuilding('${b.id}',${b.base})">
                <div class="building-icon">${b.icon}</div>
                <div class="building-name">${b.name}</div>
                <div class="building-count">Owned: ${count}</div>
                <div style="font-size:11px;color:#888;margin-top:4px">${b.desc}</div>
                <div class="building-cost">üí∞ $${cost.toLocaleString()}</div>
            </div>`;
        }).join('');

        const EXPANSIONS = [
            {id:'minSecurity',icon:'üåø',name:'Min. Security Wing',cost:30000,desc:'25 additional beds, lower unrest'},
            {id:'deathRow',icon:'‚ö°',name:'Death Row',cost:50000,desc:'High security, max 10 inmates'},
            {id:'womens',icon:'üë©',name:"Women's Facility",cost:40000,desc:'30 beds, separate facility'},
        ];
        const expGrid = document.getElementById('expansion-grid');
        expGrid.innerHTML = EXPANSIONS.map(e=>{
            const count = state.expansions[e.id]||0;
            return `<div class="building-card" onclick="game.buyExpansion('${e.id}',${e.cost})">
                <div class="building-icon">${e.icon}</div>
                <div class="building-name">${e.name}</div>
                <div class="building-count">Owned: ${count}</div>
                <div style="font-size:11px;color:#888;margin-top:4px">${e.desc}</div>
                <div class="building-cost">üí∞ $${e.cost.toLocaleString()}</div>
            </div>`;
        }).join('');
    }

    function renderStaff() {
        const STAFF_TYPES = [
            {id:'guards',icon:'üëÆ',name:'Prison Guard',salary:800,desc:'Reduces unrest, prevents escapes',effect:'security'},
            {id:'counselors',icon:'üß†',name:'Counselor',salary:600,desc:'Runs rehab programs, reduces recidivism',effect:'rehab'},
            {id:'medics',icon:'üè•',name:'Medical Staff',salary:700,desc:'Treats inmate injuries',effect:'health'},
            {id:'admins',icon:'üìã',name:'Administrator',salary:500,desc:'Improves efficiency and reputation',effect:'admin'},
        ];
        const sl = document.getElementById('staff-list');
        sl.innerHTML = STAFF_TYPES.map(s=>`
            <div class="staff-card">
                <div class="staff-info">
                    <span class="staff-icon">${s.icon}</span>
                    <div class="staff-details">
                        <h4>${s.name}</h4>
                        <p>${s.desc}</p>
                        <div class="skill-stars">‚≠ê‚≠ê‚≠ê</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div class="staff-salary">$${s.salary}/day</div>
                    <div class="staff-controls">
                        <button class="btn small danger" onclick="game.fireStaff('${s.id}')">‚àí</button>
                        <span style="min-width:30px;text-align:center">${state.staff[s.id]}</span>
                        <button class="btn small success" onclick="game.hireStaff('${s.id}',${s.salary})">+</button>
                    </div>
                </div>
            </div>`).join('');
    }

    function renderInmates() {
        const el = document.getElementById('inmate-list');
        if (state.inmates.length === 0) {
            el.innerHTML = '<p style="color:#888;text-align:center;padding:40px">No inmates yet. Accept intake from the Overview tab.</p>';
            return;
        }
        el.innerHTML = state.inmates.map(inmate=>{
            const traitHTML = inmate.traits.map(t=>`<span class="trait-badge trait-${t}">${t}</span>`).join('');
            const riskColors = {low:'risk-low',medium:'risk-medium',high:'risk-high'};
            return `<div class="inmate-item">
                <div class="inmate-header">
                    <div>
                        <div class="inmate-name">üë§ ${inmate.name}</div>
                        <div style="font-size:12px;color:#888">${inmate.crime} ‚Ä¢ ${inmate.sentence}yr sentence ‚Ä¢ Age ${inmate.age}</div>
                        <div class="inmate-traits">${traitHTML}</div>
                    </div>
                    <span class="inmate-risk ${riskColors[inmate.risk]}">${inmate.risk.toUpperCase()}</span>
                </div>
                <div class="inmate-stats">
                    <div class="inmate-stat">
                        <div class="inmate-stat-label">Health</div>
                        <div class="inmate-stat-value">${inmate.health}%</div>
                        <div class="progress-bar"><div class="progress-fill health" style="width:${inmate.health}%"></div></div>
                    </div>
                    <div class="inmate-stat">
                        <div class="inmate-stat-label">Happiness</div>
                        <div class="inmate-stat-value">${inmate.happiness}%</div>
                        <div class="progress-bar"><div class="progress-fill happiness" style="width:${inmate.happiness}%"></div></div>
                    </div>
                    <div class="inmate-stat">
                        <div class="inmate-stat-label">Rehab</div>
                        <div class="inmate-stat-value">${inmate.rehab}%</div>
                        <div class="progress-bar"><div class="progress-fill rehab" style="width:${inmate.rehab}%"></div></div>
                    </div>
                    <div class="inmate-stat">
                        <div class="inmate-stat-label">Anger</div>
                        <div class="inmate-stat-value">${inmate.anger}%</div>
                        <div class="progress-bar"><div class="progress-fill unrest" style="width:${inmate.anger}%"></div></div>
                    </div>
                </div>
                <div class="inmate-actions">
                    <button class="btn small" onclick="game.punishInmate('${inmate.id}')">‚ö†Ô∏è Punish</button>
                    <button class="btn small secondary" onclick="game.sendToSolitary('${inmate.id}')">üîí Solitary</button>
                    <button class="btn small success" onclick="game.enrollInProgram('${inmate.id}')">üìö Program</button>
                </div>
            </div>`;
        }).join('');
    }

    function renderPrograms() {
        const PROGRAMS = [
            {id:'education',icon:'üìö',name:'Education Program',desc:'GED classes, reduces recidivism',cost:500,req:'library'},
            {id:'vocational',icon:'üîß',name:'Vocational Training',desc:'Job skills, generates income',cost:600,req:'workshop'},
            {id:'therapy',icon:'üß†',name:'Group Therapy',desc:'Anger management, lowers unrest',cost:400,req:'counselors'},
            {id:'drugRehab',icon:'üíä',name:'Drug Rehabilitation',desc:'Helps addicts, improves health',cost:700,req:'medical'},
            {id:'faithBased',icon:'‚õ™',name:'Faith-Based Program',desc:'Spiritual guidance, boosts morale',cost:200,req:'chapel'},
        ];
        const grid = document.getElementById('program-grid');
        grid.innerHTML = PROGRAMS.map(p=>{
            const active = state.activePrograms.has(p.id);
            const reqMet = p.req === 'counselors' ? state.staff.counselors > 0 : (state.buildings[p.req]||0) > 0;
            return `<div class="program-card ${active?'active':''}" onclick="game.toggleProgram('${p.id}',${p.cost})">
                <div class="program-icon">${p.icon}</div>
                <div class="program-name">${p.name}</div>
                <div class="program-desc">${p.desc}</div>
                <div class="program-cost">${active?'‚úÖ ACTIVE':'$'+p.cost+'/day'}</div>
                ${!reqMet?`<div style="font-size:10px;color:#fbbf24;margin-top:5px">Requires: ${p.req}</div>`:''}
            </div>`;
        }).join('');
    }

    function renderParole() {
        const paroleQ = document.getElementById('parole-queue');
        const eligible = state.inmates.filter(i=>i.servedYears >= i.sentence*0.3 && i.rehab > 50);
        if (eligible.length === 0) {
            paroleQ.innerHTML = '<p style="color:#888">No parole applications pending</p>';
        } else {
            paroleQ.innerHTML = eligible.slice(0,5).map(i=>`
                <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:8px">
                    <strong>${i.name}</strong><br>
                    <span style="font-size:12px;color:#888">Rehab: ${i.rehab}% ‚Ä¢ Served: ${i.servedYears} of ${i.sentence} yrs</span>
                    <div style="margin-top:8px;display:flex;gap:8px">
                        <button class="btn small success" onclick="game.grantParole('${i.id}')">‚úÖ Grant</button>
                        <button class="btn small danger" onclick="game.denyParole('${i.id}')">‚ùå Deny</button>
                    </div>
                </div>`).join('');
        }

        const appealsQ = document.getElementById('appeals-queue');
        const appealers = state.inmates.filter(i=>i.innocent && i.servedYears >= 1);
        if (appealers.length === 0) {
            appealsQ.innerHTML = '<p style="color:#888">No appeals pending</p>';
        } else {
            appealsQ.innerHTML = appealers.slice(0,3).map(i=>`
                <div style="background:rgba(255,215,0,0.05);border:1px solid rgba(255,215,0,0.2);padding:10px;border-radius:8px;margin-bottom:8px">
                    <strong>${i.name}</strong><br>
                    <span style="font-size:12px;color:#fbbf24">‚öñÔ∏è Claims innocence</span>
                    <div style="margin-top:8px;display:flex;gap:8px">
                        <button class="btn small success" onclick="game.upholdAppeal('${i.id}')">‚úÖ Uphold</button>
                        <button class="btn small danger" onclick="game.denyAppeal('${i.id}')">‚ùå Deny</button>
                    </div>
                </div>`).join('');
        }
    }

    function renderTransactions() {
        const el = document.getElementById('transaction-history');
        if (el) el.innerHTML = state.transactions.slice(0,15).map(t=>`<p style="color:#888;font-size:12px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">${t}</p>`).join('');
    }

    // --- GAME ACTIONS ---
    return {
        switchTab(tabId) {
            audioSystem.playClick();
            document.querySelectorAll('.nav-tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tabId));
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.toggle('active', t.id===tabId));
        },

        acceptIntake() {
            audioSystem.playClick();
            const cap = getCapacity();
            if (state.inmates.length >= cap) { this.showNotification('‚ö†Ô∏è Prison is at capacity!','warning'); return; }
            const count = rand(1,3);
            for (let i=0;i<count;i++) { if (state.inmates.length < cap) state.inmates.push(generateInmate()); }
            addEvent(`üì• Accepted ${count} new inmate(s). Population: ${state.inmates.length}/${cap}`,'info');
            audioSystem.playPurchase();
            this.showNotification(`üì• ${count} new inmate(s) arrived`,'success');
            renderUI();
        },

        nextDay() {
            audioSystem.playClick();
            state.day++;
            state.inmates.forEach(i=>{ i.servedYears += 1/365; });

            // Calculate finances
            const costs = getDailyCosts();
            const rev = getDailyRevenue();
            const net = rev.base + rev.workIncome - costs.staffCost - costs.foodCost - costs.programCost - costs.maint;
            state.money += net;
            if (net < 0) addEvent(`üí∏ Operating at a loss! Net: $${net.toLocaleString()}`,'danger');
            addTransaction(`Net income: ${net>=0?'+':''}$${Math.floor(net).toLocaleString()}`);

            // Update unrest
            const overcrowding = Math.max(0, state.inmates.length - getCapacity()*0.85) * 2;
            const guardDeficit = Math.max(0, state.inmates.length/10 - getGuardCount()) * 3;
            const programBonus = state.activePrograms.size * 3;
            const foodBonus = (state.policies.food - 3) * 2;
            state.unrest = Math.max(0, Math.min(100,
                state.unrest + overcrowding + guardDeficit - programBonus - foodBonus +
                (Math.random()*4-2)));

            // Update inmate stats
            state.inmates.forEach(i=>{
                i.anger = Math.max(0, Math.min(100, i.anger + (state.unrest>50?2:state.unrest<20?-1:0) + (Math.random()*2-1)));
                i.happiness = Math.max(0, Math.min(100, i.happiness + foodBonus + programBonus/2 - (overcrowding/10)));
                if (state.activePrograms.has('drugRehab') && i.traits.includes('addict')) i.rehab = Math.min(100, i.rehab+2);
                if (state.activePrograms.has('education')) i.rehab = Math.min(100, i.rehab+1);
                if (state.buildings.medical && state.staff.medics > 0) i.health = Math.min(100, i.health+1);
            });

            // Riot check
            if (!state.riotActive && state.unrest >= 85 && Math.random() < 0.3) {
                state.riotActive = true; state.riotDuration = 0; state.riotDamage = 0;
                addEvent('üö® RIOT STARTED! Prisoners have taken control of a wing!','danger');
                audioSystem.playRiot();
                this.showNotification('üö® RIOT IN PROGRESS!','riot');
            }
            if (state.riotActive) {
                state.riotDuration++; state.riotDamage += rand(500,2000);
                state.money -= rand(500,2000);
            }

            // Random events
            if (Math.random() < 0.15) this.randomEvent();

            // Reputation
            state.reputation = Math.max(0, Math.min(100,
                state.reputation + (state.activePrograms.size * 0.5) - (state.riotActive?2:0) + (state.unrest<20?0.5:-0.5)));

            // Autosave
            if (state.autosave && state.day % 5 === 0) this.saveGame(true);

            addEvent(`üìÖ Day ${state.day} ended. Balance: $${state.money.toLocaleString()}`,'info');
            renderUI();
        },

        randomEvent() {
            const events = [
                {text:'üëÆ A guard report shows suspicious activity. Morale drops slightly.',fn:()=>{},'type':'warning'},
                {text:'üì∫ Prison featured on news show. Reputation +5.',fn:()=>{state.reputation=Math.min(100,state.reputation+5);},'type':'success'},
                {text:'üíä Drug contraband discovered in cell block!',fn:()=>{state.contraband.drugs+=rand(1,5);},'type':'danger'},
                {text:'üî™ Fight broke out in the cafeteria. Unrest +5.',fn:()=>{state.unrest+=5;},'type':'danger'},
                {text:'üìã State inspection passed. Reputation +3.',fn:()=>{state.reputation+=3;},'type':'success'},
                {text:'üí∞ Federal grant received! +$5,000',fn:()=>{state.money+=5000;addTransaction('+$5,000 federal grant');},'type':'success'},
                {text:'üîë Contraband phone network discovered.',fn:()=>{state.contraband.phones+=rand(1,3);},'type':'warning'},
            ];
            const ev = choose(events);
            ev.fn(); addEvent(ev.text, ev.type);
        },

        buyBuilding(id, baseCost) {
            audioSystem.playClick();
            const count = state.buildings[id]||0;
            const cost = baseCost + count*(baseCost*0.5);
            if (state.money < cost) { this.showNotification('‚ùå Insufficient funds!','error'); audioSystem.playAlert(); return; }
            state.money -= cost;
            state.buildings[id] = count+1;
            addTransaction(`-$${cost.toLocaleString()} ${id} constructed`);
            addEvent(`üèóÔ∏è ${id} built for $${cost.toLocaleString()}`,'success');
            audioSystem.playPurchase();
            this.showNotification(`üèóÔ∏è Building constructed!`,'success');
            renderUI();
        },

        buyExpansion(id, cost) {
            audioSystem.playClick();
            if (state.money < cost) { this.showNotification('‚ùå Insufficient funds!','error'); return; }
            state.money -= cost;
            state.expansions[id] = (state.expansions[id]||0)+1;
            addTransaction(`-$${cost.toLocaleString()} expansion`);
            audioSystem.playPurchase();
            this.showNotification(`üîì Expansion complete!`,'success');
            renderUI();
        },

        hireStaff(type, salary) {
            audioSystem.playClick();
            if (state.money < salary*10) { this.showNotification('‚ùå Insufficient funds to hire!','error'); return; }
            state.money -= salary*10;
            state.staff[type]++;
            addTransaction(`-$${(salary*10).toLocaleString()} hired ${type}`);
            audioSystem.playPurchase();
            this.showNotification(`üëÆ New ${type} hired!`,'success');
            renderUI();
        },

        fireStaff(type) {
            audioSystem.playClick();
            if (state.staff[type] <= 0) return;
            state.staff[type]--;
            addEvent(`Staff reduction: 1 ${type} let go`,'warning');
            renderUI();
        },

        conductSearch(type='random') {
            audioSystem.playClick();
            const cost = type==='full'?2000:500;
            if (state.money < cost) { this.showNotification('‚ùå Insufficient funds!','error'); return; }
            state.money -= cost;
            const found = Math.floor(Math.random()*5);
            if (found > 0) {
                const types = ['weapons','drugs','phones','alcohol'];
                const t = choose(types); state.contraband[t] = Math.max(0, state.contraband[t]-1);
                addEvent(`üîç Search: Found ${found} contraband items`,'warning');
                state.unrest = Math.min(100, state.unrest+3);
                audioSystem.playAlert();
                this.showNotification(`üîç Found ${found} contraband items!`,'warning');
            } else {
                addEvent('üîç Search: Nothing found today','info');
                this.showNotification('üîç Search complete - nothing found','success');
            }
            addTransaction(`-$${cost} contraband search`);
            renderUI();
        },

        installScanner() {
            if (state.hasScanner) { this.showNotification('Scanner already installed!','warning'); return; }
            if (state.money < 10000) { this.showNotification('‚ùå Insufficient funds!','error'); return; }
            state.money -= 10000; state.hasScanner = true;
            addTransaction('-$10,000 body scanner installed');
            addEvent('üì° Body scanner installed. Contraband reduction active.','success');
            audioSystem.playPurchase();
            this.showNotification('üì° Body scanner installed!','success');
            renderUI();
        },

        deployRiotSquad() {
            audioSystem.playClick();
            if (state.money < 3000) { this.showNotification('‚ùå Insufficient funds!','error'); return; }
            state.money -= 3000;
            state.unrest = Math.max(0, state.unrest-15);
            addTransaction('-$3,000 riot squad deployed');
            addEvent('üëÆ Riot squad deployed. Unrest reduced.','success');
            audioSystem.playPurchase();
            this.showNotification('üëÆ Riot squad deployed!','success');
            renderUI();
        },

        increasePatrols() {
            state.extraPatrols = true;
            addEvent('üö∂ Extra patrols ordered (-$500/day)','info');
            this.showNotification('üö∂ Extra patrols ordered!','success');
        },

        suppressRiot(method) {
            audioSystem.playClick();
            if (!state.riotActive) return;
            let success = false;
            if (method === 'guards') {
                if (state.money < 5000) { this.showNotification('‚ùå Insufficient funds!','error'); return; }
                state.money -= 5000; success = true;
                addTransaction('-$5,000 riot suppression');
            } else if (method === 'negotiate') {
                success = Math.random() < 0.4;
                state.unrest = success ? Math.max(0,state.unrest-20) : Math.min(100,state.unrest+10);
            } else if (method === 'lockdown') {
                success = getGuardCount() >= 5;
                state.unrest = Math.max(0, state.unrest-10);
            }
            if (success) {
                state.riotActive = false; state.riotDuration = 0;
                addEvent('‚úÖ Riot suppressed successfully!','success');
                audioSystem.playPurchase();
                this.showNotification('‚úÖ Riot suppressed!','success');
            } else {
                addEvent('‚ùå Suppression failed! Riot continues.','danger');
                this.showNotification('‚ùå Suppression failed!','error');
            }
            renderUI();
        },

        toggleProgram(id, cost) {
            audioSystem.playClick();
            if (state.activePrograms.has(id)) {
                state.activePrograms.delete(id);
                addEvent(`üìö ${id} program deactivated`,'info');
                this.showNotification(`Program deactivated`,'warning');
            } else {
                if (state.money < cost*30) { this.showNotification('‚ùå Need 30 days of funding upfront!','error'); return; }
                state.activePrograms.add(id);
                addEvent(`üìö ${id} program activated`,'success');
                audioSystem.playPurchase();
                this.showNotification(`üìö Program activated!`,'success');
            }
            renderUI();
        },

        punishInmate(id) {
            audioSystem.playClick();
            const i = state.inmates.find(i=>i.id==id);
            if (!i) return;
            i.anger = Math.max(0, i.anger-15); i.happiness = Math.max(0, i.happiness-10);
            state.unrest = Math.min(100, state.unrest+2);
            addEvent(`‚ö†Ô∏è Inmate ${i.name} punished`,'warning');
            this.showNotification('‚ö†Ô∏è Inmate punished','warning');
            renderUI();
        },

        sendToSolitary(id) {
            audioSystem.playClick();
            if (!state.buildings.solitary) { this.showNotification('‚ùå No solitary block!','error'); return; }
            const i = state.inmates.find(i=>i.id==id);
            if (!i) return;
            i.anger = Math.max(0, i.anger-25); i.happiness = Math.max(0, i.happiness-20);
            addEvent(`üîí ${i.name} sent to solitary confinement`,'warning');
            this.showNotification('üîí Sent to solitary','warning');
            renderUI();
        },

        enrollInProgram(id) {
            const i = state.inmates.find(i=>i.id==id);
            if (!i) return;
            if (state.activePrograms.size === 0) { this.showNotification('‚ùå No active programs!','error'); return; }
            const prog = [...state.activePrograms][0];
            if (!i.inPrograms.includes(prog)) {
                i.inPrograms.push(prog); i.rehab = Math.min(100, i.rehab+5);
                addEvent(`üìö ${i.name} enrolled in ${prog}`,'success');
                this.showNotification(`üìö Enrolled in ${prog}!`,'success');
                renderUI();
            }
        },

        grantParole(id) {
            audioSystem.playClick();
            const idx = state.inmates.findIndex(i=>i.id==id);
            if (idx<0) return;
            const i = state.inmates.splice(idx,1)[0];
            state.paroleStats.approved++;
            addEvent(`‚úÖ ${i.name} granted parole after rehabilitation`,'success');
            audioSystem.playPurchase();
            this.showNotification(`‚úÖ ${i.name} paroled!`,'success');
            renderUI();
        },

        denyParole(id) {
            audioSystem.playClick();
            const i = state.inmates.find(i=>i.id==id);
            if (i) { state.paroleStats.denied++; i.anger=Math.min(100,i.anger+10); }
            addEvent(`‚ùå Parole denied`,'info');
            renderUI();
        },

        upholdAppeal(id) {
            audioSystem.playClick();
            const idx = state.inmates.findIndex(i=>i.id==id);
            if (idx<0) return;
            const i = state.inmates.splice(idx,1)[0];
            state.paroleStats.upheld++; state.paroleStats.wrongful++;
            state.reputation = Math.max(0, state.reputation-10);
            addEvent(`‚öñÔ∏è WRONGFUL CONVICTION! ${i.name} exonerated. Reputation damaged.`,'danger');
            audioSystem.playAlert();
            this.showNotification(`‚öñÔ∏è Wrongful conviction exposed!`,'error');
            renderUI();
        },

        denyAppeal(id) {
            audioSystem.playClick();
            const i = state.inmates.find(i=>i.id==id);
            if (i) i.anger = Math.min(100, i.anger+15);
            addEvent('‚öñÔ∏è Appeal denied','info');
            renderUI();
        },

        updatePolicy(type, val) {
            audioSystem.playClick();
            state.policies[type] = parseInt(val);
            const labels = {
                security: ['Minimum','Low','Medium','High','Maximum'],
                food: ['Poor','Basic','Standard','Good','Excellent'],
                work: v=>v<25?'Minimal':v<50?'Light':v<75?'Moderate':'Heavy'
            };
            if (labels[type]) {
                const disp = typeof labels[type]==='function'?labels[type](val):labels[type][val-1];
                const el = document.getElementById(type+'-value')||document.getElementById('security-value');
                if (el && type==='security') el.textContent = disp;
                if (type==='food') { const fe=document.getElementById('food-value'); if(fe) fe.textContent=disp; }
                if (type==='work') { const we=document.getElementById('work-value'); if(we) we.textContent=typeof labels[type]==='function'?labels[type](val):''; }
            }
            if (type==='rehabilitation') {
                const v=parseInt(val); const rv=document.getElementById('rehab-value');
                if(rv) rv.textContent=v<25?'Punishment':v<50?'Balanced-hard':v<75?'Balanced-soft':'Rehabilitation';
            }
            if (type==='cellQuality') {
                const q=['Bare','Basic','Decent','Comfortable','Premium'][val-1];
                const cq=document.getElementById('cell-quality-value'); if(cq) cq.textContent=q;
            }
        },

        saveGame(silent=false) {
            audioSystem.playClick();
            const save = {
                money:state.money, inmates:state.inmates, staff:state.staff,
                buildings:state.buildings, expansions:state.expansions,
                programs:[...state.activePrograms], policies:state.policies,
                unrest:state.unrest, reputation:state.reputation, day:state.day,
                paroleStats:state.paroleStats, contraband:state.contraband,
                hasScanner:state.hasScanner
            };
            localStorage.setItem('prisonTycoonSave', JSON.stringify(save));
            const el = document.getElementById('save-status');
            if(el) el.innerHTML = `<span style="color:#4ade80">‚úÖ Saved on Day ${state.day}</span>`;
            if (!silent) { this.showNotification('üíæ Game saved!','success'); }
        },

        loadGame() {
            const data = localStorage.getItem('prisonTycoonSave');
            if (!data) { this.showNotification('‚ùå No save found!','error'); return; }
            try {
                const save = JSON.parse(data);
                Object.assign(state, save);
                state.activePrograms = new Set(save.programs||[]);
                addEvent('üìÇ Game loaded successfully','success');
                audioSystem.playPurchase();
                this.showNotification('üìÇ Game loaded!','success');
                renderUI();
            } catch(e) { this.showNotification('‚ùå Save corrupted!','error'); }
        },

        newGame() {
            if (!confirm('Start a new game? All progress will be lost.')) return;
            state = {
                money:50000, inmates:[], staff:{guards:0,counselors:0,medics:0,admins:0},
                buildings:{cells:1,cafeteria:0,gym:0,library:0,workshop:0,medical:0,chapel:0,solitary:0},
                expansions:{minSecurity:0,deathRow:0,womens:0},
                programs:[], activePrograms:new Set(),
                policies:{security:3,rehabilitation:50,food:3,work:50,cellQuality:2},
                unrest:0, reputation:50, day:1,
                riotActive:false, riotDuration:0, riotDamage:0,
                contraband:{weapons:0,drugs:0,phones:0,alcohol:0},
                hasScanner:false, extraPatrols:false,
                paroleStats:{approved:0,denied:0,upheld:0,wrongful:0},
                paused:false, autosave:true,
                events:[{time:'Day 1 - Morning',text:'Prison facility established. Welcome, Warden!',type:'info'}],
                transactions:['Day 1: Initial funding received (+$50,000)']
            };
            this.showNotification('üîÑ New game started!','success');
            renderUI();
        },

        toggleAutosave(v) { state.autosave = v; },

        showModal(title, content, actions=[]) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            const actEl = document.getElementById('modal-actions');
            actEl.innerHTML = actions.map(a=>`<button class="btn ${a.cls||''}" onclick="${a.action}">${a.label}</button>`).join('')
                + '<button class="btn secondary" onclick="game.closeModal()">Close</button>';
            document.getElementById('modal').classList.add('active');
        },

        closeModal() {
            document.getElementById('modal').classList.remove('active');
        },

        showNotification(msg, type='info') {
            const el = document.getElementById('notification');
            el.textContent = msg; el.className = `notification ${type} show`;
            setTimeout(()=>el.classList.remove('show'), 3000);
        }
    };
})();

// ================================================
// KEYBOARD SHORTCUTS
// ================================================
document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    const tabs = ['overview','buildings','staff','inmates','programs','parole','security','policies','finance','settings'];
    const key = e.key;
    if (key >= '1' && key <= '9') game.switchTab(tabs[parseInt(key)-1]);
    if (key === '0') game.switchTab('settings');
    if (key.toLowerCase() === 'm') audioSystem.toggle();
    if (key.toLowerCase() === 's' && !e.ctrlKey) game.saveGame();
    if (key.toLowerCase() === 'l') game.loadGame();
    if (key.toLowerCase() === 'n') game.nextDay();
    if (key === '?') {
        const hint = document.getElementById('keyboard-hint');
        if (hint) hint.style.display = hint.style.display==='none'?'block':'none';
    }
    if (key === 'Escape') game.closeModal();
});

// ================================================
// INIT
// ================================================
window.addEventListener('load', () => {
    renderUI();
    // Close hint after 8 seconds
    setTimeout(() => {
        const hint = document.getElementById('keyboard-hint');
        if (hint) hint.style.display = 'none';
    }, 8000);
});
    </script>
</body>
</html>
