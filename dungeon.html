<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dungeon Crawler Roguelike</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #000; color: #ccc; font-family: 'Courier New', monospace; display: flex; height: 100vh; overflow: hidden; }
#game { flex: 1; display: flex; flex-direction: column; }
canvas { flex: 1; display: block; }
#log { height: 80px; overflow-y: auto; padding: 4px 10px; background: #060606; border-top: 1px solid #222; font-size: 11px; line-height: 1.6; }
#log .msg { color: #aaa; }
#log .dmg { color: #f88; }
#log .heal { color: #8f8; }
#log .item { color: #ff0; }
#log .sys { color: #88f; }
#sidebar { width: 180px; background: #080808; border-left: 1px solid #222; padding: 12px; }
#sidebar h2 { color: #fa0; margin-bottom: 8px; font-size: 14px; }
.stat-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 12px; }
.stat-row .label { color: #888; }
.stat-row .val { color: #fff; }
#hpBar, #xpBar { height: 8px; border-radius: 4px; margin: 2px 0 6px; }
#hpBar { background: linear-gradient(to right, #f44, #844); border: 1px solid #644; }
#xpBar { background: linear-gradient(to right, #44f, #228); border: 1px solid #226; }
.bar-bg { background: #222; border-radius: 4px; overflow: hidden; margin: 2px 0 6px; height: 8px; }
#inv { margin-top: 10px; border-top: 1px solid #222; padding-top: 8px; }
#inv h3 { color: #8af; font-size: 11px; margin-bottom: 4px; }
.inv-item { font-size: 10px; padding: 2px 4px; cursor: pointer; border-radius: 2px; }
.inv-item:hover { background: #1a1a2a; }
.inv-item.equipped { color: #8f8; }
#skills { margin-top: 8px; border-top: 1px solid #222; padding-top: 8px; }
#skills h3 { color: #af8; font-size: 11px; margin-bottom: 4px; }
.skill-row { font-size: 10px; color: #888; display: flex; justify-content: space-between; }
#msg-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
#msg-overlay .box { background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 20px 30px; text-align: center; border-radius: 6px; }
#msg-overlay h1 { font-size: 28px; margin-bottom: 8px; }
#msg-overlay p { color: #888; font-size: 13px; }
#musicBtn { position: fixed; bottom: 90px; right: 190px; background: #0a0a15; border: 1px solid #448; color: #88f; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 11px; }
</style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>
  <div id="log"><div class="msg sys">Welcome to the dungeon. Use arrow keys or WASD to move. Press . to wait.</div></div>
</div>
<div id="sidebar">
  <h2>‚öîÔ∏è Dungeon</h2>
  <div class="stat-row"><span class="label">Floor</span><span class="val" id="floorEl">1</span></div>
  <div class="stat-row"><span class="label">HP</span><span class="val" id="hpEl">10/10</span></div>
  <div class="bar-bg"><div id="hpBar" style="width:100%;height:100%"></div></div>
  <div class="stat-row"><span class="label">XP</span><span class="val" id="xpEl">0/10</span></div>
  <div class="bar-bg"><div id="xpBar" style="width:0%;height:100%"></div></div>
  <div class="stat-row"><span class="label">Level</span><span class="val" id="levelEl">1</span></div>
  <div class="stat-row"><span class="label">ATK</span><span class="val" id="atkEl">3</span></div>
  <div class="stat-row"><span class="label">DEF</span><span class="val" id="defEl">0</span></div>
  <div class="stat-row"><span class="label">Gold</span><span class="val" id="goldEl">0</span></div>
  <div id="inv">
    <h3>Inventory (i)</h3>
    <div id="invList"></div>
  </div>
  <div id="skills">
    <h3>Keys</h3>
    <div class="skill-row"><span>Move</span><span>WASD/‚Üë‚Üì‚Üê‚Üí</span></div>
    <div class="skill-row"><span>Wait</span><span>. or Z</span></div>
    <div class="skill-row"><span>Pickup</span><span>G or space</span></div>
    <div class="skill-row"><span>Use item</span><span>click inv</span></div>
    <div class="skill-row"><span>Next floor</span><span>E on stairs</span></div>
  </div>
</div>
<div id="msg-overlay" style="display:none">
  <div class="box">
    <h1 id="overlayTitle">DUNGEON</h1>
    <p id="overlayText">Press any key to begin</p>
  </div>
</div>
<button id="musicBtn">üéµ Music</button>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const CELL = 20;
let COLS, ROWS;

function resize() {
  canvas.width = window.innerWidth - 180;
  canvas.height = window.innerHeight - 80;
  COLS = Math.floor(canvas.width/CELL);
  ROWS = Math.floor(canvas.height/CELL);
}
resize();

// Tile types
const T = { WALL:0, FLOOR:1, DOOR:2, STAIRS:3, WATER:4 };
const COLORS = { [T.WALL]:'#2a1a2a', [T.FLOOR]:'#111118', [T.DOOR]:'#8a5020', [T.STAIRS]:'#3a3a8a', [T.WATER]:'#101a2a' };

let map, rooms, entities, items;
let player, floor = 1, turn = 0;
let gameOver = false, gameWon = false;
let gameStarted = false;
let fov; // field of view: 0=unseen, 1=seen, 2=visible

// Player stats
function newPlayer() {
  return {
    x:0, y:0, hp:20, maxHp:20, atk:4, def:0, xp:0, xpNext:10,
    level:1, gold:0, inventory:[], char:'@', color:'#fff',
    isPlayer:true
  };
}

function generateMap() {
  map = Array.from({length:ROWS}, ()=>new Uint8Array(COLS).fill(T.WALL));
  rooms = [];
  fov = Array.from({length:ROWS}, ()=>new Uint8Array(COLS));
  entities = [];
  items = [];
  // BSP room generation
  const minSize=4, maxSize=12, maxRooms=15;
  for(let attempt=0; attempt<200&&rooms.length<maxRooms; attempt++) {
    const rw=minSize+Math.floor(Math.random()*(maxSize-minSize));
    const rh=minSize+Math.floor(Math.random()*(maxSize-minSize));
    const rx=1+Math.floor(Math.random()*(COLS-rw-2));
    const ry=1+Math.floor(Math.random()*(ROWS-rh-2));
    // Check overlap
    let ok=true;
    for(const r of rooms) {
      if(rx<r.x+r.w+2&&rx+rw+2>r.x&&ry<r.y+r.h+2&&ry+rh+2>r.y){ok=false;break;}
    }
    if(!ok) continue;
    rooms.push({x:rx,y:ry,w:rw,h:rh,cx:rx+Math.floor(rw/2),cy:ry+Math.floor(rh/2)});
    for(let y=ry;y<ry+rh;y++) for(let x=rx;x<rx+rw;x++) map[y][x]=T.FLOOR;
  }
  // Connect rooms with corridors
  for(let i=1;i<rooms.length;i++) {
    const a=rooms[i-1], b=rooms[i];
    let cx=a.cx, cy=a.cy;
    while(cx!==b.cx){map[cy][cx]=T.FLOOR;cx+=cx<b.cx?1:-1;}
    while(cy!==b.cy){map[cy][cx]=T.FLOOR;cy+=cy<b.cy?1:-1;}
  }
  // Add water
  for(let y=1;y<ROWS-1;y++) for(let x=1;x<COLS-1;x++) {
    if(map[y][x]===T.FLOOR&&Math.random()<0.02) map[y][x]=T.WATER;
  }
  // Add stairs
  const lastRoom=rooms[rooms.length-1];
  map[lastRoom.cy][lastRoom.cx]=T.STAIRS;
  // Place player
  const firstRoom=rooms[0];
  player.x=firstRoom.cx; player.y=firstRoom.cy;
  // Place monsters
  const monsterCount=rooms.length*2+floor*2;
  const MONSTERS=[
    {char:'g',color:'#5a3',name:'Goblin',hp:8,atk:3,def:0,xp:5,gold:2},
    {char:'o',color:'#7a4',name:'Orc',hp:16,atk:5,def:1,xp:12,gold:5},
    {char:'s',color:'#a55',name:'Skeleton',hp:12,atk:4,def:2,xp:10,gold:3},
    {char:'t',color:'#383',name:'Troll',hp:30,atk:8,def:2,xp:25,gold:10},
    {char:'D',color:'#f80',name:'Dragon',hp:50,atk:12,def:4,xp:60,gold:30},
    {char:'V',color:'#a0a',name:'Vampire',hp:25,atk:7,def:1,xp:35,gold:15},
  ];
  for(let i=0;i<monsterCount;i++) {
    const room=rooms[1+Math.floor(Math.random()*(rooms.length-1))];
    const mx=room.x+1+Math.floor(Math.random()*(room.w-2));
    const my=room.y+1+Math.floor(Math.random()*(room.h-2));
    if(map[my][mx]!==T.FLOOR) continue;
    const tier=Math.min(Math.floor(floor/2),MONSTERS.length-1);
    const md=MONSTERS[Math.floor(Math.random()*(tier+1))];
    entities.push({x:mx,y:my,...JSON.parse(JSON.stringify(md)),maxHp:md.hp*(1+floor*0.2)|0,hp:md.hp*(1+floor*0.2)|0});
  }
  // Place items
  const ITEMS=[
    {char:'!',color:'#f44',name:'Health Potion',type:'potion',value:15},
    {char:'/',color:'#ff8',name:'Short Sword',type:'weapon',atk:2},
    {char:']',color:'#aaa',name:'Leather Armor',type:'armor',def:1},
    {char:'$',color:'#fd0',name:'Gold Pile',type:'gold',value:15},
    {char:'?',color:'#a8f',name:'Magic Scroll',type:'scroll',effect:'map'},
    {char:'*',color:'#f8f',name:'Gem',type:'gold',value:30},
    {char:'+',color:'#8f8',name:'Shield',type:'armor',def:2},
    {char:'^',color:'#f8a',name:'Poison Dart',type:'ammo',value:10},
  ];
  const itemCount=rooms.length+3;
  for(let i=0;i<itemCount;i++) {
    const room=rooms[Math.floor(Math.random()*rooms.length)];
    const ix=room.x+1+Math.floor(Math.random()*(room.w-2));
    const iy=room.y+1+Math.floor(Math.random()*(room.h-2));
    if(map[iy][ix]!==T.FLOOR) continue;
    const id=ITEMS[Math.floor(Math.random()*ITEMS.length)];
    items.push({x:ix,y:iy,...JSON.parse(JSON.stringify(id))});
  }
  computeFOV();
}

function computeFOV() {
  // Reset visible
  for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) if(fov[y][x]===2) fov[y][x]=1;
  const range=8;
  for(let angle=0;angle<360;angle+=1) {
    const rad=angle*Math.PI/180;
    let rx=player.x, ry=player.y;
    for(let r=0;r<range;r++) {
      rx+=Math.cos(rad); ry+=Math.sin(rad);
      const ix=Math.round(rx), iy=Math.round(ry);
      if(ix<0||ix>=COLS||iy<0||iy>=ROWS) break;
      fov[iy][ix]=2;
      if(map[iy][ix]===T.WALL) break;
    }
  }
}

function canWalk(x,y) {
  if(x<0||x>=COLS||y<0||y>=ROWS) return false;
  return map[y][x]!==T.WALL;
}

function entityAt(x,y) {
  return entities.find(e=>e.x===x&&e.y===y);
}
function itemAt(x,y) {
  return items.find(i=>i.x===x&&i.y===y);
}

function log(msg, cls='msg') {
  const logEl=document.getElementById('log');
  const div=document.createElement('div');
  div.className=cls; div.textContent=msg;
  logEl.appendChild(div);
  logEl.scrollTop=logEl.scrollHeight;
  if(logEl.children.length>50) logEl.removeChild(logEl.firstChild);
}

function attack(attacker, defender) {
  const dmg=Math.max(1, attacker.atk - defender.def + Math.floor(Math.random()*3)-1);
  defender.hp-=dmg;
  if(attacker.isPlayer) { playHit(); log(`You hit ${defender.name} for ${dmg} dmg.`,'dmg'); }
  else { playHurt(); log(`${attacker.name} hits you for ${dmg} dmg.`,'dmg'); }
  if(defender.hp<=0) {
    if(defender.isPlayer){gameOver=true;playDeath();log('You died!','sys');}
    else {
      log(`${defender.name} defeated! +${defender.xp} XP, +${defender.gold} gold`,'item');
      player.xp+=defender.xp; player.gold+=defender.gold;
      entities=entities.filter(e=>e!==defender);
      playKill();
      checkLevelUp();
    }
  }
}

function checkLevelUp() {
  if(player.xp>=player.xpNext) {
    player.level++;
    player.xp-=player.xpNext;
    player.xpNext=Math.floor(player.xpNext*1.5);
    player.maxHp+=5; player.hp=Math.min(player.hp+8,player.maxHp);
    player.atk+=1;
    log(`LEVEL UP! Now level ${player.level}. HP+5, ATK+1`,'sys');
    playLevelUp();
  }
}

function pickupItem(item) {
  if(item.type==='gold'){
    player.gold+=item.value;
    log(`Picked up ${item.value} gold.`,'item');
  } else {
    player.inventory.push(item);
    log(`Picked up ${item.name}.`,'item');
  }
  items=items.filter(i=>i!==item);
  playPickup();
}

function useItem(item) {
  if(item.type==='potion'){
    player.hp=Math.min(player.maxHp,player.hp+item.value);
    log(`Used ${item.name}. HP +${item.value}`,'heal');
    player.inventory=player.inventory.filter(i=>i!==item);
  } else if(item.type==='weapon'){
    const old=player.inventory.find(i=>i.type==='weapon'&&i.equipped);
    if(old){old.equipped=false;player.atk-=old.atk;}
    item.equipped=!item.equipped;
    player.atk+=item.equipped?item.atk:-item.atk;
    log(`${item.equipped?'Equipped':'Unequipped'} ${item.name}.`,'item');
  } else if(item.type==='armor'){
    const old=player.inventory.find(i=>i.type==='armor'&&i.equipped);
    if(old){old.equipped=false;player.def-=old.def;}
    item.equipped=!item.equipped;
    player.def+=item.equipped?item.def:-item.def;
    log(`${item.equipped?'Equipped':'Unequipped'} ${item.name}.`,'item');
  } else if(item.type==='scroll'){
    if(item.effect==='map'){
      for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) if(fov[y][x]<1) fov[y][x]=1;
      log('The map is revealed!','sys');
      player.inventory=player.inventory.filter(i=>i!==item);
    }
  }
  updateSidebar();
}

function movePlayer(dx, dy) {
  if(gameOver||gameWon||!gameStarted) return;
  const nx=player.x+dx, ny=player.y+dy;
  const enemy=entityAt(nx,ny);
  if(enemy){attack(player,enemy);}
  else if(canWalk(nx,ny)){
    player.x=nx; player.y=ny;
    // Check stairs
    if(map[ny][nx]===T.STAIRS){
      log(`Descending to floor ${floor+1}...`,'sys');
      floor++; generateMap();
      if(floor>=10){gameWon=true; playWin();}
      document.getElementById('floorEl').textContent=floor;
    }
    // Auto-pickup gold
    const it=itemAt(nx,ny);
    if(it&&it.type==='gold') pickupItem(it);
    computeFOV();
    playStep();
  }
  // Enemy turn
  doEnemyTurns();
  updateSidebar();
}

function doEnemyTurns() {
  entities.forEach(e=>{
    if(Math.abs(e.x-player.x)<=1&&Math.abs(e.y-player.y)<=1){
      attack(e,player);
    } else {
      // Simple pathfinding towards player
      const dx=player.x-e.x, dy=player.y-e.y;
      const ax=Math.abs(dx),ay=Math.abs(dy);
      if(fov[e.y]&&fov[e.y][e.x]>=1&&(ax+ay)<15){
        let mx=0,my=0;
        if(ax>=ay) mx=dx>0?1:-1; else my=dy>0?1:-1;
        const nx=e.x+mx,ny=e.y+my;
        if(canWalk(nx,ny)&&!entityAt(nx,ny)&&!(nx===player.x&&ny===player.y)){e.x=nx;e.y=ny;}
        else {
          const nx2=e.x+(dy>0?0:0),ny2=e.y+(dx>0?0:0);
          if(mx===0){if(canWalk(e.x+1,e.y)&&!entityAt(e.x+1,e.y)){e.x++;}else if(canWalk(e.x-1,e.y)&&!entityAt(e.x-1,e.y)){e.x--;}}
          else {if(canWalk(e.x,e.y+1)&&!entityAt(e.x,e.y+1)){e.y++;}else if(canWalk(e.x,e.y-1)&&!entityAt(e.x,e.y-1)){e.y--;}}
        }
      }
    }
  });
  if(gameOver) {
    showOverlay('YOU DIED', `Floor ${floor} | Level ${player.level} | Gold ${player.gold}\n\nRefresh to try again`, '#f44');
  }
}

function updateSidebar() {
  document.getElementById('hpEl').textContent=`${player.hp}/${player.maxHp}`;
  document.getElementById('hpBar').style.width=`${Math.max(0,player.hp/player.maxHp*100)}%`;
  document.getElementById('xpEl').textContent=`${player.xp}/${player.xpNext}`;
  document.getElementById('xpBar').style.width=`${player.xp/player.xpNext*100}%`;
  document.getElementById('levelEl').textContent=player.level;
  document.getElementById('atkEl').textContent=player.atk;
  document.getElementById('defEl').textContent=player.def;
  document.getElementById('goldEl').textContent=player.gold;
  const invEl=document.getElementById('invList');
  invEl.innerHTML='';
  player.inventory.forEach(item=>{
    const div=document.createElement('div');
    div.className='inv-item'+(item.equipped?' equipped':'');
    div.textContent=`${item.char} ${item.name}${item.equipped?' ‚úì':''}`;
    div.style.color=item.color;
    div.addEventListener('click',()=>useItem(item));
    invEl.appendChild(div);
  });
}

const VIEW_W = Math.min(COLS, 40), VIEW_H = Math.min(ROWS, 30);

function draw() {
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const vpX=Math.max(0,Math.min(COLS-VIEW_W,player.x-Math.floor(VIEW_W/2)));
  const vpY=Math.max(0,Math.min(ROWS-VIEW_H,player.y-Math.floor(VIEW_H/2)));
  for(let y=0;y<VIEW_H&&y+vpY<ROWS;y++) {
    for(let x=0;x<VIEW_W&&x+vpX<COLS;x++) {
      const mx=x+vpX,my=y+vpY;
      const vis=fov[my][mx];
      if(vis===0) continue;
      const t=map[my][mx];
      let col=COLORS[t];
      if(vis===1) col=dimColor(col,0.35);
      ctx.fillStyle=col;
      ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
      if(t===T.STAIRS){
        ctx.fillStyle=vis===2?'#88f':'#446';
        ctx.font=`${CELL*0.8}px Courier New`;ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('>',x*CELL+CELL/2,y*CELL+CELL/2+1);
      }
    }
  }
  // Items
  items.forEach(it=>{
    const sx=it.x-vpX, sy=it.y-vpY;
    if(sx<0||sx>=VIEW_W||sy<0||sy>=VIEW_H) return;
    if(fov[it.y][it.x]<2) return;
    ctx.fillStyle=it.color;
    ctx.font=`${CELL*0.8}px Courier New`;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(it.char,sx*CELL+CELL/2,sy*CELL+CELL/2+1);
  });
  // Entities
  entities.forEach(e=>{
    const sx=e.x-vpX, sy=e.y-vpY;
    if(sx<0||sx>=VIEW_W||sy<0||sy>=VIEW_H) return;
    if(!fov[e.y]||fov[e.y][e.x]<2) return;
    ctx.fillStyle=e.color;
    ctx.font=`${CELL*0.8}px Courier New`;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(e.char,sx*CELL+CELL/2,sy*CELL+CELL/2+1);
    // HP bar
    const bw=CELL-2;
    ctx.fillStyle='#300';ctx.fillRect(sx*CELL+1,sy*CELL,bw,3);
    ctx.fillStyle='#f44';ctx.fillRect(sx*CELL+1,sy*CELL,bw*e.hp/e.maxHp,3);
  });
  // Player
  const px=player.x-vpX, py=player.y-vpY;
  if(px>=0&&px<VIEW_W&&py>=0&&py<VIEW_H){
    ctx.shadowBlur=8;ctx.shadowColor='#fff4';
    ctx.fillStyle='#fff';
    ctx.font=`bold ${CELL*0.85}px Courier New`;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('@',px*CELL+CELL/2,py*CELL+CELL/2+1);
    ctx.shadowBlur=0;
  }
  ctx.textAlign='left';ctx.textBaseline='alphabetic';
  // Item on floor indicator
  const it=itemAt(player.x,player.y);
  if(it&&it.type!=='gold'){
    ctx.fillStyle='#ff0';ctx.font='11px Courier New';
    ctx.fillText(`[G] Pick up: ${it.name}`,6,canvas.height-6);
  }
  if(!gameStarted){
    ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fa0';ctx.font='bold 36px Courier New';ctx.textAlign='center';
    ctx.fillText('‚öîÔ∏è DUNGEON',canvas.width/2,canvas.height/2-20);
    ctx.fillStyle='#888';ctx.font='14px Courier New';
    ctx.fillText('Press any key to begin your quest',canvas.width/2,canvas.height/2+20);
    ctx.fillText('Reach floor 10 to win!',canvas.width/2,canvas.height/2+45);
    ctx.textAlign='left';
  }
}

function dimColor(hex,factor) {
  const r=parseInt(hex.slice(1,3),16)*factor;
  const g=parseInt(hex.slice(3,5),16)*factor;
  const b=parseInt(hex.slice(5,7),16)*factor;
  return `rgb(${r|0},${g|0},${b|0})`;
}

function showOverlay(title,text,color='#fa0'){
  const ov=document.getElementById('msg-overlay');
  document.getElementById('overlayTitle').textContent=title;
  document.getElementById('overlayTitle').style.color=color;
  document.getElementById('overlayText').textContent=text;
  ov.style.display='flex';
}

document.addEventListener('keydown',e=>{
  if(!gameStarted){
    gameStarted=true;
    document.getElementById('msg-overlay').style.display='none';
    return;
  }
  const dirs={'ArrowUp':[0,-1],'ArrowDown':[0,1],'ArrowLeft':[-1,0],'ArrowRight':[1,0],
    'w':[0,-1],'s':[0,1],'a':[-1,0],'d':[1,0],
    'W':[0,-1],'S':[0,1],'A':[-1,0],'D':[1,0]};
  if(dirs[e.key]){e.preventDefault();const[dx,dy]=dirs[e.key];movePlayer(dx,dy);}
  if(e.key==='.'||e.key==='z'||e.key==='Z'){doEnemyTurns();} // wait
  if(e.key==='g'||e.key==='G'||e.key===' '){e.preventDefault();const it=itemAt(player.x,player.y);if(it)pickupItem(it);}
  if(e.key==='e'||e.key==='E'){if(map[player.y][player.x]===T.STAIRS){movePlayer(0,0);}}
  if(e.key==='m'||e.key==='M') document.getElementById('musicBtn').click();
});

// Audio
let audioCtx=null,musicOn=false,musicNodes=[];
function initA(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
const _s=(f,t,v=0.08,type='square',dur=0.1)=>{initA();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type=type;o.frequency.value=f;o.frequency.linearRampToValueAtTime(t,audioCtx.currentTime+dur);g.gain.value=v;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur+0.05);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+dur+0.1);};
function playStep(){initA();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=80;g.gain.value=0.02;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.05);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.06);}
function playHit(){_s(330,220,0.1,'sawtooth',0.15);}
function playHurt(){_s(200,150,0.12,'sawtooth',0.2);}
function playKill(){[440,550,660].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.value=f;g.gain.value=0.08;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.15);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+i*0.05);o.stop(audioCtx.currentTime+0.2+i*0.05);});}
function playPickup(){_s(660,880,0.06,'triangle',0.1);}
function playLevelUp(){[523,659,784,1047].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.value=0.1;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.25);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+i*0.1);o.stop(audioCtx.currentTime+0.3+i*0.1);});}
function playDeath(){[440,330,220,165].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.value=f;g.gain.value=0.1;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.4);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+i*0.2);o.stop(audioCtx.currentTime+0.5+i*0.2);});}
function playWin(){[523,659,784,880,1047].forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.value=0.12;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.5);o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+i*0.12);o.stop(audioCtx.currentTime+0.6+i*0.12);});}
function startMusic(){
  initA();stopMusic();
  const m=audioCtx.createGain();m.gain.value=0.15;m.connect(audioCtx.destination);
  musicNodes.push(m);
  [[55,0.06],[73.4,0.04],[82.5,0.03]].forEach(([f,v])=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain(),filt=audioCtx.createBiquadFilter();
    o.type='sawtooth';o.frequency.value=f;filt.type='lowpass';filt.frequency.value=250;g.gain.value=v;
    const lfo=audioCtx.createOscillator(),lg=audioCtx.createGain();
    lfo.frequency.value=0.07;lg.gain.value=v*0.4;
    lfo.connect(lg);lg.connect(g.gain);lfo.start();
    o.connect(filt);filt.connect(g);g.connect(m);o.start();
    musicNodes.push(o,g,filt,lfo,lg);
  });
  // Heartbeat
  const hb=()=>{if(!musicOn)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=50;g.gain.setValueAtTime(0.1,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);o.connect(g);g.connect(m);o.start();o.stop(audioCtx.currentTime+0.2);setTimeout(()=>{if(!musicOn)return;const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.type='sine';o2.frequency.value=45;g2.gain.setValueAtTime(0.08,audioCtx.currentTime);g2.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);o2.connect(g2);g2.connect(m);o2.start();o2.stop(audioCtx.currentTime+0.2);setTimeout(hb,1500);},200);};
  hb();
}
function stopMusic(){musicNodes.forEach(n=>{try{n.stop?.();n.disconnect?.();}catch(e){}});musicNodes=[];}
document.getElementById('musicBtn').addEventListener('click',()=>{
  musicOn=!musicOn;
  document.getElementById('musicBtn').textContent=musicOn?'üéµ Music ON':'üéµ Music';
  if(musicOn)startMusic();else stopMusic();
});

window.addEventListener('resize',()=>{resize();computeFOV();});

player=newPlayer();
generateMap();
updateSidebar();

function loop(){draw();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
