<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cellular Automata Explorer</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a12; color: #ddd; font-family: 'Courier New', monospace; display: flex; height: 100vh; overflow: hidden; }
#sidebar { width: 220px; background: rgba(0,0,0,0.85); border-right: 1px solid #2a2a3a; padding: 12px; overflow-y: auto; flex-shrink: 0; }
#main { flex: 1; display: flex; flex-direction: column; }
canvas { flex: 1; display: block; cursor: crosshair; }
#sidebar h2 { color: #adf; margin-bottom: 10px; font-size: 14px; }
.section { margin-bottom: 12px; border-bottom: 1px solid #222; padding-bottom: 10px; }
.section h3 { color: #8ac; font-size: 11px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
.rule-info { font-size: 11px; color: #aaa; margin-bottom: 4px; }
.rule-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 4px 6px; border-radius: 3px; font-size: 12px; font-family: inherit; }
.rule-input:focus { outline: none; border-color: #5af; }
.btn-row { display: flex; flex-wrap: wrap; gap: 3px; margin: 4px 0; }
button { background: #1a1a2e; border: 1px solid #333; color: #ccc; padding: 3px 7px; border-radius: 3px; cursor: pointer; font-size: 10px; }
button:hover { background: #2a2a4e; border-color: #5af; color: #fff; }
button.active { background: #1a3a5e; border-color: #5af; color: #5af; }
.preset-btn { font-size: 10px; padding: 3px 5px; }
#cellSize-row label { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; }
#cellSize-row input { width: 100%; accent-color: #5af; }
#generationEl { color: #fa0; font-size: 11px; }
#popEl { color: #4f4; font-size: 11px; }
#statusBar { height: 24px; background: #050508; border-top: 1px solid #1a1a2a; display: flex; align-items: center; padding: 0 10px; gap: 20px; font-size: 11px; color: #666; }
select { background: #111; border: 1px solid #333; color: #ddd; padding: 3px 5px; font-size: 11px; border-radius: 3px; width: 100%; margin: 2px 0; }
#musicBtn { position: fixed; bottom: 30px; right: 10px; background: #1a1a2e; border: 1px solid #5af; color: #5af; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 11px; }
.color-row { display: flex; gap: 4px; align-items: center; font-size: 11px; color: #aaa; }
.color-row input[type=color] { width: 30px; height: 20px; border: none; background: none; cursor: pointer; }
</style>
</head>
<body>
<div id="sidebar">
  <h2>üî¨ Cellular Automata</h2>
  <div class="section">
    <h3>Rule Type</h3>
    <select id="ruleType">
      <option value="life">Life-like (B/S)</option>
      <option value="wireworld">Wireworld</option>
      <option value="brian">Brian's Brain</option>
      <option value="langton">Langton's Ant</option>
      <option value="seeds">Seeds</option>
      <option value="daynight">Day & Night</option>
    </select>
  </div>
  <div class="section" id="bsSection">
    <h3>B/S Notation</h3>
    <div class="rule-info">Birth (B): alive if 0 neighbors</div>
    <input class="rule-input" id="birthInput" value="3" maxlength="9" placeholder="e.g. 3">
    <div class="rule-info">Survive (S): stays alive if</div>
    <input class="rule-input" id="surviveInput" value="23" maxlength="9" placeholder="e.g. 23">
    <div class="btn-row">
      <button onclick="applyBS()">Apply</button>
    </div>
    <h3 style="margin-top:8px;">Presets</h3>
    <div class="btn-row">
      <button class="preset-btn active" data-b="3" data-s="23">Conway</button>
      <button class="preset-btn" data-b="36" data-s="23">HighLife</button>
      <button class="preset-btn" data-b="3678" data-s="34678">Day&Night</button>
      <button class="preset-btn" data-b="2" data-s="">Seeds</button>
      <button class="preset-btn" data-b="3" data-s="012345678">Life34</button>
      <button class="preset-btn" data-b="36" data-s="125">2x2</button>
      <button class="preset-btn" data-b="34" data-s="45">Maze</button>
      <button class="preset-btn" data-b="3" data-s="1234">Coral</button>
    </div>
  </div>
  <div class="section">
    <h3>Speed</h3>
    <div id="cellSize-row">
      <label><span>Steps/frame</span><span id="speedVal">4</span></label>
      <input type="range" id="speedSlider" min="1" max="20" value="4">
    </div>
    <div id="cellSize-row">
      <label><span>Cell size</span><span id="sizeVal">6</span>px</label>
      <input type="range" id="sizeSlider" min="2" max="16" value="6">
    </div>
  </div>
  <div class="section">
    <h3>Colors</h3>
    <div class="color-row">Dead <input type="color" id="deadColor" value="#0a0a12"></div>
    <div class="color-row">Alive <input type="color" id="aliveColor" value="#00ffcc"></div>
    <div class="color-row">Trail <input type="color" id="trailColor" value="#0a4a3a"></div>
    <div style="margin-top:4px;font-size:10px;color:#555">Trail: recent deaths</div>
  </div>
  <div class="section">
    <h3>Actions</h3>
    <div class="btn-row">
      <button id="btnPlay">‚è∏ Pause</button>
      <button id="btnStep">Step</button>
      <button id="btnClear">Clear</button>
      <button id="btnRandom">Random</button>
      <button id="btnGlider">Glider</button>
      <button id="btnGun">Gosper Gun</button>
    </div>
  </div>
  <div class="section">
    <h3>Stats</h3>
    <div>Gen: <span id="generationEl">0</span></div>
    <div>Pop: <span id="popEl">0</span></div>
  </div>
  <div style="font-size:10px;color:#444;margin-top:4px;">Click/drag to draw ¬∑ M=music ¬∑ Space=pause</div>
</div>
<div id="main">
  <canvas id="c"></canvas>
  <div id="statusBar">
    <span id="ruleNameEl">Conway's Game of Life (B3/S23)</span>
    <span>Click to toggle cells</span>
  </div>
</div>
<button id="musicBtn">üéµ Music</button>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W, H, COLS, ROWS;
let cellSize = 6;
let grid, nextGrid, ageGrid;
let generation = 0, population = 0;
let paused = false;
let drawMode = 1; // 1=draw, 0=erase
let mouseDown = false;
let stepsPerFrame = 4;
let ruleType = 'life';
let birth = new Set([3]), survive = new Set([2,3]);
let deadColor = '#0a0a12', aliveColor = '#00ffcc', trailColor = '#0a4a3a';
let maxAge = 50;

// Langton's Ant state
let antX, antY, antDir, antGrid;

function resize() {
  const mainEl = document.getElementById('main');
  canvas.width = mainEl.offsetWidth;
  canvas.height = mainEl.offsetHeight - 24;
  W = canvas.width; H = canvas.height;
  COLS = Math.floor(W / cellSize);
  ROWS = Math.floor(H / cellSize);
  initGrids();
}

function initGrids() {
  grid = new Uint8Array(COLS * ROWS);
  nextGrid = new Uint8Array(COLS * ROWS);
  ageGrid = new Uint16Array(COLS * ROWS);
  antX = Math.floor(COLS/2); antY = Math.floor(ROWS/2); antDir = 0;
  antGrid = new Uint8Array(COLS * ROWS);
  generation = 0;
}

function idx(x, y) { return y * COLS + x; }

function stepLife() {
  let pop = 0;
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      let n = 0;
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          if (dx===0&&dy===0) continue;
          const nx = (x+dx+COLS)%COLS, ny = (y+dy+ROWS)%ROWS;
          if (grid[idx(nx,ny)]) n++;
        }
      }
      const i = idx(x,y);
      const alive = grid[i];
      if (alive) {
        nextGrid[i] = survive.has(n) ? 1 : 0;
      } else {
        nextGrid[i] = birth.has(n) ? 1 : 0;
      }
      if (nextGrid[i]) { ageGrid[i]++; pop++; }
      else ageGrid[i] = 0;
    }
  }
  [grid, nextGrid] = [nextGrid, grid];
  generation++; population = pop;
}

function stepWireworld() {
  // States: 0=empty 1=conductor 2=head 3=tail
  let pop = 0;
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const i = idx(x,y);
      const s = grid[i];
      if (s === 0) { nextGrid[i] = 0; }
      else if (s === 2) { nextGrid[i] = 3; } // head->tail
      else if (s === 3) { nextGrid[i] = 1; } // tail->conductor
      else if (s === 1) {
        // conductor->head if 1 or 2 heads nearby
        let heads = 0;
        for (let dy=-1;dy<=1;dy++) for (let dx=-1;dx<=1;dx++) {
          if (dx===0&&dy===0) continue;
          const nx=(x+dx+COLS)%COLS,ny=(y+dy+ROWS)%ROWS;
          if (grid[idx(nx,ny)]===2) heads++;
        }
        nextGrid[i] = (heads===1||heads===2) ? 2 : 1;
      }
      if (nextGrid[i]>0) pop++;
    }
  }
  [grid, nextGrid] = [nextGrid, grid];
  generation++; population = pop;
}

function stepBrian() {
  // 0=off 1=firing 2=refractory
  let pop = 0;
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const i = idx(x,y);
      const s = grid[i];
      if (s === 1) { nextGrid[i] = 2; pop++; }
      else if (s === 2) { nextGrid[i] = 0; }
      else {
        let n = 0;
        for (let dy=-1;dy<=1;dy++) for (let dx=-1;dx<=1;dx++) {
          if (dx===0&&dy===0) continue;
          const nx=(x+dx+COLS)%COLS,ny=(y+dy+ROWS)%ROWS;
          if (grid[idx(nx,ny)]===1) n++;
        }
        nextGrid[i] = (n===2) ? 1 : 0;
        if (nextGrid[i]) pop++;
      }
    }
  }
  [grid, nextGrid] = [nextGrid, grid];
  generation++; population = pop;
}

const ANT_DX = [0,1,0,-1], ANT_DY = [-1,0,1,0];
function stepLangton() {
  const i = idx(antX, antY);
  if (antGrid[i] === 0) {
    antDir = (antDir + 1 + 4) % 4; // turn right
    antGrid[i] = 1;
  } else {
    antDir = (antDir - 1 + 4) % 4; // turn left
    antGrid[i] = 0;
  }
  antX = (antX + ANT_DX[antDir] + COLS) % COLS;
  antY = (antY + ANT_DY[antDir] + ROWS) % ROWS;
  // Copy antGrid to grid for display
  for (let j = 0; j < grid.length; j++) grid[j] = antGrid[j];
  // Mark ant
  grid[idx(antX,antY)] = 2;
  generation++;
  population = antGrid.reduce((a,v)=>a+(v?1:0),0);
}

function stepSeeds() {
  let pop = 0;
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const i = idx(x,y);
      if (grid[i]) { nextGrid[i] = 0; continue; }
      let n = 0;
      for (let dy=-1;dy<=1;dy++) for (let dx=-1;dx<=1;dx++) {
        if (dx===0&&dy===0) continue;
        const nx=(x+dx+COLS)%COLS,ny=(y+dy+ROWS)%ROWS;
        if (grid[idx(nx,ny)]) n++;
      }
      nextGrid[i] = (n===2) ? 1 : 0;
      if (nextGrid[i]) pop++;
    }
  }
  [grid, nextGrid] = [nextGrid, grid];
  generation++; population = pop;
}

function step() {
  if (ruleType === 'wireworld') stepWireworld();
  else if (ruleType === 'brian') stepBrian();
  else if (ruleType === 'langton') stepLangton();
  else if (ruleType === 'seeds') stepSeeds();
  else stepLife();
  document.getElementById('generationEl').textContent = generation;
  document.getElementById('popEl').textContent = population;
}

// Color helpers
function hexToRgb(hex) {
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return [r,g,b];
}
function lerp(a,b,t){ return Math.round(a+(b-a)*t); }

function draw() {
  ctx.fillStyle = deadColor;
  ctx.fillRect(0,0,W,H);
  const [dr,dg,db]=hexToRgb(deadColor);
  const [ar,ag,ab]=hexToRgb(aliveColor);
  const [tr,tg,tb]=hexToRgb(trailColor);
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      const i = idx(x,y);
      const v = grid[i];
      if (v === 0 && ageGrid[i] === 0) continue;
      let color;
      if (v === 0 && ageGrid[i] > 0) {
        // recent death trail ‚Äî fade out
        const t = Math.max(0, 1 - ageGrid[i]/maxAge);
        if (t <= 0) { ageGrid[i]++; continue; }
        color = `rgb(${lerp(dr,tr,t)},${lerp(dg,tg,t)},${lerp(db,tb,t)})`;
        ageGrid[i]++;
      } else if (v === 1) {
        if (ruleType === 'wireworld') color = '#aa8800';
        else if (ruleType === 'brian') color = aliveColor;
        else color = aliveColor;
        if (ageGrid[i]) ageGrid[i] = 0; // alive resets age
      } else if (v === 2) {
        if (ruleType === 'wireworld') color = '#00ffff';
        else if (ruleType === 'langton') color = '#ff0000'; // ant
        else color = '#ffffff';
      } else if (v === 3) {
        color = ruleType==='wireworld' ? '#ff4400' : '#4488ff';
      }
      ctx.fillStyle = color;
      ctx.fillRect(x*cellSize, y*cellSize, cellSize-1, cellSize-1);
    }
  }
}

// Patterns
function placeGlider(x, y) {
  const pattern = [[1,0],[2,1],[0,2],[1,2],[2,2]];
  pattern.forEach(([dx,dy]) => {
    const i = idx((x+dx)%COLS,(y+dy)%ROWS);
    grid[i]=1; ageGrid[i]=0;
  });
}
function placeGosperGun() {
  const x=1,y=Math.floor(ROWS/2)-5;
  const pat="................X..........XXX.......X..........XXX.........................................XX..XX......X.X...........X..X......X.X............X........X.X............X...XXX.....XXX........XX.......XX..........X..X......X.XX...........X..X.......X...X.........XXX.......XXX......X..XX.........XX.........X.X...........X..X......X.X............X........X.X..............................X..........XXX.......X..........XXX.................XX";
  // Actually place a proper Gosper glider gun
  const gun = [
    [0,4],[0,5],[1,4],[1,5],
    [10,4],[10,5],[10,6],[11,3],[11,7],[12,2],[12,8],[13,2],[13,8],
    [14,5],[15,3],[15,7],[16,4],[16,5],[16,6],[17,5],
    [20,2],[20,3],[20,4],[21,2],[21,3],[21,4],[22,1],[22,5],[24,0],[24,1],[24,5],[24,6],
    [34,2],[34,3],[35,2],[35,3]
  ];
  gun.forEach(([dx,dy]) => {
    const gx=(x+dx)%COLS, gy=(y+dy)%ROWS;
    grid[idx(gx,gy)]=1;
  });
}
function randomize() {
  for (let i=0;i<grid.length;i++) {
    grid[i]=Math.random()<0.3?1:0;
    ageGrid[i]=0;
  }
  if (ruleType==='wireworld') for(let i=0;i<grid.length;i++) grid[i]=Math.random()<0.1?(Math.random()<0.2?2:1):0;
  if (ruleType==='langton') { for(let i=0;i<grid.length;i++){antGrid[i]=0;} }
}

function applyBS() {
  birth = new Set(document.getElementById('birthInput').value.split('').map(Number));
  survive = new Set(document.getElementById('surviveInput').value.split('').map(Number));
  const b=[...birth].sort().join(''), s=[...survive].sort().join('');
  document.getElementById('ruleNameEl').textContent = `Custom (B${b}/S${s})`;
}

// Buttons
document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('birthInput').value = btn.dataset.b;
    document.getElementById('surviveInput').value = btn.dataset.s;
    applyBS();
  });
});
document.getElementById('btnPlay').addEventListener('click', () => {
  paused=!paused;
  document.getElementById('btnPlay').textContent=paused?'‚ñ∂ Play':'‚è∏ Pause';
  document.getElementById('btnPlay').classList.toggle('active', paused);
});
document.getElementById('btnStep').addEventListener('click', () => { step(); draw(); });
document.getElementById('btnClear').addEventListener('click', () => { initGrids(); });
document.getElementById('btnRandom').addEventListener('click', randomize);
document.getElementById('btnGlider').addEventListener('click', () => { placeGlider(2,2); });
document.getElementById('btnGun').addEventListener('click', () => { initGrids(); placeGosperGun(); });
document.getElementById('ruleType').addEventListener('change', e => {
  ruleType = e.target.value;
  initGrids();
  document.getElementById('bsSection').style.display = ['life','daynight','seeds'].includes(ruleType)?'block':'none';
  document.getElementById('ruleNameEl').textContent = ruleType;
  if(ruleType==='daynight'){document.getElementById('birthInput').value='3678';document.getElementById('surviveInput').value='34678';applyBS();}
  if(ruleType==='seeds'){document.getElementById('birthInput').value='2';document.getElementById('surviveInput').value='';applyBS();}
});
document.getElementById('speedSlider').addEventListener('input', e => {
  stepsPerFrame=parseInt(e.target.value);
  document.getElementById('speedVal').textContent=stepsPerFrame;
});
document.getElementById('sizeSlider').addEventListener('input', e => {
  cellSize=parseInt(e.target.value);
  document.getElementById('sizeVal').textContent=cellSize;
  COLS=Math.floor(W/cellSize); ROWS=Math.floor(H/cellSize); initGrids();
});
document.getElementById('deadColor').addEventListener('input', e=>deadColor=e.target.value);
document.getElementById('aliveColor').addEventListener('input', e=>aliveColor=e.target.value);
document.getElementById('trailColor').addEventListener('input', e=>trailColor=e.target.value);

// Mouse
function cellAt(e) {
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(W/rect.width), my=(e.clientY-rect.top)*(H/rect.height);
  return [Math.floor(mx/cellSize),Math.floor(my/cellSize)];
}
canvas.addEventListener('mousedown', e=>{
  mouseDown=true;
  const [cx,cy]=cellAt(e);
  const i=idx(cx,cy);
  if(i>=0&&i<grid.length){
    drawMode = grid[i]?0:1;
    grid[i]=drawMode; ageGrid[i]=0;
    if(ruleType==='wireworld'&&drawMode===1) grid[i]=1;
    playClick();
  }
});
canvas.addEventListener('mousemove', e=>{
  if(!mouseDown) return;
  const [cx,cy]=cellAt(e);
  const i=idx(cx,cy);
  if(i>=0&&i<grid.length){grid[i]=drawMode; ageGrid[i]=0;}
});
canvas.addEventListener('mouseup', ()=>mouseDown=false);
canvas.addEventListener('mouseleave', ()=>mouseDown=false);

document.addEventListener('keydown', e=>{
  if(e.key===' '){e.preventDefault(); document.getElementById('btnPlay').click();}
  if(e.key==='r'||e.key==='R') randomize();
  if(e.key==='c'||e.key==='C') initGrids();
  if(e.key==='m'||e.key==='M') document.getElementById('musicBtn').click();
});

let frameCount=0;
function loop() {
  if (!paused) {
    for(let i=0;i<stepsPerFrame;i++) step();
  }
  if(frameCount%1===0) draw();
  frameCount++;
  requestAnimationFrame(loop);
}

// Audio
let audioCtx=null,musicOn=false,musicNodes=[];
function initA(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function playClick(){initA();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.frequency.value=660;g.gain.value=0.04;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.05);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.05);}
function startMusic(){
  initA();stopMusic();
  const m=audioCtx.createGain();m.gain.value=0.15;m.connect(audioCtx.destination);
  musicNodes.push(m);
  // Ambient electronic hum
  [[55,0.08],[110,0.04],[220,0.02]].forEach(([f,v])=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='sine';o.frequency.value=f;g.gain.value=v;
    const lfo=audioCtx.createOscillator(),lg=audioCtx.createGain();
    lfo.frequency.value=0.1+f*0.001;lg.gain.value=v*0.3;
    lfo.connect(lg);lg.connect(g.gain);lfo.start();
    o.connect(g);g.connect(m);o.start();
    musicNodes.push(o,g,lfo,lg);
  });
  // Random blips
  const blip=()=>{
    if(!musicOn)return;
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='square';o.frequency.value=440+Math.random()*880;
    g.gain.value=0.03;g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);
    o.connect(g);g.connect(m);o.start();o.stop(audioCtx.currentTime+0.1);
    setTimeout(blip,500+Math.random()*2000);
  };
  blip();
}
function stopMusic(){musicNodes.forEach(n=>{try{n.stop?.();n.disconnect?.();}catch(e){}});musicNodes=[];}
document.getElementById('musicBtn').addEventListener('click',()=>{
  musicOn=!musicOn;
  document.getElementById('musicBtn').textContent=musicOn?'üéµ Music ON':'üéµ Music';
  if(musicOn)startMusic();else stopMusic();
});

window.addEventListener('resize', ()=>{cancelAnimationFrame(0);resize();});
resize();
randomize();
loop();
</script>
</body>
</html>
