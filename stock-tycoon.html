<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --green: #22c55e;
            --green-dark: #16a34a;
            --red: #ef4444;
            --red-dark: #dc2626;
            --accent: #3b82f6;
            --accent-dark: #2563eb;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --orange: #f97316;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .gradient-text {
            background: linear-gradient(135deg, #22c55e 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-dark); transform: translateY(-2px); }
        .btn-success { background: var(--green); color: white; }
        .btn-success:hover { background: var(--green-dark); transform: translateY(-2px); }
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { background: var(--red-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-warning { background: var(--warning); color: black; }
        .btn-purple { background: var(--purple); color: white; }
        .btn-orange { background: var(--orange); color: white; }

        .price-up { color: var(--green); font-weight: 600; }
        .price-down { color: var(--red); font-weight: 600; }

        .chart-container { position: relative; height: 200px; width: 100%; }
        .mini-chart { height: 60px; }

        .sentiment-meter {
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--red) 0%, #f59e0b 50%, var(--green) 100%);
            position: relative;
        }

        .sentiment-indicator {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: left 0.5s ease;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-btn:hover { color: var(--text-primary); }

        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }

        input[type="number"], input[type="text"] {
            background: var(--bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-primary);
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus, input[type="text"]:focus { border-color: var(--accent); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content { transform: scale(1); }

        .progress-bar { height: 6px; background: var(--bg-dark); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: var(--purple); }

        .event-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 400px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-left: 4px solid var(--accent);
            animation: slideInRight 0.5s ease;
            z-index: 999;
        }

        @keyframes slideInRight {
            from { transform: translateX(120%); }
            to { transform: translateX(0); }
        }

        .heatmap-cell { transition: all 0.2s; cursor: pointer; }
        .heatmap-cell:hover { transform: scale(1.05); z-index: 10; }

        .grid-pattern {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .achievement-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
            transition: all 0.3s;
        }

        .achievement-badge.locked {
            background: rgba(100, 116, 139, 0.3);
            filter: grayscale(1);
            opacity: 0.5;
        }

        .achievement-badge.unlocked {
            background: linear-gradient(135deg, var(--green), var(--accent));
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
            animation: achievementPulse 2s infinite;
        }

        @keyframes achievementPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .achievement-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .achievement-badge:hover .achievement-tooltip { opacity: 1; }

        .ipo-banner {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 12px;
            padding: 16px;
            animation: ipoGlow 2s ease-in-out infinite;
        }

        @keyframes ipoGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.6); }
        }

        .option-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 12px;
        }

        .option-card.put {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1));
            border-color: rgba(239, 68, 68, 0.3);
        }

        .margin-call-alert {
            animation: marginCallFlash 1s ease-in-out infinite;
        }

        @keyframes marginCallFlash {
            0%, 100% { background: rgba(239, 68, 68, 0.2); }
            50% { background: rgba(239, 68, 68, 0.5); }
        }

        .music-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .music-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #a78bfa, #f472b6);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-btn:hover { transform: scale(1.1); }
        .music-btn.muted { background: linear-gradient(135deg, #64748b, #475569); }

        .volume-slider {
            width: 100px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #f472b6);
            cursor: pointer;
        }

        .indicator-row {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
            padding: 4px 0;
        }

        .indicator-label { color: var(--text-secondary); min-width: 50px; }
        .indicator-value { font-family: monospace; font-weight: 600; }
        .indicator-value.buy { color: var(--green); }
        .indicator-value.sell { color: var(--red); }
        .indicator-value.neutral { color: var(--text-secondary); }

        .news-item {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin-bottom: 8px;
            animation: newsSlide 0.3s ease;
        }

        @keyframes newsSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="grid-pattern">
    <!-- Back Button -->
    <a href="/games" class="fixed top-4 left-4 z-50 flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg transition-all border border-slate-700">
        <span>üéÆ</span>
        <span class="font-medium">Games</span>
    </a>

    <!-- Event Notifications Container -->
    <div id="eventContainer" class="fixed top-20 right-4 z-50 space-y-3"></div>

    <!-- Margin Call Alert -->
    <div id="marginCallBanner" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white text-center py-2 z-50 font-bold">
        ‚ö†Ô∏è MARGIN CALL - Deposit funds or positions will be liquidated!
    </div>

    <!-- Header -->
    <header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col xl:flex-row xl:items-center xl:justify-between gap-4">
                <div class="flex flex-col md:flex-row md:items-center gap-4 md:gap-8">
                    <div>
                        <h1 class="text-3xl font-bold gradient-text">üìà Stock Market Tycoon</h1>
                        <p class="text-slate-400 text-sm mt-1">Day <span id="dayCounter" class="text-blue-400 font-bold">1</span> ‚Ä¢ <span id="timeDisplay" class="text-slate-300">09:30 AM</span> <span id="lastSaved" class="text-slate-600 ml-2"></span></p>
                    </div>
                    
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Market Status</p>
                            <span id="marketStatus" class="badge badge-success">üü¢ Open</span>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Sentiment</p>
                            <div class="w-32 mt-1">
                                <div class="sentiment-meter">
                                    <div id="sentimentIndicator" class="sentiment-indicator" style="left: 50%"></div>
                                </div>
                                <p id="sentimentLabel" class="text-xs mt-1 text-slate-400">Neutral</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <div class="flex gap-4 sm:gap-6">
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Cash</p>
                            <p id="cashDisplay" class="text-xl font-bold text-white">$100,000</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Portfolio</p>
                            <p id="portfolioValue" class="text-xl font-bold text-blue-400">$0</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase tracking-wider">Total P&L</p>
                            <p id="totalPnL" class="text-xl font-bold text-slate-400">$0</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 border-l border-slate-700 pl-4">
                        <button onclick="saveGameState()" class="btn btn-success text-xs px-3 py-2" title="Save Game">üíæ Save</button>
                        <button onclick="resetGame()" class="btn btn-danger text-xs px-3 py-2" title="New Game">üîÑ New</button>
                        <button id="autoSaveBtn" onclick="toggleAutoSave()" class="btn btn-success text-xs px-3 py-2" title="Toggle Auto-Save">‚úÖ Auto</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Ticker -->
        <div class="bg-slate-950 border-t border-slate-800 overflow-hidden">
            <div class="flex items-center">
                <div class="bg-blue-600 text-white px-4 py-2 text-sm font-bold shrink-0">üì∞ NEWS</div>
                <div class="overflow-hidden flex-1 relative h-9">
                    <div id="newsTicker" class="absolute whitespace-nowrap flex items-center h-full gap-8 text-sm text-slate-300">
                        <span>Welcome to Stock Market Tycoon! Start trading to build your fortune.</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Quick Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card p-4">
                <p class="text-xs text-slate-500 uppercase">Buying Power</p>
                <p id="buyingPower" class="text-lg font-bold text-white">$100,000</p>
                <p class="text-xs text-slate-400 mt-1">Including margin</p>
            </div>
            <div class="card p-4">
                <p class="text-xs text-slate-500 uppercase">Margin Used</p>
                <p id="marginUsed" class="text-lg font-bold text-slate-400">$0</p>
                <p id="marginHealth" class="text-xs text-green-400 mt-1">Healthy</p>
            </div>
            <div class="card p-4">
                <p class="text-xs text-slate-500 uppercase">Day Trades</p>
                <p id="dayTrades" class="text-lg font-bold text-white">0/3</p>
                <p class="text-xs text-slate-400 mt-1">Pattern day trader</p>
            </div>
            <div class="card p-4">
                <p class="text-xs text-slate-500 uppercase">Dividends Earned</p>
                <p id="dividendsEarned" class="text-lg font-bold text-green-400">$0</p>
                <p id="nextDividend" class="text-xs text-slate-400 mt-1">Next: Day 7</p>
            </div>
        </div>

        <!-- IPO Banner (Hidden by default) -->
        <div id="ipoBanner" class="hidden ipo-banner mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-4xl">üöÄ</span>
                    <div>
                        <h3 class="font-bold text-lg">New IPO Available!</h3>
                        <p class="text-slate-300"><span id="ipoSymbol" class="font-bold text-purple-400"></span> - <span id="ipoName"></span> is now trading at <span id="ipoPrice" class="font-mono"></span></p>
                    </div>
                </div>
                <button onclick="buyIPO()" class="btn btn-purple">Buy IPO Shares</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="border-b border-slate-800 mb-6">
            <div class="flex gap-2 overflow-x-auto scroll-hide">
                <button class="tab-btn active" onclick="switchTab('market')">üè¢ Market</button>
                <button class="tab-btn" onclick="switchTab('portfolio')">üíº Portfolio</button>
                <button class="tab-btn" onclick="switchTab('options')">üìä Options</button>
                <button class="tab-btn" onclick="switchTab('watchlist')">‚≠ê Watchlist</button>
                <button class="tab-btn" onclick="switchTab('news')">üì∞ News Feed</button>
                <button class="tab-btn" onclick="switchTab('calendar')">üìÖ Calendar</button>
                <button class="tab-btn" onclick="switchTab('margin')">‚ö° Margin & Short</button>
                <button class="tab-btn" onclick="switchTab('heatmap')">üî• Heatmap</button>
                <button class="tab-btn" onclick="switchTab('achievements')">üèÜ Achievements</button>
            </div>
        </div>

        <!-- Market Tab -->
        <div id="marketTab" class="tab-content">
            <div class="grid lg:grid-cols-2 gap-6">
                <div>
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Stock Market</h2>
                            <div class="flex gap-2">
                                <input type="text" id="stockSearch" placeholder="Search stocks..." class="w-40 text-sm" onkeyup="searchStocks()">
                                <select id="sectorFilter" class="bg-slate-800 border border-slate-700 rounded-lg px-3 text-sm" onchange="filterBySector()">
                                    <option value="all">All Sectors</option>
                                    <option value="tech">Technology</option>
                                    <option value="finance">Finance</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="energy">Energy</option>
                                    <option value="retail">Retail</option>
                                    <option value="crypto">Crypto</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left text-xs text-slate-500 uppercase tracking-wider border-b border-slate-700">
                                        <th class="pb-3 cursor-pointer" onclick="sortStocks('symbol')">Symbol ‚Üï</th>
                                        <th class="pb-3">Company</th>
                                        <th class="pb-3 cursor-pointer" onclick="sortStocks('price')">Price ‚Üï</th>
                                        <th class="pb-3">Change</th>
                                        <th class="pb-3 hidden md:table-cell">Chart</th>
                                        <th class="pb-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="stockList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card p-6" id="stockDetails">
                        <div class="text-center text-slate-500 py-8">
                            <p class="text-4xl mb-3">üìä</p>
                            <p>Select a stock to view details</p>
                        </div>
                    </div>

                    <div class="card p-6 mt-6">
                        <h3 class="font-bold mb-4">‚ö° Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="btn btn-success" onclick="openBuyModal(STOCKS[0].symbol)">Buy AAPL</button>
                            <button class="btn btn-secondary" onclick="addToWatchlist(STOCKS[0].symbol)">‚≠ê Watch AAPL</button>
                        </div>
                        <p class="text-xs text-slate-400 mt-3">Click any stock in the list for detailed trading options.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolioTab" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4">Your Holdings</h2>
                        <div id="holdingsList" class="space-y-3">
                            <div class="text-center text-slate-500 py-8">
                                <p class="text-4xl mb-3">üì≠</p>
                                <p>No holdings yet. Start trading!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Portfolio Performance</h3>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üìä Allocation</h3>
                        <div style="height: 200px;">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üìà Performance Metrics</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Return</span>
                                <span id="totalReturn" class="font-mono">0.00%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Annualized Return</span>
                                <span id="annualizedReturn" class="font-mono">0.00%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Best Performer</span>
                                <span id="bestPerformer" class="font-mono text-green-400">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Worst Performer</span>
                                <span id="worstPerformer" class="font-mono text-red-400">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Sharpe Ratio</span>
                                <span id="sharpeRatio" class="font-mono">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">üìù Recent Trades</h3>
                        <div id="tradeHistory" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-slate-500 text-sm text-center">No trades yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Options Tab -->
        <div id="optionsTab" class="tab-content hidden">
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">üìä Options Chain</h2>
                            <select id="optionsStockSelect" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2" onchange="updateOptionsChain()">
                                <option value="">Select a stock...</option>
                            </select>
                        </div>
                        <div id="optionsChain" class="space-y-4">
                            <div class="text-center text-slate-500 py-8">
                                <p class="text-4xl mb-3">üìä</p>
                                <p>Select a stock to view options</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Your Options Positions</h3>
                        <div id="optionsPositions" class="space-y-3">
                            <p class="text-slate-500 text-center">No options positions</p>
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="font-bold mb-4">Options Guide</h3>
                        <div class="text-sm text-slate-400 space-y-2">
                            <p><span class="text-green-400 font-bold">Call:</span> Right to buy at strike price. Profit when stock goes UP.</p>
                            <p><span class="text-red-400 font-bold">Put:</span> Right to sell at strike price. Profit when stock goes DOWN.</p>
                            <p><span class="text-blue-400">Expiration:</span> Date when option expires worthless if not exercised.</p>
                            <p><span class="text-yellow-400">Premium:</span> Price paid for the option contract.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlistTab" class="tab-content hidden">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">‚≠ê Your Watchlist</h2>
                    <button class="btn btn-secondary" onclick="addToWatchlistPrompt()">+ Add Symbol</button>
                </div>
                <div id="watchlistContainer" class="space-y-3">
                    <div class="text-center text-slate-500 py-8">
                        <p class="text-4xl mb-3">‚≠ê</p>
                        <p>Your watchlist is empty. Add stocks to track them here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Feed Tab -->
        <div id="newsTab" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">üì∞ Market News</h2>
                    <div id="newsFeed" class="space-y-4 max-h-96 overflow-y-auto">
                        <p class="text-slate-500 text-center">No news yet</p>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">üìä Market Sentiment Analysis</h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span>Fear & Greed Index</span>
                                <span id="fearGreedValue" class="font-bold">50 - Neutral</span>
                            </div>
                            <div class="progress-bar">
                                <div id="fearGreedBar" class="progress-fill bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style="width: 50%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span>VIX Volatility Index</span>
                                <span id="vixValue" class="font-bold">15.2</span>
                            </div>
                            <div class="progress-bar">
                                <div id="vixBar" class="progress-fill bg-blue-500" style="width: 25%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span>Interest Rate</span>
                                <span id="interestRateValue" class="font-bold">5.25%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="interestRateBar" class="progress-fill bg-purple-500" style="width: 52%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold mt-6 mb-3">Sector Performance</h3>
                    <div id="sectorPerformance" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Economic Calendar Tab -->
        <div id="calendarTab" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">üìÖ Upcoming Events</h2>
                    <div id="calendarEvents" class="space-y-3"></div>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">üìä Economic Indicators</h2>
                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-400">Fed Funds Rate</span>
                                <span id="fedRate" class="font-bold text-lg">5.25%</span>
                            </div>
                            <p class="text-xs text-slate-500">Last changed: Day 1</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-400">Inflation Rate</span>
                                <span id="inflationRate" class="font-bold text-lg">3.2%</span>
                            </div>
                            <p class="text-xs text-slate-500">Year over year</p>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-400">Unemployment</span>
                                <span id="unemploymentRate" class="font-bold text-lg">3.8%</span>
                            </div>
                            <p class="text-xs text-slate-500">Non-farm payrolls</p>
                        </div>
                    </div>
                    
                    <h3 class="font-bold mt-6 mb-3">Earnings This Week</h3>
                    <div id="earningsList" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Margin & Short Tab -->
        <div id="marginTab" class="tab-content hidden">
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">‚ö° Margin Trading</h2>
                    <div class="bg-slate-800/50 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-400">Available Margin</span>
                            <span id="availableMargin" class="text-xl font-bold text-white">$50,000</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-400">Margin Used</span>
                            <span id="marginUsed2" class="font-bold text-orange-400">$0</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-400">Maintenance Requirement</span>
                            <span id="maintenanceReq" class="font-bold text-green-400">25%</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-700">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400">Margin Level</span>
                                <span id="marginLevel" class="font-bold text-green-400">200%</span>
                            </div>
                            <div class="progress-bar mt-2">
                                <div id="marginLevelBar" class="progress-fill bg-green-500" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-400 mb-4">
                        Margin allows you to borrow money to buy stocks. You can borrow up to 50% of your portfolio value.
                        <span class="text-orange-400">Warning: Trading on margin amplifies both gains and losses.</span>
                    </p>
                </div>

                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">üìâ Short Positions</h2>
                    <div id="shortPositions" class="space-y-3 mb-4">
                        <p class="text-slate-500 text-center">No short positions</p>
                    </div>
                    <p class="text-sm text-slate-400">
                        Short selling lets you profit from falling prices by borrowing and selling shares, then buying them back later at a lower price.
                        <span class="text-red-400">Risk: Losses are theoretically unlimited.</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Heatmap Tab -->
        <div id="heatmapTab" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">üî• Market Heatmap</h2>
                <p class="text-slate-400 text-sm mb-4">Visual representation of stock performance by sector. Green = Up, Red = Down.</p>
                <div id="marketHeatmap" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievementsTab" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4">üèÜ Achievements</h2>
                <p class="text-slate-400 mb-6">Complete challenges to earn badges and prove your trading prowess!</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="achievementsGrid">
                    <!-- Achievements will be rendered here -->
                </div>
                
                <div class="mt-8 p-4 bg-slate-800/50 rounded-lg">
                    <h3 class="font-bold mb-2">üìä Your Stats</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-slate-400">Total Trades:</span>
                            <span id="statTotalTrades" class="font-mono ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-slate-400">Win Rate:</span>
                            <span id="statWinRate" class="font-mono ml-2">0%</span>
                        </div>
                        <div>
                            <span class="text-slate-400">Profitable Days:</span>
                            <span id="statProfitableDays" class="font-mono ml-2">0</span>
                        </div>
                        <div>
                            <span class="text-slate-400">Largest Gain:</span>
                            <span id="statLargestGain" class="font-mono ml-2 text-green-400">$0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Trade Modal -->
    <div id="tradeModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="tradeModalTitle" class="text-2xl font-bold mb-4">Trade</h2>
            <div id="tradeModalContent"></div>
        </div>
    </div>

    <!-- Options Modal -->
    <div id="optionsModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="optionsModalTitle" class="text-2xl font-bold mb-4">Trade Options</h2>
            <div id="optionsModalContent"></div>
        </div>
    </div>

    <!-- Music Control -->
    <div class="music-control">
        <button id="musicToggle" class="music-btn muted" onclick="toggleMusic()" title="Toggle Music">üîá</button>
        <div>
            <div class="music-label">Chill Lofi</div>
            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="15" onchange="setVolume(this.value)" title="Volume">
        </div>
    </div>

    <script>

// ================================================
// TRADING FLOOR AUDIO SYSTEM
// ================================================
let audioCtx = null;
let masterGain = null;
let musicEnabled = false;
let musicVolume = 0.15;
let ambientNodes = [];
let tickerInterval = null;

function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0;
    const comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -20; comp.ratio.value = 3;
    masterGain.connect(comp); comp.connect(audioCtx.destination);
}

function playTradingFloorAmbient() {
    if (!audioCtx || !musicEnabled) return;
    // Background hum of trading floor
    [60, 120, 180].forEach((f, i) => {
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass'; filter.frequency.value = 300;
        osc.type = 'sine'; osc.frequency.value = f;
        g.gain.setValueAtTime(0, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.02/(i+1), audioCtx.currentTime + 2);
        osc.connect(filter); filter.connect(g); g.connect(masterGain);
        osc.start();
        ambientNodes.push({ osc, gain: g });
    });
    // Occasional keyboard clatter
    tickerInterval = setInterval(() => {
        if (!musicEnabled) return;
        if (Math.random() < 0.3) playKeyClatter();
        if (Math.random() < 0.15) playTickerBeep();
    }, 2000);
}

function playKeyClatter() {
    if (!audioCtx) return;
    const count = Math.floor(Math.random() * 5) + 2;
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.03, audioCtx.sampleRate);
            const d = buf.getChannelData(0);
            for (let j = 0; j < d.length; j++) d[j] = (Math.random()*2-1)*0.3*Math.exp(-j/(audioCtx.sampleRate*0.01));
            const src = audioCtx.createBufferSource(); src.buffer = buf;
            const g = audioCtx.createGain(); g.gain.value = 0.015;
            const f = audioCtx.createBiquadFilter(); f.type = 'bandpass'; f.frequency.value = 2000 + Math.random()*1000;
            src.connect(f); f.connect(g); g.connect(masterGain); src.start();
        }, i * (30 + Math.random() * 80));
    }
}

function playTickerBeep() {
    if (!audioCtx) return;
    const f = 880 + Math.random() * 440;
    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
    osc.frequency.value = f; osc.type = 'sine';
    g.gain.setValueAtTime(0.03, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
    osc.connect(g); g.connect(masterGain); osc.start(); osc.stop(audioCtx.currentTime + 0.16);
}

function stopAmbient() {
    ambientNodes.forEach(n => { try { n.osc.stop(); } catch(e){} });
    ambientNodes = [];
    clearInterval(tickerInterval);
}

function toggleMusic() {
    initAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    musicEnabled = !musicEnabled;
    const btn = document.getElementById('musicToggle');
    if (musicEnabled) {
        masterGain.gain.setTargetAtTime(musicVolume, audioCtx.currentTime, 0.5);
        playTradingFloorAmbient();
        btn.textContent = 'üéµ'; btn.classList.remove('muted');
        // Update label
        const lbl = btn.nextElementSibling?.querySelector('.music-label');
        if (lbl) lbl.textContent = 'Trading Floor';
    } else {
        masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.3);
        setTimeout(stopAmbient, 300);
        btn.textContent = 'üîá'; btn.classList.add('muted');
    }
}

function setVolume(v) {
    musicVolume = v / 100;
    if (masterGain && musicEnabled) masterGain.gain.setTargetAtTime(musicVolume, audioCtx.currentTime, 0.1);
}

function playBuy() {
    initAudio();
    if (!audioCtx) return;
    [523, 659, 784, 1047].forEach((f, i) => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.value = f; osc.type = 'triangle';
        const t = audioCtx.currentTime + i * 0.08;
        g.gain.setValueAtTime(0.08, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(t); osc.stop(t + 0.21);
    });
}

function playSell() {
    initAudio();
    if (!audioCtx) return;
    [784, 659, 523, 392].forEach((f, i) => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.value = f; osc.type = 'triangle';
        const t = audioCtx.currentTime + i * 0.08;
        g.gain.setValueAtTime(0.08, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(t); osc.stop(t + 0.21);
    });
}

function playAlert(up = true) {
    initAudio();
    if (!audioCtx) return;
    const freqs = up ? [440, 550] : [440, 330];
    freqs.forEach((f, i) => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.value = f; osc.type = 'sine';
        const t = audioCtx.currentTime + i * 0.15;
        g.gain.setValueAtTime(0.06, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.14);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(t); osc.stop(t + 0.15);
    });
}

function playNewsAlert() {
    initAudio();
    if (!audioCtx) return;
    [880, 1100, 880].forEach((f, i) => {
        const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
        osc.frequency.value = f; osc.type = 'square';
        const t = audioCtx.currentTime + i * 0.12;
        g.gain.setValueAtTime(0.05, t); g.gain.exponentialRampToValueAtTime(0.001, t + 0.11);
        osc.connect(g); g.connect(audioCtx.destination); osc.start(t); osc.stop(t + 0.12);
    });
}

// ================================================
// GAME STATE
// ================================================
let cash = 100000;
let dayCount = 1;
let portfolio = {}; // symbol -> { shares, avgCost }
let shortPositions = {};
let watchlist = new Set();
let tradeHistory = [];
let selectedStock = null;
let autoSaveEnabled = true;
let lastSaved = null;
let marginUsed = 0;
let dayTrades = 0;
let totalDividends = 0;
let profitableDays = 0;
let totalWins = 0, totalLosses = 0;
let activeTab = 'market';

const ACHIEVEMENTS = [
    { id: 'firstTrade', name: 'First Trade', icon: 'üéØ', desc: 'Make your first trade', unlocked: false },
    { id: 'millionaire', name: 'Millionaire', icon: 'üí∞', desc: 'Reach $1M total wealth', unlocked: false },
    { id: 'dayTrader', name: 'Day Trader', icon: '‚ö°', desc: 'Make 3 day trades', unlocked: false },
    { id: 'diversified', name: 'Diversified', icon: 'üåà', desc: 'Own 5 different stocks', unlocked: false },
    { id: 'winner', name: 'Consistent Winner', icon: 'üèÜ', desc: 'Win 10 trades in a row', unlocked: false },
    { id: 'longHold', name: 'Diamond Hands', icon: 'üíé', desc: 'Hold a stock for 30 days', unlocked: false },
    { id: 'bigBuy', name: 'Big Spender', icon: 'üí∏', desc: 'Buy $50K of a single stock', unlocked: false },
    { id: 'recovered', name: 'Comeback Kid', icon: 'ü¶ã', desc: 'Recover from being down 50%', unlocked: false },
    { id: 'watchlistPro', name: 'Watchlist Pro', icon: 'üëÄ', desc: 'Add 5 stocks to watchlist', unlocked: false },
    { id: 'ipoChaser', name: 'IPO Chaser', icon: 'üöÄ', desc: 'Buy an IPO on day one', unlocked: false },
];

// ================================================
// STOCKS DATA
// ================================================
const STOCKS = [
    { symbol:'AAPL', name:'Apple Inc.', price:175, sector:'tech', dividend:0.96, pe:28, earningsDay:14 },
    { symbol:'GOOGL', name:'Alphabet Inc.', price:138, sector:'tech', dividend:0, pe:25, earningsDay:21 },
    { symbol:'MSFT', name:'Microsoft Corp.', price:380, sector:'tech', dividend:2.72, pe:35, earningsDay:28 },
    { symbol:'AMZN', name:'Amazon.com', price:182, sector:'tech', dividend:0, pe:42, earningsDay:7 },
    { symbol:'TSLA', name:'Tesla Inc.', price:245, sector:'tech', dividend:0, pe:65, earningsDay:18 },
    { symbol:'JPM', name:'JPMorgan Chase', price:196, sector:'finance', dividend:4.0, pe:12, earningsDay:5 },
    { symbol:'BAC', name:'Bank of America', price:38, sector:'finance', dividend:0.92, pe:10, earningsDay:10 },
    { symbol:'JNJ', name:'Johnson & Johnson', price:155, sector:'healthcare', dividend:4.76, pe:16, earningsDay:16 },
    { symbol:'PFE', name:'Pfizer Inc.', price:28, sector:'healthcare', dividend:1.68, pe:8, earningsDay:22 },
    { symbol:'XOM', name:'ExxonMobil', price:105, sector:'energy', dividend:3.72, pe:14, earningsDay:3 },
    { symbol:'WMT', name:'Walmart Inc.', price:166, sector:'retail', dividend:2.28, pe:28, earningsDay:25 },
    { symbol:'NFLX', name:'Netflix Inc.', price:490, sector:'tech', dividend:0, pe:38, earningsDay:12 },
    { symbol:'BTC', name:'Bitcoin ETF', price:52000, sector:'crypto', dividend:0, pe:0, earningsDay:0 },
    { symbol:'ETH', name:'Ethereum ETF', price:2800, sector:'crypto', dividend:0, pe:0, earningsDay:0 },
    { symbol:'GLD', name:'Gold ETF', price:185, sector:'energy', dividend:0, pe:0, earningsDay:0 },
];

// Extended stock state
STOCKS.forEach(s => {
    s.history = [s.price];
    s.change = 0;
    s.changePct = 0;
    s.volume = Math.floor(Math.random() * 10000000) + 1000000;
    s.high52 = s.price * (1 + Math.random() * 0.4);
    s.low52 = s.price * (1 - Math.random() * 0.3);
    s.marketCap = (s.price * 1e9 * (Math.random() * 10 + 0.5)).toFixed(0);
});

let sortField = 'symbol';
let sortAsc = true;
let searchQuery = '';
let sectorFilter = 'all';
let marketSentiment = 50;
let vix = 15.2;
let fearGreed = 50;
let interestRate = 5.25;
let inflationRate = 3.2;
let unemploymentRate = 3.8;
let newsHistory = [];
let pendingIPO = null;
let marketOpen = true;
let portfolioChart = null;
let allocationChart = null;
let stockCharts = {};

const NEWS_TEMPLATES = [
    ['AAPL', 'Apple reports record iPhone sales', 0.03, 'bullish'],
    ['TSLA', 'Tesla Cybertruck deliveries exceed expectations', 0.05, 'bullish'],
    ['GOOGL', 'Google AI breakthrough announced', 0.04, 'bullish'],
    ['BTC', 'Bitcoin ETF sees record inflows', 0.08, 'bullish'],
    ['XOM', 'Oil prices surge on OPEC cuts', 0.04, 'bullish'],
    ['JPM', 'Fed signals rate pause, banks rally', 0.03, 'bullish'],
    ['PFE', 'FDA approves new Pfizer drug', 0.06, 'bullish'],
    ['NFLX', 'Netflix subscriber growth misses targets', -0.04, 'bearish'],
    ['BTC', 'Crypto regulation fears rattle market', -0.08, 'bearish'],
    ['TSLA', 'Tesla recalls 50,000 vehicles', -0.03, 'bearish'],
    ['XOM', 'Oil prices drop on recession fears', -0.03, 'bearish'],
    ['WMT', 'Consumer spending data disappoints', -0.02, 'bearish'],
    ['JPM', 'Banking sector faces credit concerns', -0.03, 'bearish'],
];

const CALENDAR_EVENTS = [
    { day: 7, name: 'Fed Interest Rate Decision', impact: 'HIGH', type: 'fed' },
    { day: 14, name: 'AAPL Earnings Report', impact: 'HIGH', type: 'earnings' },
    { day: 21, name: 'CPI Inflation Data', impact: 'MEDIUM', type: 'economic' },
    { day: 28, name: 'Monthly Jobs Report', impact: 'HIGH', type: 'economic' },
    { day: 35, name: 'MSFT Earnings Report', impact: 'HIGH', type: 'earnings' },
    { day: 42, name: 'GDP Quarterly Data', impact: 'MEDIUM', type: 'economic' },
];

// ================================================
// MARKET ENGINE
// ================================================
function getStockBySymbol(sym) { return STOCKS.find(s => s.symbol === sym); }

function updateMarket() {
    const prevCash = cash;
    const prevPortfolioVal = getPortfolioValue();

    STOCKS.forEach(s => {
        const sentimentFactor = (marketSentiment - 50) / 500;
        const vol = s.sector === 'crypto' ? 0.04 : s.sector === 'tech' ? 0.02 : 0.01;
        const change = (Math.random() * 2 - 1) * vol + sentimentFactor;
        const prevPrice = s.price;
        s.price = Math.max(0.01, s.price * (1 + change));
        s.change = s.price - prevPrice;
        s.changePct = (change * 100);
        s.history.push(s.price);
        if (s.history.length > 60) s.history.shift();
        s.high52 = Math.max(s.high52, s.price);
        s.low52 = Math.min(s.low52, s.price);
    });

    // Market sentiment drifts
    marketSentiment = Math.max(10, Math.min(90, marketSentiment + (Math.random() * 10 - 5)));
    vix = Math.max(10, Math.min(50, vix + (Math.random() * 4 - 2)));
    fearGreed = Math.max(0, Math.min(100, fearGreed + (Math.random() * 6 - 3)));

    // News events (5% chance per tick)
    if (Math.random() < 0.05) {
        const template = NEWS_TEMPLATES[Math.floor(Math.random() * NEWS_TEMPLATES.length)];
        const stock = getStockBySymbol(template[0]);
        if (stock) {
            stock.price *= (1 + template[2]);
            newsHistory.unshift({ text: template[1], impact: template[2], type: template[3], day: dayCount });
            if (newsHistory.length > 20) newsHistory.pop();
            // Update news ticker
            const ticker = document.getElementById('newsTicker');
            if (ticker) ticker.innerHTML = newsHistory.slice(0,5).map(n =>
                `<span style="color:${n.type==='bullish'?'#22c55e':'#ef4444'}">${n.text}</span>`).join(' &bull; ');
            playNewsAlert();
        }
    }

    // IPO (1% chance)
    if (!pendingIPO && Math.random() < 0.01) {
        const ipos = [
            { symbol:'NOVA', name:'Nova AI Corp', price: 45 + Math.random()*30 },
            { symbol:'QBIT', name:'Quantum Systems', price: 20 + Math.random()*40 },
            { symbol:'MEDS', name:'MedTech Solutions', price: 30 + Math.random()*20 },
        ];
        pendingIPO = ipos[Math.floor(Math.random()*ipos.length)];
        document.getElementById('ipoBanner').classList.remove('hidden');
        document.getElementById('ipoSymbol').textContent = pendingIPO.symbol;
        document.getElementById('ipoName').textContent = pendingIPO.name;
        document.getElementById('ipoPrice').textContent = '$' + pendingIPO.price.toFixed(2);
        playNewsAlert();
    }

    // Dividends (every 7 days)
    if (dayCount % 7 === 0) {
        STOCKS.forEach(s => {
            if (s.dividend > 0 && portfolio[s.symbol] && portfolio[s.symbol].shares > 0) {
                const divAmount = (s.dividend / 52) * portfolio[s.symbol].shares;
                cash += divAmount; totalDividends += divAmount;
            }
        });
        document.getElementById('dividendsEarned').textContent = '$' + totalDividends.toFixed(2);
        document.getElementById('nextDividend').textContent = 'Next: Day ' + (dayCount + 7);
    }

    // Check achievements
    checkAchievements();

    // Track profitable days
    const newPortVal = getPortfolioValue();
    if (newPortVal + cash > prevPortfolioVal + prevCash) profitableDays++;

    updateUI();
    if (autoSaveEnabled && dayCount % 10 === 0) saveGameState();
}

function startMarketDay() {
    dayCount++;
    document.getElementById('dayCounter').textContent = dayCount;
    dayTrades = 0; document.getElementById('dayTrades').textContent = '0/3';
    marketOpen = true;
    document.getElementById('marketStatus').className = 'badge badge-success';
    document.getElementById('marketStatus').textContent = 'üü¢ Open';

    // Process calendar events
    const event = CALENDAR_EVENTS.find(e => e.day === dayCount);
    if (event) {
        showEventPopup(event.name, event.impact, event.type);
        if (event.type === 'fed') { interestRate += (Math.random() - 0.5) * 0.5; }
    }

    updateCalendar();
}

function showEventPopup(title, impact, type) {
    const el = document.createElement('div');
    el.className = 'event-popup';
    el.style.borderLeftColor = impact === 'HIGH' ? '#ef4444' : '#f59e0b';
    el.innerHTML = `<h3 style="font-size:1rem;margin-bottom:6px">üìÖ Market Event</h3>
        <p style="font-size:0.85rem;color:#94a3b8">${title}</p>
        <span class="badge badge-${impact==='HIGH'?'danger':'warning'} mt-2">${impact} IMPACT</span>
        <button onclick="this.parentElement.remove()" style="float:right;background:none;border:none;color:#94a3b8;cursor:pointer">‚úï</button>`;
    document.getElementById('eventContainer').appendChild(el);
    playNewsAlert();
    setTimeout(() => el.remove(), 8000);
}

// ================================================
// PORTFOLIO & TRADING
// ================================================
function getPortfolioValue() {
    return Object.entries(portfolio).reduce((sum, [sym, pos]) => {
        const s = getStockBySymbol(sym);
        return sum + (s ? s.price * pos.shares : 0);
    }, 0);
}

function getTotalWealth() { return cash + getPortfolioValue(); }

function openBuyModal(symbol) {
    const s = getStockBySymbol(symbol);
    if (!s) return;
    selectedStock = s;
    initAudio();

    document.getElementById('tradeModalTitle').textContent = `üõí Buy ${s.symbol}`;
    const pos = portfolio[symbol];
    document.getElementById('tradeModalContent').innerHTML = `
        <div style="background:#1e293b;padding:16px;border-radius:12px;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <span>${s.name}</span>
                <span class="${s.changePct >= 0 ? 'price-up':'price-down'}">${s.changePct >= 0?'+':''}${s.changePct.toFixed(2)}%</span>
            </div>
            <div style="font-size:2rem;font-weight:bold">$${s.price.toFixed(2)}</div>
            ${pos ? `<div style="font-size:0.8rem;color:#94a3b8;margin-top:4px">You own: ${pos.shares} shares @ $${pos.avgCost.toFixed(2)}</div>` : ''}
        </div>
        <div style="margin-bottom:12px">
            <label style="color:#94a3b8;font-size:0.85rem">Shares to buy:</label>
            <input type="number" id="buyShares" min="1" value="1" style="width:100%;margin-top:6px" oninput="updateBuyTotal()" />
        </div>
        <div id="buyTotal" style="font-size:0.9rem;color:#94a3b8;margin-bottom:16px">Total: $${s.price.toFixed(2)}</div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-success" style="flex:1" onclick="executeBuy()">‚úÖ Buy</button>
            <button class="btn btn-secondary" onclick="closeTradeModal()">Cancel</button>
        </div>`;
    document.getElementById('tradeModal').classList.add('active');
}

function updateBuyTotal() {
    const shares = parseInt(document.getElementById('buyShares')?.value) || 0;
    const total = shares * (selectedStock?.price || 0);
    const el = document.getElementById('buyTotal');
    if (el) el.textContent = `Total: $${total.toFixed(2)} | Cash after: $${(cash-total).toFixed(2)}`;
}

function executeBuy() {
    const shares = parseInt(document.getElementById('buyShares')?.value) || 0;
    if (shares <= 0 || !selectedStock) return;
    const total = shares * selectedStock.price;
    if (total > cash) { showToast('‚ùå Insufficient funds!', 'error'); return; }
    cash -= total;
    if (!portfolio[selectedStock.symbol]) portfolio[selectedStock.symbol] = { shares: 0, avgCost: 0, buyDay: dayCount };
    const pos = portfolio[selectedStock.symbol];
    pos.avgCost = (pos.avgCost * pos.shares + total) / (pos.shares + shares);
    pos.shares += shares;
    tradeHistory.unshift({ type:'BUY', symbol:selectedStock.symbol, shares, price:selectedStock.price, total, day:dayCount });
    dayTrades++; totalWins++;
    addTransaction(`BUY ${shares} ${selectedStock.symbol} @ $${selectedStock.price.toFixed(2)}`);
    closeTradeModal();
    playBuy();
    showToast(`‚úÖ Bought ${shares} ${selectedStock.symbol}`, 'success');
    checkAchievements();
    updateUI();
}

function openSellModal(symbol) {
    const s = getStockBySymbol(symbol);
    const pos = portfolio[symbol];
    if (!s || !pos || pos.shares <= 0) return;
    selectedStock = s;

    document.getElementById('tradeModalTitle').textContent = `üí∞ Sell ${s.symbol}`;
    const pnl = (s.price - pos.avgCost) * pos.shares;
    document.getElementById('tradeModalContent').innerHTML = `
        <div style="background:#1e293b;padding:16px;border-radius:12px;margin-bottom:16px">
            <div style="display:flex;justify-content:space-between">
                <span>${s.name}</span>
                <span class="${pnl>=0?'price-up':'price-down'}">${pnl>=0?'+':''}$${pnl.toFixed(2)} P&L</span>
            </div>
            <div style="font-size:2rem;font-weight:bold">$${s.price.toFixed(2)}</div>
            <div style="font-size:0.8rem;color:#94a3b8">You own: ${pos.shares} shares | Avg cost: $${pos.avgCost.toFixed(2)}</div>
        </div>
        <div style="margin-bottom:12px">
            <label style="color:#94a3b8;font-size:0.85rem">Shares to sell:</label>
            <input type="number" id="sellShares" min="1" max="${pos.shares}" value="${pos.shares}" style="width:100%;margin-top:6px" />
        </div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-danger" style="flex:1" onclick="executeSell()">üí∞ Sell</button>
            <button class="btn btn-secondary" onclick="closeTradeModal()">Cancel</button>
        </div>`;
    document.getElementById('tradeModal').classList.add('active');
}

function executeSell() {
    const shares = parseInt(document.getElementById('sellShares')?.value) || 0;
    if (shares <= 0 || !selectedStock) return;
    const pos = portfolio[selectedStock.symbol];
    if (!pos || shares > pos.shares) { showToast('‚ùå Not enough shares!', 'error'); return; }
    const total = shares * selectedStock.price;
    const profit = (selectedStock.price - pos.avgCost) * shares;
    cash += total;
    pos.shares -= shares;
    if (pos.shares === 0) delete portfolio[selectedStock.symbol];
    tradeHistory.unshift({ type:'SELL', symbol:selectedStock.symbol, shares, price:selectedStock.price, total, profit, day:dayCount });
    dayTrades++;
    if (profit > 0) totalWins++; else totalLosses++;
    addTransaction(`SELL ${shares} ${selectedStock.symbol} @ $${selectedStock.price.toFixed(2)} | P&L: ${profit>=0?'+':''}$${profit.toFixed(2)}`);
    closeTradeModal();
    playSell();
    showToast(`üí∞ Sold ${shares} ${selectedStock.symbol} | ${profit>=0?'+':''}$${profit.toFixed(2)}`, profit>=0?'success':'warning');
    updateUI();
}

function closeTradeModal() {
    document.getElementById('tradeModal').classList.remove('active');
    document.getElementById('optionsModal').classList.remove('active');
}

function addToWatchlist(symbol) {
    watchlist.add(symbol);
    showToast(`‚≠ê Added ${symbol} to watchlist`, 'success');
    updateUI();
    checkAchievements();
}

function addToWatchlistPrompt() {
    const sym = prompt('Enter stock symbol to watch:');
    if (sym && getStockBySymbol(sym.toUpperCase())) addToWatchlist(sym.toUpperCase());
    else if (sym) showToast('‚ùå Stock not found', 'error');
}

function buyIPO() {
    if (!pendingIPO) return;
    const cost = Math.floor(pendingIPO.price * 100);
    if (cash < cost) { showToast('‚ùå Insufficient funds!', 'error'); return; }
    cash -= cost;
    // Add as new stock temporarily
    showToast(`üöÄ Bought 100 ${pendingIPO.symbol} @ $${pendingIPO.price.toFixed(2)}`, 'success');
    playBuy();
    document.getElementById('ipoBanner').classList.add('hidden');
    pendingIPO = null;
    unlockAchievement('ipoChaser');
    updateUI();
}

function saveGameState() {
    const data = { cash, portfolio, watchlist:[...watchlist], dayCount, tradeHistory:tradeHistory.slice(0,50), totalDividends };
    localStorage.setItem('stockTycoonSave', JSON.stringify(data));
    lastSaved = new Date();
    const el = document.getElementById('lastSaved');
    if (el) el.textContent = '¬∑ Saved';
    setTimeout(() => { if(el) el.textContent = ''; }, 2000);
}

function loadGameState() {
    const data = localStorage.getItem('stockTycoonSave');
    if (!data) return;
    try {
        const d = JSON.parse(data);
        cash = d.cash || 100000;
        portfolio = d.portfolio || {};
        watchlist = new Set(d.watchlist || []);
        dayCount = d.dayCount || 1;
        tradeHistory = d.tradeHistory || [];
        totalDividends = d.totalDividends || 0;
        updateUI();
    } catch(e) {}
}

function resetGame() {
    if (!confirm('Reset all progress?')) return;
    cash = 100000; portfolio = {}; watchlist = new Set();
    dayCount = 1; tradeHistory = []; totalDividends = 0;
    dayTrades = 0; marginUsed = 0;
    ACHIEVEMENTS.forEach(a => a.unlocked = false);
    updateUI();
    showToast('üîÑ Game reset!', 'info');
}

function toggleAutoSave() {
    autoSaveEnabled = !autoSaveEnabled;
    const btn = document.getElementById('autoSaveBtn');
    if (btn) btn.textContent = autoSaveEnabled ? '‚úÖ Auto' : '‚ùå Auto';
    showToast(autoSaveEnabled ? '‚úÖ Auto-save on' : '‚ùå Auto-save off', 'info');
}

function addTransaction(text) {
    const el = document.getElementById('tradeHistory');
    if (!el) return;
    const div = document.createElement('div');
    div.className = 'news-item';
    div.style.fontSize = '0.75rem';
    div.innerHTML = `<span style="color:#94a3b8">Day ${dayCount}:</span> ${text}`;
    el.prepend(div);
    if (el.children.length > 20) el.lastChild.remove();
}

// ================================================
// UI RENDERING
// ================================================
function updateUI() {
    // Header stats
    document.getElementById('cashDisplay').textContent = '$' + cash.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    const portVal = getPortfolioValue();
    document.getElementById('portfolioValue').textContent = '$' + portVal.toFixed(2);
    const pnl = getTotalWealth() - 100000;
    const pnlEl = document.getElementById('totalPnL');
    pnlEl.textContent = (pnl>=0?'+':'') + '$' + pnl.toFixed(2);
    pnlEl.className = pnl >= 0 ? 'text-xl font-bold text-green-400' : 'text-xl font-bold text-red-400';

    document.getElementById('buyingPower').textContent = '$' + (cash + marginUsed/2).toFixed(2);
    document.getElementById('marginUsed').textContent = '$' + marginUsed.toFixed(2);
    document.getElementById('dayTrades').textContent = dayTrades+'/3';
    document.getElementById('dividendsEarned').textContent = '$' + totalDividends.toFixed(2);

    // Sentiment indicator
    const sentEl = document.getElementById('sentimentIndicator');
    if (sentEl) sentEl.style.left = marketSentiment + '%';
    const sentLabel = document.getElementById('sentimentLabel');
    if (sentLabel) sentLabel.textContent = marketSentiment > 65 ? 'Bullish' : marketSentiment < 35 ? 'Bearish' : 'Neutral';

    // Market indicators
    document.getElementById('fearGreedValue').textContent = Math.round(fearGreed) + ' - ' + (fearGreed>65?'Greed':fearGreed<35?'Fear':'Neutral');
    document.getElementById('fearGreedBar').style.width = fearGreed + '%';
    document.getElementById('vixValue').textContent = vix.toFixed(1);
    document.getElementById('vixBar').style.width = Math.min(100, vix*2) + '%';
    document.getElementById('interestRateValue').textContent = interestRate.toFixed(2) + '%';
    document.getElementById('fedRate').textContent = interestRate.toFixed(2) + '%';
    document.getElementById('inflationRate').textContent = inflationRate.toFixed(1) + '%';
    document.getElementById('unemploymentRate').textContent = unemploymentRate.toFixed(1) + '%';

    renderStockList();
    renderPortfolio();
    renderWatchlist();
    renderNewsFeed();
    renderHeatmap();
    renderAchievements();
    renderSectorPerformance();
    updateOptionsSelect();
}

function renderStockList() {
    const tbody = document.getElementById('stockList');
    if (!tbody) return;
    let stocks = [...STOCKS];
    if (searchQuery) stocks = stocks.filter(s => s.symbol.includes(searchQuery.toUpperCase()) || s.name.toLowerCase().includes(searchQuery));
    if (sectorFilter !== 'all') stocks = stocks.filter(s => s.sector === sectorFilter);
    stocks.sort((a,b) => {
        const av = a[sortField], bv = b[sortField];
        return sortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
    });
    tbody.innerHTML = stocks.map(s => {
        const up = s.changePct >= 0;
        const pos = portfolio[s.symbol];
        const miniHistory = s.history.slice(-10);
        const miniMin = Math.min(...miniHistory), miniMax = Math.max(...miniHistory);
        const points = miniHistory.map((p,i) => `${i*10},${40-((p-miniMin)/(miniMax-miniMin||1))*35}`).join(' ');
        return `<tr class="border-b border-slate-800 hover:bg-slate-800/50 transition-colors">
            <td class="py-3 font-mono font-bold ${up?'text-green-400':'text-red-400'}">${s.symbol}</td>
            <td class="py-3 text-slate-400 text-sm hidden md:table-cell">${s.name}</td>
            <td class="py-3 font-mono">$${s.price.toFixed(s.price>100?2:4)}</td>
            <td class="py-3"><span class="${up?'price-up':'price-down'}">${up?'+':''}${s.changePct.toFixed(2)}%</span></td>
            <td class="py-3 hidden md:table-cell">
                <svg width="90" height="40" style="overflow:visible">
                    <polyline points="${points}" fill="none" stroke="${up?'#22c55e':'#ef4444'}" stroke-width="1.5"/>
                </svg>
            </td>
            <td class="py-3 text-right">
                <div class="flex gap-1 justify-end">
                    <button onclick="openBuyModal('${s.symbol}')" class="btn btn-success text-xs px-2 py-1">Buy</button>
                    ${pos ? `<button onclick="openSellModal('${s.symbol}')" class="btn btn-danger text-xs px-2 py-1">Sell</button>` : ''}
                    <button onclick="addToWatchlist('${s.symbol}')" class="btn btn-secondary text-xs px-2 py-1">‚≠ê</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function renderPortfolio() {
    const el = document.getElementById('holdingsList');
    if (!el) return;
    const entries = Object.entries(portfolio).filter(([,p]) => p.shares > 0);
    if (entries.length === 0) {
        el.innerHTML = '<div class="text-center text-slate-500 py-8"><p class="text-4xl mb-3">üì≠</p><p>No holdings yet. Start trading!</p></div>';
        return;
    }
    el.innerHTML = entries.map(([sym, pos]) => {
        const s = getStockBySymbol(sym);
        if (!s) return '';
        const val = s.price * pos.shares;
        const pnl = (s.price - pos.avgCost) * pos.shares;
        const pnlPct = ((s.price - pos.avgCost) / pos.avgCost * 100);
        return `<div class="bg-slate-800/50 rounded-xl p-4 flex justify-between items-center hover:bg-slate-800 transition">
            <div>
                <p class="font-bold">${sym} <span class="text-slate-400 text-sm font-normal">${s.name}</span></p>
                <p class="text-sm text-slate-400">${pos.shares} shares ¬∑ Avg $${pos.avgCost.toFixed(2)}</p>
            </div>
            <div class="text-right">
                <p class="font-mono font-bold">$${val.toFixed(2)}</p>
                <p class="text-sm ${pnl>=0?'price-up':'price-down'}">${pnl>=0?'+':''}$${pnl.toFixed(2)} (${pnlPct.toFixed(2)}%)</p>
                <div class="flex gap-1 mt-1">
                    <button onclick="openBuyModal('${sym}')" class="btn btn-success text-xs px-2 py-1">Buy</button>
                    <button onclick="openSellModal('${sym}')" class="btn btn-danger text-xs px-2 py-1">Sell</button>
                </div>
            </div>
        </div>`;
    }).join('');

    // Performance metrics
    const total = getPortfolioValue();
    const totalPnl = total - Object.entries(portfolio).reduce((s,[,p])=>s+p.avgCost*p.shares,0);
    document.getElementById('totalReturn').textContent = ((totalPnl / 100000)*100).toFixed(2) + '%';
    document.getElementById('annualizedReturn').textContent = ((totalPnl / 100000 * 365 / dayCount)*100).toFixed(2) + '%';

    const performers = entries.map(([sym,pos]) => {
        const s = getStockBySymbol(sym);
        return { sym, pnl: s ? (s.price-pos.avgCost)*pos.shares : 0 };
    }).sort((a,b) => b.pnl-a.pnl);
    if (performers.length > 0) {
        document.getElementById('bestPerformer').textContent = performers[0].sym + ' +$' + performers[0].pnl.toFixed(0);
        document.getElementById('worstPerformer').textContent = performers[performers.length-1].sym + ' $' + performers[performers.length-1].pnl.toFixed(0);
    }
    const winRate = totalWins + totalLosses > 0 ? (totalWins / (totalWins+totalLosses)*100).toFixed(0) : 0;
    document.getElementById('statWinRate').textContent = winRate + '%';
    document.getElementById('statTotalTrades').textContent = tradeHistory.length;
    document.getElementById('statProfitableDays').textContent = profitableDays;
}

function renderWatchlist() {
    const el = document.getElementById('watchlistContainer');
    if (!el) return;
    if (watchlist.size === 0) {
        el.innerHTML = '<div class="text-center text-slate-500 py-8"><p class="text-4xl mb-3">‚≠ê</p><p>Your watchlist is empty.</p></div>';
        return;
    }
    el.innerHTML = [...watchlist].map(sym => {
        const s = getStockBySymbol(sym);
        if (!s) return '';
        return `<div class="flex justify-between items-center bg-slate-800/50 p-4 rounded-xl">
            <div><p class="font-bold">${s.symbol}</p><p class="text-sm text-slate-400">${s.name}</p></div>
            <div class="text-right">
                <p class="font-mono">$${s.price.toFixed(2)}</p>
                <p class="${s.changePct>=0?'price-up':'price-down'}">${s.changePct>=0?'+':''}${s.changePct.toFixed(2)}%</p>
            </div>
            <div class="flex gap-1">
                <button onclick="openBuyModal('${sym}')" class="btn btn-success text-xs px-2 py-1">Buy</button>
                <button onclick="watchlist.delete('${sym}');updateUI()" class="btn btn-secondary text-xs px-2 py-1">‚úï</button>
            </div>
        </div>`;
    }).join('');
}

function renderNewsFeed() {
    const el = document.getElementById('newsFeed');
    if (!el) return;
    if (newsHistory.length === 0) { el.innerHTML = '<p class="text-slate-500 text-center">No news yet</p>'; return; }
    el.innerHTML = newsHistory.map(n => `
        <div class="news-item" style="border-left-color:${n.type==='bullish'?'#22c55e':'#ef4444'}">
            <p class="text-sm">${n.text}</p>
            <p class="text-xs text-slate-500 mt-1">Day ${n.day} ¬∑ <span class="${n.type==='bullish'?'text-green-400':'text-red-400'}">${n.impact>=0?'+':''}${(n.impact*100).toFixed(1)}%</span></p>
        </div>`).join('');
}

function renderHeatmap() {
    const el = document.getElementById('marketHeatmap');
    if (!el) return;
    el.innerHTML = STOCKS.map(s => {
        const intensity = Math.min(100, Math.abs(s.changePct) * 10);
        const bg = s.changePct >= 0 ? `rgba(34,197,94,${intensity/100})` : `rgba(239,68,68,${intensity/100})`;
        return `<div class="heatmap-cell p-3 rounded-lg text-center" style="background:${bg};min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center"
            onclick="openBuyModal('${s.symbol}')">
            <div class="font-bold text-sm">${s.symbol}</div>
            <div class="text-xs ${s.changePct>=0?'text-green-300':'text-red-300'}">${s.changePct>=0?'+':''}${s.changePct.toFixed(1)}%</div>
        </div>`;
    }).join('');
}

function renderAchievements() {
    const el = document.getElementById('achievementsGrid');
    if (!el) return;
    el.innerHTML = ACHIEVEMENTS.map(a => `
        <div class="flex flex-col items-center gap-2">
            <div class="achievement-badge ${a.unlocked?'unlocked':'locked'}">
                ${a.icon}
                <div class="achievement-tooltip">${a.name}: ${a.desc}</div>
            </div>
            <p class="text-xs text-center ${a.unlocked?'text-white':'text-slate-500'}">${a.name}</p>
        </div>`).join('');
}

function renderSectorPerformance() {
    const el = document.getElementById('sectorPerformance');
    if (!el) return;
    const sectors = {};
    STOCKS.forEach(s => {
        if (!sectors[s.sector]) sectors[s.sector] = { total: 0, count: 0 };
        sectors[s.sector].total += s.changePct;
        sectors[s.sector].count++;
    });
    el.innerHTML = Object.entries(sectors).map(([name, d]) => {
        const avg = d.total / d.count;
        return `<div class="flex justify-between items-center">
            <span class="text-slate-400 capitalize">${name}</span>
            <span class="${avg>=0?'price-up':'price-down'}">${avg>=0?'+':''}${avg.toFixed(2)}%</span>
        </div>`;
    }).join('');
}

function updateOptionsSelect() {
    const el = document.getElementById('optionsStockSelect');
    if (!el || el.options.length > 1) return;
    STOCKS.forEach(s => { const o = document.createElement('option'); o.value = s.symbol; o.textContent = s.symbol + ' - ' + s.name; el.add(o); });
}

function updateOptionsChain() {
    const sym = document.getElementById('optionsStockSelect')?.value;
    const s = sym ? getStockBySymbol(sym) : null;
    const el = document.getElementById('optionsChain');
    if (!el) return;
    if (!s) { el.innerHTML = '<div class="text-center text-slate-500 py-8"><p>Select a stock to view options</p></div>'; return; }
    const strikes = [-20,-10,-5,0,5,10,20].map(d => s.price + d);
    el.innerHTML = `<div class="grid grid-cols-4 gap-2 text-xs text-slate-500 font-bold mb-2 px-2">
        <span>Strike</span><span>Call</span><span>Put</span><span>Action</span></div>` +
    strikes.map(strike => {
        const callPremium = Math.max(0.5, (s.price - strike) * 0.1 + Math.random()*2).toFixed(2);
        const putPremium = Math.max(0.5, (strike - s.price) * 0.1 + Math.random()*2).toFixed(2);
        return `<div class="grid grid-cols-4 gap-2 items-center py-2 px-2 rounded hover:bg-slate-800/50">
            <span class="font-mono">$${strike.toFixed(0)}</span>
            <span class="price-up">$${callPremium}</span>
            <span class="price-down">$${putPremium}</span>
            <div class="flex gap-1">
                <button onclick="showToast('üìä Options not yet implemented','info')" class="text-xs px-2 py-1 bg-green-600 rounded">Call</button>
                <button onclick="showToast('üìä Options not yet implemented','info')" class="text-xs px-2 py-1 bg-red-600 rounded">Put</button>
            </div>
        </div>`;
    }).join('');
}

function updateCalendar() {
    const el = document.getElementById('calendarEvents');
    if (!el) return;
    el.innerHTML = CALENDAR_EVENTS.map(e => {
        const daysAway = e.day - dayCount;
        const past = daysAway < 0;
        return `<div class="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50 ${past?'opacity-50':''}">
            <span class="text-2xl">${e.type==='fed'?'üè¶':e.type==='earnings'?'üìä':'üìà'}</span>
            <div>
                <p class="font-bold text-sm">${e.name}</p>
                <p class="text-xs text-slate-400">${past?'Past':'In '+daysAway+' days'} ¬∑ <span class="badge badge-${e.impact==='HIGH'?'danger':'warning'}">${e.impact}</span></p>
            </div>
        </div>`;
    }).join('');
}

// ================================================
// ACHIEVEMENT SYSTEM
// ================================================
function unlockAchievement(id) {
    const a = ACHIEVEMENTS.find(a => a.id === id);
    if (!a || a.unlocked) return;
    a.unlocked = true;
    showToast(`üèÜ Achievement: ${a.name}`, 'success');
    playBuy();
}

function checkAchievements() {
    if (tradeHistory.length >= 1) unlockAchievement('firstTrade');
    if (getTotalWealth() >= 1000000) unlockAchievement('millionaire');
    if (dayTrades >= 3) unlockAchievement('dayTrader');
    if (Object.keys(portfolio).length >= 5) unlockAchievement('diversified');
    if (watchlist.size >= 5) unlockAchievement('watchlistPro');
    if (tradeHistory.length > 0 && tradeHistory[0].type === 'BUY' && tradeHistory[0].total >= 50000) unlockAchievement('bigBuy');
}

// ================================================
// TAB & SEARCH
// ================================================
function switchTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('onclick')?.includes(`'${tab}'`)));
    document.querySelectorAll('[id$="Tab"]').forEach(el => el.classList.add('hidden'));
    const el = document.getElementById(tab + 'Tab');
    if (el) el.classList.remove('hidden');
}

function sortStocks(field) {
    if (sortField === field) sortAsc = !sortAsc; else { sortField = field; sortAsc = true; }
    renderStockList();
}

function searchStocks() {
    searchQuery = document.getElementById('stockSearch')?.value?.toLowerCase() || '';
    renderStockList();
}

function filterBySector() {
    sectorFilter = document.getElementById('sectorFilter')?.value || 'all';
    renderStockList();
}

function showToast(msg, type='info') {
    const el = document.createElement('div');
    el.className = `event-popup`;
    el.style.borderLeftColor = type==='success'?'#22c55e':type==='error'?'#ef4444':'#3b82f6';
    el.innerHTML = msg;
    document.getElementById('eventContainer').appendChild(el);
    if (type === 'success') playAlert(true); else if (type === 'error') playAlert(false);
    setTimeout(() => el.remove(), 3000);
}

// ================================================
// KEYBOARD SHORTCUTS
// ================================================
document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT') return;
    const tabs = { m:'market', p:'portfolio', o:'options', w:'watchlist', n:'news', c:'calendar', x:'margin', h:'heatmap', a:'achievements' };
    if (tabs[e.key.toLowerCase()]) switchTab(tabs[e.key.toLowerCase()]);
    if (e.key.toLowerCase() === 'q') toggleMusic();
    if (e.key.toLowerCase() === 's' && !e.ctrlKey) saveGameState();
    if (e.key === 'Escape') closeTradeModal();
    if (e.key === 'F5') { e.preventDefault(); startMarketDay(); }
});

// ================================================
// NEWS TICKER ANIMATION
// ================================================
function animateTicker() {
    const ticker = document.getElementById('newsTicker');
    if (!ticker) return;
    let pos = 0;
    setInterval(() => {
        pos -= 1;
        if (pos < -ticker.scrollWidth) pos = window.innerWidth;
        ticker.style.transform = `translateX(${pos}px)`;
    }, 30);
}

// ================================================
// INIT & GAME LOOP
// ================================================
window.addEventListener('load', () => {
    loadGameState();
    updateUI();
    animateTicker();
    updateCalendar();

    // Market update every 3 seconds = 1 game day
    setInterval(() => {
        startMarketDay();
        updateMarket();
    }, 3000);

    // Welcome message
    setTimeout(() => showToast('üìà Market open! Press Q for music, M/P/N/H for tabs.', 'info'), 1000);
});

    </script>
</body>
</html>
