<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falling Sand - Physics Sandbox</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --border: #2a2a3a;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }
        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        .container { display: flex; height: 100vh; }

        /* â”€â”€ Sidebar â”€â”€ */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex-shrink: 0;
        }
        .sidebar h1 {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-sub { color: var(--text-muted); font-size: 12px; }

        .section-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        /* element grid */
        .element-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .element-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            background: var(--bg-hover);
            border-radius: 8px;
            cursor: pointer;
            transition: transform .15s, border-color .15s, box-shadow .15s;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 3px; padding: 6px;
        }
        .element-btn:hover { transform: scale(1.06); border-color: rgba(99,102,241,.6); }
        .element-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 16px rgba(99,102,241,.4);
        }
        .element-icon { width: 22px; height: 22px; border-radius: 4px; }
        .element-name { font-size: 9px; font-weight: 600; color: var(--text-muted); }

        /* element colours */
        .sand      { background: #fbbf24; }
        .water     { background: #3b82f6; }
        .fire      { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .oil       { background: #78350f; }
        .stone     { background: #6b7280; }
        .plant     { background: #22c55e; }
        .acid      { background: #a3e635; }
        .salt      { background: #f8fafc; }
        .steam     { background: rgba(220,220,220,.7); }
        .lava      { background: #f97316; box-shadow: 0 0 10px #f97316; }
        .gunpowder { background: #374151; }
        .ice       { background: #67e8f9; }
        .void      { background: #000; border: 1px solid #555; }
        .wood      { background: #92400e; }
        .glass     { background: rgba(186,230,253,.5); border: 1px solid #7dd3fc; }
        .cloud     { background: #e2e8f0; }

        /* brush size */
        .brush-row { display: flex; gap: 6px; }
        .size-btn {
            flex: 1; padding: 7px 4px;
            background: var(--bg-hover); border: 1px solid var(--border);
            color: var(--text); border-radius: 6px; cursor: pointer;
            font-size: 11px; transition: background .15s, border-color .15s;
        }
        .size-btn:hover, .size-btn.active {
            background: var(--primary); border-color: var(--primary);
        }

        /* action / sound buttons */
        .btn-row { display: flex; gap: 6px; }
        .action-btn {
            flex: 1; padding: 9px 6px;
            background: var(--bg-hover); border: 1px solid var(--border);
            color: var(--text); border-radius: 6px; cursor: pointer;
            font-size: 11px; transition: background .15s;
        }
        .action-btn:hover { background: var(--primary); border-color: var(--primary); }
        .action-btn.sound-active {
            background: linear-gradient(135deg,#8b5cf6,#6366f1);
            border-color: #8b5cf6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(139,92,246,.4); }
            50%      { box-shadow: 0 0 0 8px rgba(139,92,246,0); }
        }

        /* info panel */
        .info-panel {
            background: var(--bg-hover); border-radius: 8px;
            padding: 12px; font-size: 11px;
            color: var(--text-muted); line-height: 1.6;
        }
        .info-panel strong { color: var(--text); display: block; margin-bottom: 6px; }

        /* shortcuts */
        .shortcuts {
            font-size: 10px; color: var(--text-muted); line-height: 1.8;
        }
        .shortcuts kbd {
            background: var(--bg-dark); border: 1px solid var(--border);
            border-radius: 3px; padding: 1px 5px; font-size: 10px;
        }

        /* â”€â”€ Canvas area â”€â”€ */
        .canvas-container {
            flex: 1; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0f 100%);
            position: relative;
        }
        #canvas {
            border: 2px solid var(--border); border-radius: 6px;
            box-shadow: 0 0 60px rgba(0,0,0,.6), 0 0 120px rgba(99,102,241,.08);
            cursor: crosshair; image-rendering: pixelated;
        }

        /* HUD */
        .hud {
            position: absolute; top: 16px; right: 16px;
            background: rgba(18,18,26,.92); backdrop-filter: blur(8px);
            padding: 12px 16px; border-radius: 10px;
            border: 1px solid var(--border); font-size: 12px;
            color: var(--text-muted); min-width: 120px;
        }
        .hud span { color: var(--text); font-weight: 600; }
        .hud .cur-elem {
            margin-top: 6px; padding-top: 6px;
            border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 6px;
        }
        .cur-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

        /* current-element tooltip bottom */
        .bottom-bar {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; pointer-events: none;
        }
        .bottom-chip {
            background: rgba(18,18,26,.88); border: 1px solid var(--border);
            padding: 4px 12px; border-radius: 20px; font-size: 11px;
            color: var(--text-muted); white-space: nowrap;
        }
    </style>
</head>
<body>
<div class="container">

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="sidebar">
    <div>
      <h1>ğŸ’ Falling Sand</h1>
      <div class="sidebar-sub">Physics sandbox Â· 16 elements</div>
    </div>

    <!-- Elements -->
    <div>
      <div class="section-label">Elements</div>
      <div class="element-grid" id="elementGrid">
        <button class="element-btn active" data-element="sand">
          <div class="element-icon sand"></div>
          <span class="element-name">Sand</span>
        </button>
        <button class="element-btn" data-element="water">
          <div class="element-icon water"></div>
          <span class="element-name">Water</span>
        </button>
        <button class="element-btn" data-element="fire">
          <div class="element-icon fire"></div>
          <span class="element-name">Fire</span>
        </button>
        <button class="element-btn" data-element="oil">
          <div class="element-icon oil"></div>
          <span class="element-name">Oil</span>
        </button>
        <button class="element-btn" data-element="stone">
          <div class="element-icon stone"></div>
          <span class="element-name">Stone</span>
        </button>
        <button class="element-btn" data-element="plant">
          <div class="element-icon plant"></div>
          <span class="element-name">Plant</span>
        </button>
        <button class="element-btn" data-element="acid">
          <div class="element-icon acid"></div>
          <span class="element-name">Acid</span>
        </button>
        <button class="element-btn" data-element="salt">
          <div class="element-icon salt"></div>
          <span class="element-name">Salt</span>
        </button>
        <button class="element-btn" data-element="steam">
          <div class="element-icon steam"></div>
          <span class="element-name">Steam</span>
        </button>
        <button class="element-btn" data-element="lava">
          <div class="element-icon lava"></div>
          <span class="element-name">Lava</span>
        </button>
        <button class="element-btn" data-element="gunpowder">
          <div class="element-icon gunpowder"></div>
          <span class="element-name">TNT</span>
        </button>
        <button class="element-btn" data-element="ice">
          <div class="element-icon ice"></div>
          <span class="element-name">Ice</span>
        </button>
        <button class="element-btn" data-element="wood">
          <div class="element-icon wood"></div>
          <span class="element-name">Wood</span>
        </button>
        <button class="element-btn" data-element="cloud">
          <div class="element-icon cloud"></div>
          <span class="element-name">Cloud</span>
        </button>
        <button class="element-btn" data-element="glass">
          <div class="element-icon glass"></div>
          <span class="element-name">Glass</span>
        </button>
        <button class="element-btn" data-element="void">
          <div class="element-icon void"></div>
          <span class="element-name">Void</span>
        </button>
      </div>
    </div>

    <!-- Brush size -->
    <div>
      <div class="section-label">Brush Size</div>
      <div class="brush-row">
        <button class="size-btn" data-size="1">Â·</button>
        <button class="size-btn active" data-size="3">S</button>
        <button class="size-btn" data-size="6">M</button>
        <button class="size-btn" data-size="12">L</button>
        <button class="size-btn" data-size="20">XL</button>
      </div>
    </div>

    <!-- Actions & Sound -->
    <div>
      <div class="section-label">Actions</div>
      <div class="btn-row">
        <button class="action-btn" id="btnClear">ğŸ—‘ Clear</button>
        <button class="action-btn" id="btnPause">â¸ Pause</button>
      </div>
      <div class="btn-row" style="margin-top:6px">
        <button class="action-btn" id="btnMusic">ğŸµ Music</button>
        <button class="action-btn" id="btnSFX">ğŸ”Š SFX</button>
      </div>
      <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
        <span style="font-size:11px;color:var(--text-muted)">Vol</span>
        <input type="range" id="volSlider" min="0" max="100" value="25"
               style="flex:1; accent-color:var(--primary);">
      </div>
    </div>

    <!-- Interactions -->
    <div class="info-panel">
      <strong>âš—ï¸ Reactions</strong>
      ğŸ”¥ Fire burns Plant / Oil / Wood<br>
      ğŸ’§ Water extinguishes Fire<br>
      ğŸ§ª Acid dissolves most solids<br>
      ğŸŒ‹ Lava melts Ice Â· ignites Plant<br>
      ğŸ’¥ TNT explodes near Fire<br>
      â˜ï¸ Cloud spawns Water drops<br>
      ğŸŒŠ Salt dissolves in Water<br>
      ğŸ§Š Ice melts near Lava/Fire
    </div>

    <!-- Shortcuts -->
    <div class="shortcuts">
      <strong style="color:var(--text);font-size:11px">âŒ¨ï¸ Keys</strong><br>
      <kbd>Space</kbd> Pause/Resume<br>
      <kbd>C</kbd> Clear canvas<br>
      <kbd>M</kbd> Toggle music<br>
      <kbd>S</kbd> Toggle SFX<br>
      <kbd>1-9 / Q-P</kbd> Elements<br>
      <kbd>[</kbd> / <kbd>]</kbd> Brush size
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="canvas-container">
    <canvas id="canvas"></canvas>

    <div class="hud">
      FPS: <span id="fps">60</span><br>
      Particles: <span id="pcount">0</span>
      <div class="cur-elem">
        <div class="cur-dot" id="curDot"></div>
        <span id="curName" style="color:var(--text);font-size:11px">Sand</span>
      </div>
    </div>

    <div class="bottom-bar">
      <div class="bottom-chip" id="modeChip">â–¶ Running</div>
      <div class="bottom-chip" id="soundChip">ğŸ”Š SFX On</div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class SandAudio {
    constructor() {
        this.actx = null;
        this.master = null;
        this.sfxGain = null;
        this.musicGain = null;
        this.musicOn = false;
        this.sfxOn = true;
        this.vol = 0.25;

        // cooldown timers (seconds)
        this.cd = { fire:0, water:0, acid:0, explosion:0, steam:0, lava:0, ice:0, plant:0 };

        // ambient nodes
        this.ambientFire = null;
        this.ambientWater = null;
        this.beatTimer = null;
    }

    _init() {
        if (this.actx) return;
        this.actx = new (window.AudioContext || window.webkitAudioContext)();
        const comp = this.actx.createDynamicsCompressor();
        comp.threshold.value = -18; comp.ratio.value = 4;
        comp.connect(this.actx.destination);
        this.master = this.actx.createGain();
        this.master.gain.value = this.vol;
        this.master.connect(comp);
        this.sfxGain = this.actx.createGain();
        this.sfxGain.gain.value = 1;
        this.sfxGain.connect(this.master);
        this.musicGain = this.actx.createGain();
        this.musicGain.gain.value = 0;
        this.musicGain.connect(this.master);
    }

    setVol(v) {
        this.vol = v;
        if (this.master) this.master.gain.linearRampToValueAtTime(v, this.actx.currentTime + 0.05);
    }

    // â”€â”€ noise buffer helper
    _noise(dur, filterFreq = 1200, filterType = 'lowpass') {
        const s = this.actx.sampleRate, n = Math.ceil(s * dur);
        const buf = this.actx.createBuffer(1, n, s);
        const d = buf.getChannelData(0);
        let b0=0,b1=0,b2=0,b3=0,b4=0;
        for (let i=0;i<n;i++){
            const w = Math.random()*2-1;
            b0=.99886*b0+w*.0555; b1=.99332*b1+w*.0751;
            b2=.96900*b2+w*.1539; b3=.86650*b3+w*.3105;
            b4=.55000*b4+w*.5330;
            d[i] = (b0+b1+b2+b3+b4+w*.5362) * .12;
        }
        const src = this.actx.createBufferSource();
        src.buffer = buf;
        const flt = this.actx.createBiquadFilter();
        flt.type = filterType; flt.frequency.value = filterFreq;
        src.connect(flt);
        return { src, flt };
    }

    _osc(type, freq, startFreq, endFreq, dur, gain, attack=0.005, decay=0.9) {
        const now = this.actx.currentTime;
        const osc = this.actx.createOscillator();
        const g   = this.actx.createGain();
        osc.type = type;
        if (startFreq !== undefined) {
            osc.frequency.setValueAtTime(startFreq, now);
            osc.frequency.exponentialRampToValueAtTime(endFreq, now + dur);
        } else {
            osc.frequency.value = freq;
        }
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(gain, now + attack);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
        osc.connect(g); g.connect(this.sfxGain);
        osc.start(now); osc.stop(now + dur + 0.05);
    }

    // â”€â”€ SFX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fire(intensity=1) {
        if (!this.sfxOn || !this.actx || this.cd.fire > 0) return;
        this.cd.fire = 0.12;
        const now = this.actx.currentTime;
        const {src,flt} = this._noise(.25, 800+Math.random()*400);
        const g = this.actx.createGain();
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(.06*intensity, now+.03);
        g.gain.exponentialRampToValueAtTime(.0001, now+.25);
        flt.connect(g); g.connect(this.sfxGain);
        src.start(now); src.stop(now+.3);
    }

    water(intensity=1) {
        if (!this.sfxOn || !this.actx || this.cd.water > 0) return;
        this.cd.water = 0.15;
        const now = this.actx.currentTime;
        const f = 600 + Math.random()*800;
        this._osc('sine', 0, f, f*0.6, .18, .03*intensity, .01);
    }

    steam() {
        if (!this.sfxOn || !this.actx || this.cd.steam > 0) return;
        this.cd.steam = 0.3;
        const now = this.actx.currentTime;
        const {src,flt} = this._noise(.4, 3000, 'highpass');
        const g = this.actx.createGain();
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(.04, now+.05);
        g.gain.exponentialRampToValueAtTime(.0001, now+.4);
        flt.connect(g); g.connect(this.sfxGain);
        src.start(now); src.stop(now+.45);
    }

    explosion() {
        if (!this.sfxOn || !this.actx || this.cd.explosion > 0) return;
        this.cd.explosion = 0.5;
        const now = this.actx.currentTime;
        // low boom
        this._osc('sine', 0, 220, 30, .6, .35, .002);
        // noise burst
        const {src,flt} = this._noise(.5, 1500);
        const g = this.actx.createGain();
        g.gain.setValueAtTime(.5, now);
        g.gain.exponentialRampToValueAtTime(.0001, now+.5);
        flt.connect(g); g.connect(this.sfxGain);
        src.start(now); src.stop(now+.55);
    }

    acid() {
        if (!this.sfxOn || !this.actx || this.cd.acid > 0) return;
        this.cd.acid = 0.2;
        const now = this.actx.currentTime;
        // sizzle
        const {src,flt} = this._noise(.3, 4000, 'bandpass');
        const g = this.actx.createGain();
        g.gain.setValueAtTime(.03, now);
        g.gain.exponentialRampToValueAtTime(.0001, now+.3);
        flt.connect(g); g.connect(this.sfxGain);
        src.start(now); src.stop(now+.35);
    }

    lava() {
        if (!this.sfxOn || !this.actx || this.cd.lava > 0) return;
        this.cd.lava = 0.35;
        const now = this.actx.currentTime;
        this._osc('sawtooth', 0, 80, 40, .4, .04, .01);
    }

    iceMelt() {
        if (!this.sfxOn || !this.actx || this.cd.ice > 0) return;
        this.cd.ice = 0.25;
        const now = this.actx.currentTime;
        this._osc('triangle', 0, 1800, 400, .2, .03, .005);
    }

    plantGrow() {
        if (!this.sfxOn || !this.actx || this.cd.plant > 0) return;
        this.cd.plant = 0.4;
        const now = this.actx.currentTime;
        [0, .05, .1].forEach((dt, i) => {
            const f = 600 + i*200;
            const osc = this.actx.createOscillator();
            const g   = this.actx.createGain();
            osc.type = 'sine'; osc.frequency.value = f;
            g.gain.setValueAtTime(0, now+dt);
            g.gain.linearRampToValueAtTime(.015, now+dt+.02);
            g.gain.exponentialRampToValueAtTime(.0001, now+dt+.15);
            osc.connect(g); g.connect(this.sfxGain);
            osc.start(now+dt); osc.stop(now+dt+.2);
        });
    }

    tick(dt) {
        for (const k in this.cd) { if (this.cd[k] > 0) this.cd[k] -= dt; }
    }

    // â”€â”€ AMBIENT MUSIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    startMusic() {
        if (!this.actx) return;
        // Fade in music gain
        this.musicGain.gain.cancelScheduledValues(this.actx.currentTime);
        this.musicGain.gain.linearRampToValueAtTime(.5, this.actx.currentTime + 2);
        // Soft pulsing pad
        this._startPad();
        // Subtle beat
        this._scheduleBeat(this.actx.currentTime);
    }

    stopMusic() {
        if (!this.actx) return;
        this.musicGain.gain.cancelScheduledValues(this.actx.currentTime);
        this.musicGain.gain.linearRampToValueAtTime(0, this.actx.currentTime + 1.5);
        clearTimeout(this.beatTimer);
        this.beatTimer = null;
        if (this._padOsc) { try { this._padOsc.stop(this.actx.currentTime+1.5); } catch(e){} }
        if (this._padLfo) { try { this._padLfo.stop(); } catch(e){} }
    }

    _startPad() {
        // Warm drone on tonic (A2 = 110 Hz) with slow filter sweep
        const now = this.actx.currentTime;
        const osc = this.actx.createOscillator();
        const osc2 = this.actx.createOscillator();
        osc.type  = 'sawtooth'; osc.frequency.value = 110;
        osc2.type = 'sawtooth'; osc2.frequency.value = 111.5; // subtle beat
        const flt = this.actx.createBiquadFilter();
        flt.type = 'lowpass'; flt.frequency.value = 400; flt.Q.value = 2;
        // LFO on filter
        const lfo = this.actx.createOscillator();
        const lfoG = this.actx.createGain();
        lfo.frequency.value = 0.08; lfoG.gain.value = 300;
        lfo.connect(lfoG); lfoG.connect(flt.frequency);
        const g = this.actx.createGain(); g.gain.value = 0.18;
        [osc,osc2].forEach(o => o.connect(flt));
        flt.connect(g); g.connect(this.musicGain);
        osc.start(now); osc2.start(now); lfo.start(now);
        this._padOsc = osc; this._padOsc2 = osc2; this._padLfo = lfo;
    }

    _scheduleBeat(t) {
        if (!this.musicOn) return;
        const bpm = 72, beat = 60/bpm;
        let step = 0;
        const pattern = [1,0,0,1,0,1,0,0]; // kick pattern

        const scheduleOne = (when, isKick) => {
            if (!this.actx) return;
            if (isKick) {
                // Sub kick
                const osc = this.actx.createOscillator();
                const g   = this.actx.createGain();
                osc.frequency.setValueAtTime(80, when);
                osc.frequency.exponentialRampToValueAtTime(35, when+.12);
                g.gain.setValueAtTime(.3, when);
                g.gain.exponentialRampToValueAtTime(.0001, when+.18);
                osc.connect(g); g.connect(this.musicGain);
                osc.start(when); osc.stop(when+.2);
            } else {
                // Hi-hat click
                const buf = this.actx.createBuffer(1, Math.ceil(this.actx.sampleRate*.04), this.actx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const src = this.actx.createBufferSource(); src.buffer = buf;
                const flt = this.actx.createBiquadFilter(); flt.type='highpass'; flt.frequency.value=8000;
                const g   = this.actx.createGain();
                g.gain.setValueAtTime(.06, when);
                g.gain.exponentialRampToValueAtTime(.0001, when+.04);
                src.connect(flt); flt.connect(g); g.connect(this.musicGain);
                src.start(when); src.stop(when+.05);
            }
        };

        const loop = () => {
            if (!this.musicOn) return;
            const now = this.actx.currentTime;
            const window = 0.2;
            while (t < now + window) {
                scheduleOne(t, !!pattern[step % pattern.length]);
                t += beat * 0.5;
                step++;
            }
            this.beatTimer = setTimeout(loop, 80);
        };
        loop();
    }

    toggleMusic() {
        this._init();
        this.musicOn = !this.musicOn;
        if (this.musicOn) this.startMusic(); else this.stopMusic();
        return this.musicOn;
    }

    toggleSFX() {
        this._init();
        this.sfxOn = !this.sfxOn;
        return this.sfxOn;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIMULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EMPTY=0,SAND=1,WATER=2,FIRE=3,OIL=4,STONE=5,
      PLANT=6,ACID=7,SALT=8,STEAM=9,LAVA=10,GUNPOWDER=11,
      ICE=12,WOOD=13,CLOUD=14,GLASS=15,VOID=16;

const ELEM_MAP = {
    sand:SAND,water:WATER,fire:FIRE,oil:OIL,stone:STONE,
    plant:PLANT,acid:ACID,salt:SALT,steam:STEAM,lava:LAVA,
    gunpowder:GUNPOWDER,ice:ICE,wood:WOOD,cloud:CLOUD,glass:GLASS,void:VOID
};

// base RGB [r,g,b]  â€“ with variance applied per-pixel
const BASE = {
    [EMPTY]:     [10,10,15],
    [SAND]:      [251,191,36],
    [WATER]:     [59,130,246],
    [FIRE]:      [239,68,68],
    [OIL]:       [120,53,15],
    [STONE]:     [107,114,128],
    [PLANT]:     [34,197,94],
    [ACID]:      [163,230,53],
    [SALT]:      [240,245,255],
    [STEAM]:     [190,200,215],
    [LAVA]:      [249,115,22],
    [GUNPOWDER]: [55,65,81],
    [ICE]:       [103,232,249],
    [WOOD]:      [146,64,14],
    [CLOUD]:     [226,232,240],
    [GLASS]:     [186,230,253],
    [VOID]:      [0,0,0],
};

const DENSITY = {
    [EMPTY]:0,[STEAM]:1,[FIRE]:2,[CLOUD]:3,
    [ACID]:10,[WATER]:15,[OIL]:12,
    [SAND]:20,[SALT]:22,[GUNPOWDER]:18,
    [PLANT]:25,[ICE]:30,[GLASS]:32,[STONE]:40,[LAVA]:35,[WOOD]:38,[VOID]:50,
};

// canvas / simulation sizing
const SCALE = 2;
let W = 0, H = 0;
let grid, life, updated;

const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d', {alpha:false});
let offCanvas, offCtx;

function resize() {
    const cont = canvas.parentElement;
    // fit simulation inside container, keep aspect ratio ~4:3
    const cw = cont.clientWidth - 16, ch = cont.clientHeight - 16;
    const sw = Math.floor(Math.min(cw, ch * (4/3)) / SCALE);
    const sh = Math.floor(Math.min(ch, cw * (3/4)) / SCALE);
    W = sw; H = sh;
    canvas.width  = W * SCALE;
    canvas.height = H * SCALE;
    grid    = new Uint8Array(W * H);
    life    = new Uint8Array(W * H);
    updated = new Uint8Array(W * H);
    offCanvas = document.createElement('canvas');
    offCanvas.width = W; offCanvas.height = H;
    offCtx = offCanvas.getContext('2d', {alpha:false});
}

const gi = (x,y) => y*W+x;
const ok = (x,y) => x>=0&&x<W&&y>=0&&y<H;

function set(x,y,type,lf=255) {
    if (!ok(x,y)) return;
    const i = gi(x,y);
    grid[i] = type;
    life[i] = type===FIRE ? 50+Math.random()*50
            : type===ACID ? 100+Math.random()*100
            : type===STEAM? 150+Math.random()*80
            : type===CLOUD? 200+Math.random()*100
            : lf;
}

function swap(x1,y1,x2,y2) {
    const i1=gi(x1,y1), i2=gi(x2,y2);
    [grid[i1],grid[i2]]=[grid[i2],grid[i1]];
    [life[i1],life[i2]]=[life[i2],life[i1]];
}

// â”€â”€ Update logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update() {
    if (simPaused) return;
    updated.fill(0);

    // fire events accumulator for audio
    let fireCt=0,waterCt=0,acidCt=0,steamCt=0,lavaCt=0,iceCt=0,plantCt=0;

    for (let y=H-2; y>=0; y--) {
        const ltr = Math.random()>.5;
        for (let xi=0; xi<W; xi++) {
            const x = ltr ? xi : W-1-xi;
            const idx = gi(x,y);
            const t   = grid[idx];
            if (t===EMPTY || updated[idx]) continue;
            updated[idx]=1;

            // â”€â”€ VOID: destroy everything â”€â”€
            if (t===VOID) {
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                nb.forEach(([nx,ny])=>{
                    if(ok(nx,ny)&&grid[gi(nx,ny)]!==VOID&&grid[gi(nx,ny)]!==STONE){
                        grid[gi(nx,ny)]=EMPTY;
                    }
                });
                continue;
            }

            // â”€â”€ CLOUD: drift and spawn water â”€â”€
            if (t===CLOUD) {
                life[idx]--;
                // drift sideways
                const dx = Math.random()>.5?1:-1;
                if(ok(x+dx,y)&&grid[gi(x+dx,y)]===EMPTY){swap(x,y,x+dx,y);}
                // spawn water drop
                if(life[idx]<50&&ok(x,y+1)&&grid[gi(x,y+1)]===EMPTY&&Math.random()<.02){
                    set(x,y+1,WATER);
                    waterCt++;
                }
                if(life[idx]<=0)grid[idx]=EMPTY;
                continue;
            }

            // â”€â”€ FIRE: rise + spread â”€â”€
            if (t===FIRE) {
                life[idx]--;
                if(life[idx]<=0){grid[idx]=EMPTY;continue;}
                fireCt++;
                if(y>0&&grid[gi(x,y-1)]===EMPTY){swap(x,y,x,y-1);updated[gi(x,y-1)]=1;continue;}
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                nb.forEach(([nx,ny])=>{
                    if(!ok(nx,ny))return;
                    const ni=gi(nx,ny), nt=grid[ni];
                    if((nt===PLANT||nt===OIL||nt===GUNPOWDER||nt===WOOD)&&Math.random()>.6){
                        grid[ni]=FIRE; life[ni]=40+Math.random()*60;
                        if(nt===GUNPOWDER&&Math.random()<.3){ /* explosion deferred */ }
                    }
                    if(nt===ICE){grid[ni]=WATER;iceCt++;}
                    if(nt===WATER&&Math.random()<.05){grid[ni]=STEAM;life[ni]=120;steamCt++;}
                });
                continue;
            }

            // â”€â”€ STEAM: rise + condense â”€â”€
            if (t===STEAM) {
                life[idx]--;
                steamCt++;
                if(life[idx]<=0){grid[idx]=WATER;life[idx]=255;continue;}
                if(y>0&&grid[gi(x,y-1)]===EMPTY){swap(x,y,x,y-1);updated[gi(x,y-1)]=1;continue;}
                const dx=Math.random()>.5?1:-1;
                if(ok(x+dx,y)&&grid[gi(x+dx,y)]===EMPTY)swap(x,y,x+dx,y);
                continue;
            }

            // â”€â”€ ACID: dissolve + fall â”€â”€
            if (t===ACID) {
                acidCt++;
                life[idx]--;
                if(life[idx]<=0){grid[idx]=EMPTY;continue;}
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                nb.forEach(([nx,ny])=>{
                    if(!ok(nx,ny))return;
                    const ni=gi(nx,ny),nt=grid[ni];
                    if(nt!==EMPTY&&nt!==ACID&&nt!==STONE&&nt!==GLASS&&nt!==VOID&&Math.random()>.75){
                        grid[ni]=Math.random()>.5?ACID:EMPTY;
                        if(grid[ni]===ACID)life[ni]=80;
                    }
                });
            }

            // â”€â”€ LAVA: flow + ignite â”€â”€
            if (t===LAVA) {
                lavaCt++;
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                nb.forEach(([nx,ny])=>{
                    if(!ok(nx,ny))return;
                    const ni=gi(nx,ny),nt=grid[ni];
                    if(nt===ICE){grid[ni]=WATER;iceCt++;}
                    else if(nt===PLANT||nt===OIL||nt===WOOD){grid[ni]=FIRE;life[ni]=60;}
                    else if(nt===WATER&&Math.random()<.1){grid[ni]=STEAM;life[ni]=120;steamCt++;}
                });
            }

            // â”€â”€ GUNPOWDER: explode near fire â”€â”€
            if (t===GUNPOWDER) {
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                let nearFire=false;
                nb.forEach(([nx,ny])=>{ if(ok(nx,ny)&&grid[gi(nx,ny)]===FIRE)nearFire=true; });
                if(nearFire) {
                    // chain explosion 5Ã—5
                    for(let dy=-3;dy<=3;dy++)for(let dx=-3;dx<=3;dx++){
                        if(ok(x+dx,y+dy)){
                            const ni=gi(x+dx,y+dy);
                            if(grid[ni]!==STONE&&grid[ni]!==GLASS&&grid[ni]!==VOID){
                                grid[ni]=Math.random()<.4?FIRE:EMPTY;
                                if(grid[ni]===FIRE)life[ni]=40+Math.random()*40;
                            }
                        }
                    }
                    // trigger explosion sound (deferred so we don't call audio in hot loop)
                    pendingExplosion=true;
                    continue;
                }
            }

            // â”€â”€ WATER+SALT â”€â”€
            if (t===WATER) {
                waterCt++;
                const below=gi(x,y+1);
                if(ok(x,y+1)&&grid[below]===SALT){swap(x,y,x,y+1);updated[below]=1;continue;}
            }

            // â”€â”€ GRAVITY / FALLING â”€â”€
            if (ok(x,y+1) && DENSITY[t] > DENSITY[grid[gi(x,y+1)]]) {
                swap(x,y,x,y+1);
                updated[gi(x,y+1)]=1;
                continue;
            }

            // â”€â”€ LIQUID SPREAD â”€â”€
            if (t===WATER||t===OIL||t===ACID||t===LAVA) {
                const L=ok(x-1,y)&&DENSITY[t]>DENSITY[grid[gi(x-1,y)]];
                const R=ok(x+1,y)&&DENSITY[t]>DENSITY[grid[gi(x+1,y)]];
                if(L&&R){ if(Math.random()>.5)swap(x,y,x-1,y); else swap(x,y,x+1,y); }
                else if(L)swap(x,y,x-1,y);
                else if(R)swap(x,y,x+1,y);
                continue;
            }

            // â”€â”€ SAND / SALT / GUNPOWDER slope â”€â”€
            if (t===SAND||t===SALT||t===GUNPOWDER) {
                if(ok(x,y+1)&&DENSITY[t]<=DENSITY[grid[gi(x,y+1)]]) {
                    const L=ok(x-1,y+1)&&grid[gi(x-1,y+1)]===EMPTY;
                    const R=ok(x+1,y+1)&&grid[gi(x+1,y+1)]===EMPTY;
                    if(L&&R){ if(Math.random()>.5)swap(x,y,x-1,y+1);else swap(x,y,x+1,y+1); }
                    else if(L)swap(x,y,x-1,y+1);
                    else if(R)swap(x,y,x+1,y+1);
                }
            }

            // â”€â”€ PLANT SPREAD â”€â”€
            if (t===PLANT&&Math.random()<.002) {
                const nb=[[x-1,y],[x+1,y],[x,y-1],[x,y+1]];
                const tgt=nb.filter(([nx,ny])=>ok(nx,ny)&&grid[gi(nx,ny)]===WATER);
                if(tgt.length){
                    const [nx,ny]=tgt[Math.floor(Math.random()*tgt.length)];
                    grid[gi(nx,ny)]=PLANT;
                    plantCt++;
                }
            }
        }
    }

    // â”€â”€ Audio triggers â”€â”€
    const dt = 1/60;
    audio.tick(dt);
    if(fireCt>5)   audio.fire(Math.min(fireCt/20,1));
    if(waterCt>10) audio.water(Math.min(waterCt/50,1));
    if(acidCt>3)   audio.acid();
    if(steamCt>5)  audio.steam();
    if(lavaCt>3)   audio.lava();
    if(iceCt>0)    audio.iceMelt();
    if(plantCt>0)  audio.plantGrow();
    if(pendingExplosion) { audio.explosion(); pendingExplosion=false; }
}
let pendingExplosion=false;

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
    const imgd = offCtx.createImageData(W,H);
    const d = imgd.data;
    const t = performance.now()*0.001;

    for (let i=0;i<W*H;i++) {
        const type = grid[i];
        let [r,g,b] = BASE[type]||[0,0,0];
        const v = type===EMPTY?0:(Math.random()-.5)*14;
        // animated fire flicker
        if (type===FIRE) {
            r+=Math.random()*30; g+=Math.random()*20-10; b-=20;
        }
        // lava pulse
        if (type===LAVA) { const p=Math.sin(t*3+(i*.01))*.15+1; r=Math.min(255,r*p); }
        // ice sparkle
        if (type===ICE&&Math.random()<.003) { r=230;g=245;b=255; }
        // steam fade
        if (type===STEAM) { const a=life[i]/200; r=Math.round(r*a+10*(1-a)); g=Math.round(g*a+10*(1-a)); b=Math.round(b*a+10*(1-a)); }
        const idx=i*4;
        d[idx]  =Math.max(0,Math.min(255,r+v));
        d[idx+1]=Math.max(0,Math.min(255,g+v));
        d[idx+2]=Math.max(0,Math.min(255,b+v));
        d[idx+3]=255;
    }
    offCtx.putImageData(imgd,0,0);
    ctx.imageSmoothingEnabled=false;
    ctx.drawImage(offCanvas,0,0,W*SCALE,H*SCALE);
}

// â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentElement = SAND;
let brushSize = 3;
let isDrawing = false;
let simPaused = false;

const audio = new SandAudio();

canvas.addEventListener('mousedown', e=>{ isDrawing=true; audio._init(); drawAt(e); });
canvas.addEventListener('mousemove', e=>{ if(isDrawing)drawAt(e); });
canvas.addEventListener('mouseup',   ()=>isDrawing=false);
canvas.addEventListener('mouseleave',()=>isDrawing=false);
canvas.addEventListener('touchstart',e=>{ e.preventDefault(); isDrawing=true; audio._init(); drawAt(e.touches[0]); },{passive:false});
canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(isDrawing)drawAt(e.touches[0]); },{passive:false});
canvas.addEventListener('touchend',  ()=>isDrawing=false);

function drawAt(e) {
    const rect=canvas.getBoundingClientRect();
    const cx=Math.floor((e.clientX-rect.left)/SCALE);
    const cy=Math.floor((e.clientY-rect.top)/SCALE);
    const r=Math.floor(brushSize/2);
    for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){
        if(dx*dx+dy*dy<=r*r&&Math.random()>.25)set(cx+dx,cy+dy,currentElement);
    }
}

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ELEM_COLORS = {
    [SAND]:'#fbbf24',[WATER]:'#3b82f6',[FIRE]:'#ef4444',[OIL]:'#78350f',
    [STONE]:'#6b7280',[PLANT]:'#22c55e',[ACID]:'#a3e635',[SALT]:'#e5e7eb',
    [STEAM]:'#c8cdd6',[LAVA]:'#f97316',[GUNPOWDER]:'#374151',[ICE]:'#67e8f9',
    [WOOD]:'#92400e',[CLOUD]:'#e2e8f0',[GLASS]:'#bae6fd',[VOID]:'#000'
};
const ELEM_NAMES = Object.fromEntries(
    Object.entries(ELEM_MAP).map(([k,v])=>[v,k.charAt(0).toUpperCase()+k.slice(1)])
);

function selectElement(name) {
    currentElement = ELEM_MAP[name] ?? SAND;
    document.querySelectorAll('.element-btn').forEach(b=>b.classList.toggle('active',b.dataset.element===name));
    document.getElementById('curDot').style.background = ELEM_COLORS[currentElement]||'#888';
    document.getElementById('curName').textContent = ELEM_NAMES[currentElement]||name;
}
selectElement('sand');

document.querySelectorAll('.element-btn').forEach(btn=>{
    btn.addEventListener('click',()=>selectElement(btn.dataset.element));
});
document.querySelectorAll('.size-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.size-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        brushSize=parseInt(btn.dataset.size);
    });
});
document.getElementById('btnClear').addEventListener('click',()=>{
    grid.fill(EMPTY); life.fill(255);
});
document.getElementById('btnPause').addEventListener('click',e=>{
    simPaused=!simPaused;
    e.target.textContent=simPaused?'â–¶ Resume':'â¸ Pause';
    document.getElementById('modeChip').textContent=simPaused?'â¸ Paused':'â–¶ Running';
});
document.getElementById('btnMusic').addEventListener('click',e=>{
    audio._init();
    const on=audio.toggleMusic();
    e.target.textContent=on?'ğŸµ Music âœ“':'ğŸµ Music';
    e.target.classList.toggle('sound-active',on);
});
document.getElementById('btnSFX').addEventListener('click',e=>{
    audio._init();
    const on=audio.toggleSFX();
    e.target.textContent=on?'ğŸ”Š SFX âœ“':'ğŸ”Š SFX';
    document.getElementById('soundChip').textContent=on?'ğŸ”Š SFX On':'ğŸ”‡ SFX Off';
});
document.getElementById('volSlider').addEventListener('input',e=>{
    audio._init();
    audio.setVol(e.target.value/100);
});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keyMap = {
    '1':'sand','2':'water','3':'fire','4':'oil','5':'stone',
    '6':'plant','7':'acid','8':'lava','9':'gunpowder','0':'ice',
    'q':'steam','w':'wood','e':'cloud','r':'glass','t':'void',
};
const sizeOrder = [1,3,6,12,20];

document.addEventListener('keydown',e=>{
    if (e.target.tagName==='INPUT') return;
    const key = e.key.toLowerCase();
    if (keyMap[key]) { selectElement(keyMap[key]); return; }
    if (key===' ') { e.preventDefault(); document.getElementById('btnPause').click(); }
    if (key==='c') document.getElementById('btnClear').click();
    if (key==='m') document.getElementById('btnMusic').click();
    if (key==='s') document.getElementById('btnSFX').click();
    if (key===']') {
        const idx=sizeOrder.indexOf(brushSize);
        const nb=sizeOrder[Math.min(idx+1,sizeOrder.length-1)];
        document.querySelector(`.size-btn[data-size="${nb}"]`)?.click();
    }
    if (key==='[') {
        const idx=sizeOrder.indexOf(brushSize);
        const nb=sizeOrder[Math.max(idx-1,0)];
        document.querySelector(`.size-btn[data-size="${nb}"]`)?.click();
    }
});

// â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTime=performance.now(), frames=0, fpsAcc=0;
function loop(now) {
    const dt = Math.min(now-lastTime, 50);
    lastTime=now;
    update();
    draw();
    frames++;
    fpsAcc+=dt;
    if (fpsAcc>=1000) {
        document.getElementById('fps').textContent=frames;
        let cnt=0; for(let i=0;i<grid.length;i++) if(grid[i]!==EMPTY)cnt++;
        document.getElementById('pcount').textContent=cnt.toLocaleString();
        frames=0; fpsAcc=0;
    }
    requestAnimationFrame(loop);
}

resize();
window.addEventListener('resize', resize);
requestAnimationFrame(loop);
</script>
</body>
</html>
